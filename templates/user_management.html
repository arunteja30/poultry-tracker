{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
  <h2 class="mobile-header text-center mb-mobile-3" data-i18n="user_management_title">
    <span data-i18n="user_management_title">User Management</span>
  </h2>

  <!-- Add New User Form -->
  {% if current_user.role == 'super_admin' %}
  <div class="card mb-4">
    <div class="card-header">
      <h5 data-i18n="add_new_user">Add New User</h5>
    </div>
    <div class="card-body">
      <form method="POST" action="{{ url_for('create_user') }}">
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="username" class="form-label" data-i18n="username">Username *</label>
            <input type="text" class="form-control" id="username" name="username" required>
          </div>
          <div class="col-md-6 mb-3">
            <label for="password" class="form-label" data-i18n="password">Password *</label>
            <div class="input-group">
              <input type="password" class="form-control" id="password" name="password" required>
              <button class="btn btn-outline-secondary" type="button" id="togglePassword" tabindex="-1">
                <span id="togglePasswordIcon" class="bi bi-eye"></span>
              </button>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="role" class="form-label" data-i18n="role">Role *</label>
            <select class="form-control" id="role" name="role" required>
              <option value="">Select Role</option>
              <option value="user">User</option>
              <option value="admin">Admin</option>
              <option value="super_admin">Super Admin</option>
            </select>
          </div>
          <div class="col-md-6 mb-3">
            <label for="company_id" class="form-label" data-i18n="company">Company *</label>
            <select class="form-control" id="company_id" name="company_id" required>
              <option value="">Select Company</option>
              {% for company in companies %}
              <option value="{{ company.id }}">{{ company.name }} ({{ company.code }})</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="full_name" class="form-label" data-i18n="full_name">Full Name</label>
            <input type="text" class="form-control" id="full_name" name="full_name">
          </div>
          <div class="col-md-6 mb-3">
            <label for="email" class="form-label" data-i18n="email">Email</label>
            <input type="email" class="form-control" id="email" name="email">
          </div>
        </div>
        <div class="mb-3">
          <label for="phone" class="form-label" data-i18n="phone">Phone</label>
          <input type="text" class="form-control" id="phone" name="phone">
        </div>
        <button type="submit" class="btn btn-primary" data-i18n="add_user">Add User</button>
      </form>
    </div>
  </div>
  {% endif %}

  <!-- Existing Users -->
  <div class="card">
    <div class="card-header">
      <h5 data-i18n="existing_users">Existing Users ({{ users|length }})</h5>
    </div>
    <div class="card-body">
      {% if users %}
      <!-- Mobile User List -->
      <div class="d-block d-md-none">
        {% for user in users %}
        {% if current_user.role == 'super_admin' or user.role != 'super_admin' %}
        <div class="card mb-2 shadow-sm">
          <div class="card-body p-2">
            <div class="d-flex align-items-center justify-content-between mb-1">
              <div>
                <strong class="me-2">{{ user.username }}</strong>
                {% if user.role == 'super_admin' %}
                <span class="badge bg-danger">Super Admin</span>
                {% elif user.role == 'admin' %}
                <span class="badge bg-warning">Admin</span>
                {% else %}
                <span class="badge bg-info">User</span>
                {% endif %}
              </div>
              <button class="btn btn-sm btn-link p-0" type="button" onclick="toggleUserDetails('user-details-{{ user.id }}', this)">
                <i class="bi bi-chevron-down"></i>
              </button>
            </div>
            <div id="user-details-{{ user.id }}" class="collapse">
              <div class="mb-1"><span class="fw-bold">Full Name:</span> {{ user.full_name or '-' }}</div>
              <div class="mb-1"><span class="fw-bold">Company:</span> {% if user.get_company() %}{{ user.get_company().name }} <small class="text-muted">({{ user.get_company().code }})</small>{% else %}<span class="text-muted">No Company</span>{% endif %}</div>
              <div class="mb-1"><span class="fw-bold">Email:</span> {{ user.email or '-' }}</div>
              <div class="mb-1"><span class="fw-bold">Phone:</span> {{ user.phone or '-' }}</div>
              <div class="mb-1"><span class="fw-bold">Status:</span> {% if user.status == 'active' %}<span class="badge bg-success">Active</span>{% else %}<span class="badge bg-secondary">{{ user.status }}</span>{% endif %}</div>
              <div class="mb-1"><span class="fw-bold">Last Login:</span> {% if user.last_login %}{{ user.last_login.strftime('%Y-%m-%d %H:%M') }}{% else %}<span class="text-muted">Never</span>{% endif %}</div>
              <div class="mb-1"><span class="fw-bold">Created:</span> {% if user.created_date %}{{ user.created_date.strftime('%Y-%m-%d %H:%M') }}{% endif %}{% if user.created_by %}{% set created_user = get_user_by_id(user.created_by) %}<br>by {{ created_user.full_name or created_user.username if created_user else 'User ID ' + user.created_by|string }}{% endif %}</div>
              <div class="mt-2">
                {% if user.status == 'active' %}
                <a href="{{ url_for('update_user_status', user_id=user.id, status='inactive') }}" class="btn btn-outline-warning btn-sm me-1" onclick="return confirm('Deactivate this user?')">
                  <i class="bi bi-person-x me-1"></i>Deactivate
                </a>
                {% else %}
                <a href="{{ url_for('update_user_status', user_id=user.id, status='active') }}" class="btn btn-outline-success btn-sm me-1" onclick="return confirm('Activate this user?')">
                  <i class="bi bi-person-check me-1"></i>Activate
                </a>
                {% endif %}
                
                {% if current_user.role in ['super_admin', 'admin'] %}
                <a href="{{ url_for('edit_user', user_id=user.id) }}" class="btn btn-outline-info btn-sm ms-1" data-i18n="edit">
                  <i class="bi bi-pencil-square me-1"></i>Edit
                </a>
                
                {% if current_user.role == 'super_admin' or (current_user.role == 'admin' and user.role != 'super_admin') %}
                <a href="{{ url_for('delete_user', user_id=user.id) }}" class="btn btn-outline-danger btn-sm ms-1" onclick="return confirm('Are you sure you want to delete this user? This action cannot be undone.')" data-i18n="delete">
                  <i class="bi bi-trash me-1"></i>Delete
                </a>
                {% endif %}
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        {% endif %}
        {% endfor %}
      </div>
      <!-- Desktop/Tablet User Table -->
      <div class="table-responsive d-none d-md-block">
        <table class="table table-striped">
          <thead>
          <tr>
            <th data-i18n="username">Username</th>
            <th data-i18n="full_name">Full Name</th>
            <th data-i18n="role">Role</th>
            <th data-i18n="company">Company</th>
            <th data-i18n="email">Email</th>
            <th data-i18n="phone">Phone</th>
            <th data-i18n="status">Status</th>
            <th data-i18n="last_login">Last Login</th>
            <th data-i18n="created_by_date">Created By/Date</th>
            <th data-i18n="actions">Actions</th>
          </tr>
          </thead>
          <tbody>
          {% for user in users %}
          {% if current_user.role == 'super_admin' or user.role != 'super_admin' %}
          <tr>
            <td><strong>{{ user.username }}</strong></td>
            <td>{{ user.full_name or '-' }}</td>
            <td>
              {% if user.role == 'super_admin' %}
              <span class="badge bg-danger">Super Admin</span>
              {% elif user.role == 'admin' %}
              <span class="badge bg-warning">Admin</span>
              {% else %}
              <span class="badge bg-info">User</span>
              {% endif %}
            </td>
            <td>
              {% if user.get_company() %}
              {{ user.get_company().name }}
              <small class="text-muted">({{ user.get_company().code }})</small>
              {% else %}
              <span class="text-muted">No Company</span>
              {% endif %}
            </td>
            <td>{{ user.email or '-' }}</td>
            <td>{{ user.phone or '-' }}</td>
            <td>
              {% if user.status == 'active' %}
              <span class="badge bg-success">Active</span>
              {% else %}
              <span class="badge bg-secondary">{{ user.status }}</span>
              {% endif %}
            </td>
            <td>
              {% if user.last_login %}
              {{ user.last_login.strftime('%Y-%m-%d %H:%M') }}
              {% else %}
              <span class="text-muted">Never</span>
              {% endif %}
            </td>
            <td>
              <small class="text-muted">
                {% if user.created_date %}
                {{ user.created_date.strftime('%Y-%m-%d %H:%M') }}
                {% endif %}
                {% if user.created_by %}
                {% set created_user = get_user_by_id(user.created_by) %}
                <br>by {{ created_user.full_name or created_user.username if created_user else 'User ID ' + user.created_by|string }}
                {% endif %}
              </small>
            </td>
            <td>
              {% if user.status == 'active' %}
              <a href="{{ url_for('update_user_status', user_id=user.id, status='inactive') }}"
                 class="btn btn-outline-warning btn-sm me-1"
                 onclick="return confirm('Deactivate this user?')">
                <i class="bi bi-person-x me-1"></i>Deactivate
              </a>
              <a href="{{ url_for('edit_user', user_id=user.id) }}" 
                 class="btn btn-outline-info btn-sm ms-1" 
                 data-i18n="edit">
                <i class="bi bi-pencil-square me-1"></i>Edit
              </a>
              
              {% if current_user.role == 'super_admin' or (current_user.role == 'admin' and user.role != 'super_admin') %}
              <a href="{{ url_for('delete_user', user_id=user.id) }}" 
                 class="btn btn-outline-danger btn-sm ms-1" 
                 onclick="return confirm('Are you sure you want to delete this user? This action cannot be undone.')"
                 data-i18n="delete">
                <i class="bi bi-trash me-1"></i>Delete
              </a>
              {% endif %}
              {% endif %}
            </td>
          </tr>
          {% endif %}
          {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p class="text-muted">No users found.</p>
      {% endif %}
    </div>
  </div>

  <div class="mt-3">
    <a href="{{ url_for('dashboard') }}" class="btn btn-secondary" data-i18n="back_to_dashboard">Back to Dashboard</a>
    <a href="{{ url_for('company_management') }}" class="btn btn-info mt-2" data-i18n="manage_companies">Manage Companies</a>
  </div>
</div>

<style>
  .badge {
    font-size: 0.9em;
  }
  .table td {
    vertical-align: middle;
  }
</style>

<script>
  function toggleUserDetails(id, btn) {
    const el = document.getElementById(id);
    if (el.classList.contains('show')) {
      el.classList.remove('show');
      btn.querySelector('i').classList.remove('bi-chevron-up');
      btn.querySelector('i').classList.add('bi-chevron-down');
    } else {
      el.classList.add('show');
      btn.querySelector('i').classList.remove('bi-chevron-down');
      btn.querySelector('i').classList.add('bi-chevron-up');
    }
  }

  // Show/Hide Password Toggle
  document.addEventListener('DOMContentLoaded', function() {
    const passwordInput = document.getElementById('password');
    const toggleBtn = document.getElementById('togglePassword');
    const toggleIcon = document.getElementById('togglePasswordIcon');
    if (passwordInput && toggleBtn && toggleIcon) {
      toggleBtn.addEventListener('click', function() {
        if (passwordInput.type === 'password') {
          passwordInput.type = 'text';
          toggleIcon.classList.remove('bi-eye');
          toggleIcon.classList.add('bi-eye-slash');
        } else {
          passwordInput.type = 'password';
          toggleIcon.classList.remove('bi-eye-slash');
          toggleIcon.classList.add('bi-eye');
        }
      });
    }
  });

  // Toggle password visibility in user table
  function togglePasswordVisibility(userId) {
    const passwordField = document.getElementById('password-' + userId);
    const passwordIcon = document.getElementById('password-icon-' + userId);
    
    if (passwordField.textContent === '••••••••') {
      // Show warning instead of actual password for security
      passwordField.textContent = '[Hidden for security]';
      passwordIcon.classList.remove('bi-eye');
      passwordIcon.classList.add('bi-eye-slash');
    } else {
      // Hide password
      passwordField.textContent = '••••••••';
      passwordIcon.classList.remove('bi-eye-slash');
      passwordIcon.classList.add('bi-eye');
    }
  }

  // Toggle password visibility in mobile view
  function toggleMobilePasswordVisibility(userId) {
    const passwordField = document.getElementById('mobile-password-' + userId);
    const passwordIcon = document.getElementById('mobile-password-icon-' + userId);
    
    if (passwordField.textContent === '••••••••') {
      // Show warning instead of actual password for security
      passwordField.textContent = '[Hidden for security]';
      passwordIcon.classList.remove('bi-eye');
      passwordIcon.classList.add('bi-eye-slash');
    } else {
      // Hide password
      passwordField.textContent = '••••••••';
      passwordIcon.classList.remove('bi-eye-slash');
      passwordIcon.classList.add('bi-eye');
    }
  }
</script>
{% endblock %}
