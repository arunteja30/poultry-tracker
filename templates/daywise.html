{% extends 'base.html' %}
{% block content %}
<div class="mobile-container">
  <div class="mobile-section">
    <h2 class="mobile-header" data-i18n="daywise_title">
      <i class="bi bi-calendar-week me-2"></i>Daywise Entries
    </h2>

    {% if not cycle %}
    <!-- No Active Cycle -->
    <div class="mobile-card text-center py-5">
      <div class="mb-4">
        <i class="bi bi-calendar-x" style="font-size: 4rem; color: #dee2e6;"></i>
      </div>
      <h4 class="text-muted mb-3" data-i18n="no_cycle">No Active Cycle</h4>
      <p class="text-muted mb-4" data-i18n="setup_instruction">
        Please set up a new cycle to start tracking your poultry farm data.
      </p>
      <a href="{{ url_for('setup') }}" class="mobile-btn-primary" data-i18n="setup_new_cycle">
        <i class="bi bi-plus-circle me-2"></i>Setup New Cycle
      </a>
    </div>
    {% else %}

    <!-- Summary Stats -->
    <div class="mobile-card mb-4">
      <h5 class="mobile-card-title">
        <i class="bi bi-graph-up me-2"></i>Cycle Overview
      </h5>
      <div class="row g-3">
        <div class="col-6 col-md-3">
          <div class="mobile-metric-card text-center">
            <div class="mobile-metric-value text-primary">{{ cycle.start_birds }}</div>
            <div class="mobile-metric-label">Start Birds</div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="mobile-metric-card text-center">
            <div class="mobile-metric-value text-success">{{ cycle.current_birds }}</div>
            <div class="mobile-metric-label">Current Birds</div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="mobile-metric-card text-center">
            <div class="mobile-metric-value text-info">{{ rows|length }}</div>
            <div class="mobile-metric-label">Total Days</div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="mobile-metric-card text-center">
            <div class="mobile-metric-value text-warning">
              {% set rows_list = rows|list %}
              {% set total_mortality = rows_list | map(attribute='total_mortality') | list | last or 0 %}
              {{ "%.1f"|format((total_mortality / cycle.start_birds * 100) if cycle.start_birds > 0 else 0) }}%
            </div>
            <div class="mobile-metric-label">Mortality Rate</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Mobile List View -->
    <div class="d-block d-lg-none">
      {% if rows|length > 0 %}
      <div class="mobile-list-container" style="max-height: 70vh; overflow-y: auto;">
        {% set rows_list = rows|list %}
        {% for r in rows_list|reverse %}
        <div class="mobile-card mb-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">
              <i class="bi bi-calendar-day me-2"></i>Day {{ loop.revindex }} - {{ r.entry_date }}
            </h6>
            <div class="dropdown">
              <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown">
                <i class="bi bi-three-dots-vertical"></i>
              </button>
              <ul class="dropdown-menu">
                <li>
                  <a class="dropdown-item" href="{{ url_for('edit_daily', entry_id=r.id) }}">
                    <i class="bi bi-pencil me-2"></i>Edit Entry
                  </a>
                </li>
              </ul>
            </div>
          </div>
          
          <div class="small text-muted">
            <div class="row g-1">
              <div class="col-6">
                <strong>Mortality:</strong> {{ r.mortality }} ({{ r.mortality_rate }}%)
              </div>
              <div class="col-6">
                <strong>Total Deaths:</strong> {{ r.total_mortality }}
              </div>
              <div class="col-6">
                <strong>Birds Alive:</strong> {{ r.birds_survived }}
              </div>
              <div class="col-6">
                <strong>Feed Used:</strong> {{ r.feed_bags_consumed }} bags
              </div>
              <div class="col-6">
                <strong>Weight:</strong> {{ "{:,.0f}".format(r.avg_weight * 1000) }}g
              </div>
              <div class="col-6">
                <strong>FCR:</strong> {{ r.fcr }}
              </div>
              {% if r.medicines %}
              <div class="col-12">
                <strong>Medicines:</strong> {{ r.medicines }}
              </div>
              {% endif %}
              {% if r.daily_notes %}
              <div class="col-12">
                <strong>Notes:</strong> {{ r.daily_notes }}
              </div>
              {% endif %}
            </div>
          </div>

          {% if session.role == 'admin' %}
          <div class="d-flex gap-2 pt-2 mt-2 border-top">
            <a href="{{ url_for('edit_daily', entry_id=r.id) }}" class="btn btn-sm btn-outline-primary">
              <i class="bi bi-pencil me-1"></i>Edit
            </a>
            <form method="POST" action="{{ url_for('delete_daily', entry_id=r.id) }}" class="d-inline"
                  onsubmit="return confirm('Are you sure you want to delete this entry?')">
              <button type="submit" class="btn btn-sm btn-outline-danger">
                <i class="bi bi-trash me-1"></i>Delete
              </button>
            </form>
          </div>
          {% endif %}
        </div>
        {% endfor %}
      </div>

      {% else %}
      <!-- No Entries State -->
      <div class="mobile-card text-center py-5">
        <div class="mb-4">
          <i class="bi bi-calendar-plus" style="font-size: 4rem; color: #dee2e6;"></i>
        </div>
        <h5 class="text-muted mb-3">No Daily Entries Found</h5>
        <p class="text-muted mb-4">Start adding daily data to track your poultry farm progress.</p>
        <a href="{{ url_for('daily') }}" class="mobile-btn-primary">
          <i class="bi bi-plus-circle me-2"></i>Add Daily Entry
        </a>
      </div>
      {% endif %}
    </div>

    <!-- Charts Section -->
    {% if rows|length > 0 %}
    <div class="mobile-card mt-4">
      <h5 class="mobile-card-title">
        <i class="bi bi-graph-up me-2"></i>Performance Charts
      </h5>
      
      <!-- Chart Type Controls -->
      <div class="mobile-form-group">
        <label class="mobile-form-label">Chart Type:</label>
        <div class="btn-group w-100" role="group">
          <input type="radio" class="btn-check" name="chartType" id="lineChart" value="line" checked>
          <label class="btn btn-outline-primary" for="lineChart">
            <i class="bi bi-graph-up me-1"></i>Line
          </label>
          
          <input type="radio" class="btn-check" name="chartType" id="barChart" value="bar">
          <label class="btn btn-outline-primary" for="barChart">
            <i class="bi bi-bar-chart me-1"></i>Bar
          </label>
          
          <input type="radio" class="btn-check" name="chartType" id="tilesView" value="tiles">
          <label class="btn btn-outline-success" for="tilesView">
            <i class="bi bi-grid-3x3-gap me-1"></i>Tiles
          </label>
        </div>
      </div>

      <!-- Charts Container -->
      <div class="row g-3" id="chartsContainer">
        <div class="col-12 col-md-6">
          <div class="mobile-card bg-light">
            <h6 class="text-center mb-3">FCR Trend</h6>
            <div style="height: 250px; position: relative;">
              <canvas id="fcrChart"></canvas>
            </div>
          </div>
        </div>
        <div class="col-12 col-md-6">
          <div class="mobile-card bg-light">
            <h6 class="text-center mb-3">Avg Weight (g)</h6>
            <div style="height: 250px; position: relative;">
              <canvas id="weightChart"></canvas>
            </div>
          </div>
        </div>
        <div class="col-12 col-md-6">
          <div class="mobile-card bg-light">
            <h6 class="text-center mb-3">Feed Consumed</h6>
            <div style="height: 250px; position: relative;">
              <canvas id="feedChart"></canvas>
            </div>
          </div>
        </div>
        <div class="col-12 col-md-6">
          <div class="mobile-card bg-light">
            <h6 class="text-center mb-3">Daily Mortality</h6>
            <div style="height: 250px; position: relative;">
              <canvas id="mortalityChart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Tiles Container (hidden by default) -->
      <div id="tilesContainer" class="d-none"></div>
    </div>
    {% endif %}

    <!-- Desktop Table View -->
    <div class="d-none d-lg-block mt-4">
      <div class="mobile-card">
        <h5 class="mobile-card-title">
          <i class="bi bi-table me-2"></i>Detailed Data Table
        </h5>
        <div class="table-responsive">
          <table class="table table-hover table-sm mb-0">
            <thead class="table-dark">
              <tr>
                <th class="text-center" data-i18n="table_day">Day</th>
                <th class="text-center" data-i18n="table_date">Date</th>
                <th class="text-center" data-i18n="table_mortality">Mortality</th>
                <th class="text-center" data-i18n="table_total_mortality">Total Mortality</th>
                <th class="text-center" data-i18n="table_mortality_rate">Mortality Rate (%)</th>
                <th class="text-center" data-i18n="birds_survived">Birds Survived</th>
                <th class="text-center" data-i18n="table_feed_consumed">Feed Consumed</th>
                <th class="text-center" data-i18n="total_bags_consumed">Total Consumed</th>
                <th class="text-center" data-i18n="table_feed_added">Feed Added</th>
                <th class="text-center" data-i18n="table_avg_weight">Avg Weight</th>
                <th class="text-center" data-i18n="avg_feed_per_bird">Avg Feed/Bird</th>
                <th class="text-center" data-i18n="table_fcr">FCR</th>
                <th class="text-center" data-i18n="table_remaining_bags">Remaining Bags</th>
                <th class="text-center" data-i18n="table_medicines">Medicines</th>
                <th class="text-center" data-i18n="notes">Notes</th>
                {% if session.role == 'admin' %}
                <th class="text-center">Actions</th>
                {% endif %}
              </tr>
            </thead>
            <tbody>
              {% set rows_list = rows|list %}
              {% for r in rows_list|reverse %}
              <tr>
                <td class="text-center"><strong>{{ loop.revindex }}</strong></td>
                <td class="text-center text-nowrap">{{ r.entry_date }}</td>
                <td class="text-center text-danger"><strong>{{ r.mortality }}</strong></td>
                <td class="text-center text-danger"><strong>{{ r.total_mortality }}</strong></td>
                <td class="text-center text-danger"><strong>{{ r.mortality_rate }}%</strong></td>
                <td class="text-center text-success"><strong>{{ r.birds_survived }}</strong></td>
                <td class="text-center text-info"><strong>{{ r.feed_bags_consumed }}</strong></td>
                <td class="text-center text-primary"><strong>{{ r.total_bags_consumed }}</strong></td>
                <td class="text-center text-success"><strong>{{ r.feed_bags_added }}</strong></td>
                <td class="text-center text-nowrap text-success"><small>{{ "{:,.0f}".format(r.avg_weight * 1000) }}g</small></td>
                <td class="text-center text-nowrap text-primary"><small>{{ "{:,.1f}".format(r.avg_feed_per_bird_g) }}g</small></td>
                <td class="text-center text-success"><strong>{{ r.fcr }}</strong></td>
                <td class="text-center text-info"><strong>{{ r.remaining_bags }}</strong></td>
                <td class="text-center text-truncate" style="max-width: 120px;" title="{{ r.medicines or '-' }}">{{ r.medicines or '-' }}</td>
                <td class="text-center text-truncate" style="max-width: 150px;" title="{{ r.daily_notes or '-' }}">{{ r.daily_notes or '-' }}</td>
                {% if session.role == 'admin' %}
                <td class="text-center">
                  <div class="d-flex flex-column gap-1">
                    <a href="{{ url_for('edit_daily', entry_id=r.id) }}" class="btn btn-sm btn-primary" title="Edit Entry">
                      <i class="bi bi-pencil me-1"></i>Edit
                    </a>
                    <form method="POST" action="{{ url_for('delete_daily', entry_id=r.id) }}" class="mb-0"
                          onsubmit="return confirm('Are you sure you want to delete this entry?')">
                      <button type="submit" class="btn btn-sm btn-danger w-100" title="Delete Entry">
                        <i class="bi bi-trash me-1"></i>Delete
                      </button>
                    </form>
                  </div>
                </td>
                {% endif %}
              </tr>
              {% else %}
              <tr>
                <td colspan="{% if session.role == 'admin' %}16{% else %}15{% endif %}" class="text-center" data-i18n="no_entries">No entries found</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<!-- Enhanced Mobile UX JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Data from backend
  {% set rows_list = rows|list %}
  const days = [{% for r in rows_list|reverse %}{{ loop.revindex }}{% if not loop.last %},{% endif %}{% endfor %}];
  const fcrData = [{% for r in rows_list|reverse %}{{ r.fcr }}{% if not loop.last %},{% endif %}{% endfor %}];
  const weightData = [{% for r in rows_list|reverse %}{{ (r.avg_weight * 1000)|int }}{% if not loop.last %},{% endif %}{% endfor %}];
  const feedData = [{% for r in rows_list|reverse %}{{ r.feed_bags_consumed }}{% if not loop.last %},{% endif %}{% endfor %}];
  const mortalityData = [{% for r in rows_list|reverse %}{{ r.mortality }}{% if not loop.last %},{% endif %}{% endfor %}];

  // Chart instances
  let fcrChart, weightChart, feedChart, mortalityChart;

  // Register the datalabels plugin
  Chart.register(ChartDataLabels);

  // Common chart options with mobile optimization
  const getChartOptions = (yAxisTitle, chartType = 'line') => ({
    responsive: true,
    maintainAspectRatio: false,
    plugins: { 
      legend: { 
        display: false,
        labels: {
          usePointStyle: true,
          padding: 10,
          font: {
            size: window.innerWidth < 768 ? 10 : 12
          }
        }
      },
      datalabels: {
        display: window.innerWidth >= 768, // Hide labels on mobile for cleaner look
        anchor: 'end',
        align: 'top',
        formatter: (value) => value,
        font: {
          size: window.innerWidth < 768 ? 8 : 10,
          weight: 'bold'
        },
        color: '#333'
      }
    },
    scales: { 
      x: { 
        title: { 
          display: true, 
          text: 'Day',
          font: {
            size: window.innerWidth < 768 ? 10 : 12
          }
        },
        ticks: {
          font: {
            size: window.innerWidth < 768 ? 9 : 11
          }
        }
      }, 
      y: { 
        title: { 
          display: true, 
          text: yAxisTitle,
          font: {
            size: window.innerWidth < 768 ? 10 : 12
          }
        },
        ticks: {
          font: {
            size: window.innerWidth < 768 ? 9 : 11
          }
        }
      } 
    },
    elements: {
      point: {
        radius: chartType === 'line' ? (window.innerWidth < 768 ? 3 : 4) : 0
      }
    },
    layout: {
      padding: {
        top: 10,
        bottom: 10,
        left: 5,
        right: 5
      }
    }
  });

  // Chart creation function with mobile optimizations
  function createCharts(chartType = 'line') {
    const chartsContainer = document.getElementById('chartsContainer');
    const tilesContainer = document.getElementById('tilesContainer');
    
    if (chartType === 'tiles') {
      chartsContainer.classList.add('d-none');
      showTilesView();
      return;
    } else {
      chartsContainer.classList.remove('d-none');
      hideTilesView();
    }

    // Destroy existing charts
    if (fcrChart) fcrChart.destroy();
    if (weightChart) weightChart.destroy();
    if (feedChart) feedChart.destroy();
    if (mortalityChart) mortalityChart.destroy();

    // FCR Chart
    fcrChart = new Chart(document.getElementById('fcrChart'), {
      type: chartType,
      data: {
        labels: days,
        datasets: [{
          label: 'FCR',
          data: fcrData,
          borderColor: '#0d6efd',
          backgroundColor: chartType === 'line' ? 'rgba(13,110,253,0.1)' : '#0d6efd',
          fill: chartType === 'line',
          tension: 0.3,
          pointRadius: chartType === 'line' ? (window.innerWidth < 768 ? 2 : 4) : 0,
          borderWidth: chartType === 'bar' ? 1 : 2
        }]
      },
      options: getChartOptions('FCR', chartType)
    });

    // Weight Chart
    weightChart = new Chart(document.getElementById('weightChart'), {
      type: chartType,
      data: {
        labels: days,
        datasets: [{
          label: 'Avg Weight (g)',
          data: weightData,
          borderColor: '#198754',
          backgroundColor: chartType === 'line' ? 'rgba(25,135,84,0.1)' : '#198754',
          fill: chartType === 'line',
          tension: 0.3,
          pointRadius: chartType === 'line' ? (window.innerWidth < 768 ? 2 : 4) : 0,
          borderWidth: chartType === 'bar' ? 1 : 2
        }]
      },
      options: getChartOptions('Weight (g)', chartType)
    });

    // Feed Chart
    feedChart = new Chart(document.getElementById('feedChart'), {
      type: chartType,
      data: {
        labels: days,
        datasets: [{
          label: 'Feed Bags',
          data: feedData,
          borderColor: '#ffc107',
          backgroundColor: chartType === 'line' ? 'rgba(255,193,7,0.1)' : '#ffc107',
          fill: chartType === 'line',
          tension: 0.3,
          pointRadius: chartType === 'line' ? (window.innerWidth < 768 ? 2 : 4) : 0,
          borderWidth: chartType === 'bar' ? 1 : 2
        }]
      },
      options: getChartOptions('Bags', chartType)
    });

    // Mortality Chart
    mortalityChart = new Chart(document.getElementById('mortalityChart'), {
      type: chartType,
      data: {
        labels: days,
        datasets: [{
          label: 'Mortality',
          data: mortalityData,
          borderColor: '#dc3545',
          backgroundColor: chartType === 'line' ? 'rgba(220,53,69,0.1)' : '#dc3545',
          fill: chartType === 'line',
          tension: 0.3,
          pointRadius: chartType === 'line' ? (window.innerWidth < 768 ? 2 : 4) : 0,
          borderWidth: chartType === 'bar' ? 1 : 2
        }]
      },
      options: getChartOptions('Count', chartType)
    });
  }

  // Tiles view functions with mobile optimization
  function showTilesView() {
    const tilesContainer = document.getElementById('tilesContainer');
    tilesContainer.classList.remove('d-none');
    
    // Calculate averages
    const avgFCR = fcrData.length ? (fcrData.reduce((a, b) => a + b, 0) / fcrData.length).toFixed(2) : '0.00';
    const avgWeight = weightData.length ? (weightData.reduce((a, b) => a + b, 0) / weightData.length).toFixed(0) : '0';
    const avgFeed = feedData.length ? (feedData.reduce((a, b) => a + b, 0) / feedData.length).toFixed(1) : '0.0';
    const avgMortality = mortalityData.length ? (mortalityData.reduce((a, b) => a + b, 0) / mortalityData.length).toFixed(1) : '0.0';
    const totalFeed = feedData.length ? feedData.reduce((a, b) => a + b, 0).toFixed(1) : '0.0';
    const totalMortality = mortalityData.length ? mortalityData.reduce((a, b) => a + b, 0) : 0;
    
    tilesContainer.innerHTML = `
      <div class="row g-3">
        <div class="col-6 col-md-3">
          <div class="mobile-metric-card text-center bg-primary bg-opacity-10">
            <div class="mobile-metric-value text-primary">${avgFCR}</div>
            <div class="mobile-metric-label">Avg FCR</div>
            <small class="text-muted">${fcrData.length} days</small>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="mobile-metric-card text-center bg-success bg-opacity-10">
            <div class="mobile-metric-value text-success">${avgWeight}g</div>
            <div class="mobile-metric-label">Avg Weight</div>
            <small class="text-muted">${weightData.length} days</small>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="mobile-metric-card text-center bg-warning bg-opacity-10">
            <div class="mobile-metric-value text-warning">${avgFeed}</div>
            <div class="mobile-metric-label">Avg Feed</div>
            <small class="text-muted">Total: ${totalFeed}</small>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="mobile-metric-card text-center bg-danger bg-opacity-10">
            <div class="mobile-metric-value text-danger">${avgMortality}</div>
            <div class="mobile-metric-label">Avg Mortality</div>
            <small class="text-muted">Total: ${totalMortality}</small>
          </div>
        </div>
      </div>
    `;
  }

  function hideTilesView() {
    const tilesContainer = document.getElementById('tilesContainer');
    tilesContainer.classList.add('d-none');
  }

  // Initialize charts only if data exists
  if (days.length > 0) {
    createCharts('line');

    // Chart type change handlers
    document.querySelectorAll('input[name="chartType"]').forEach(radio => {
      radio.addEventListener('change', function() {
        createCharts(this.value);
      });
    });
  }

  // Mobile UX enhancements
  if (window.mobileUX) {
    window.mobileUX.init();
  }

  // Responsive chart resizing
  let resizeTimeout;
  window.addEventListener('resize', function() {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(() => {
      const activeChart = document.querySelector('input[name="chartType"]:checked')?.value || 'line';
      if (activeChart !== 'tiles') {
        createCharts(activeChart);
      }
    }, 250);
  });

  // Touch feedback for mobile interactions
  document.querySelectorAll('.mobile-card').forEach(element => {
    element.addEventListener('touchstart', function() {
      this.style.transform = 'scale(0.98)';
    });
    
    element.addEventListener('touchend', function() {
      this.style.transform = 'scale(1)';
    });
  });
});
</script>

{% endif %}
{% endblock %}