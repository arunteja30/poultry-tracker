{% extends 'base.html' %}
{% block content %}
<h2 class="mb-3" data-i18n="daily_title">Daily Input</h2>

{% if not cycle %}
<!-- No Active Cycle -->
<div class="row justify-content-center">
  <div class="col-12 col-md-8 col-lg-6">
    <div class="card text-center p-4 p-md-5 shadow rounded-4">
      <div class="card-body">
        <div class="mb-4" style="font-size: 4rem;">üêî</div>
        <h3 data-i18n="no_cycle">No Active Cycle</h3>
        <p class="text-muted mb-4" data-i18n="setup_instruction">Please set up a new cycle to start tracking your poultry farm data.</p>
        <a href="{{ url_for('setup') }}" class="btn btn-primary btn-lg w-100" data-i18n="setup_new_cycle">Setup New Cycle</a>
      </div>
    </div>
  </div>
</div>
{% else %}

<!-- Current Feed Bags Status -->
<div class="alert alert-info mb-4 rounded-3 shadow-sm">
  <div class="d-flex justify-content-between align-items-center">
    <div>
      <h6 class="mb-2" data-i18n="current_feed_status">üì¶ Current Feed Status:</h6>
      {% set available_bags = feeds|sum(attribute='feed_bags') if feeds is defined else 0 %}
      <strong><span data-i18n="available_bags">Available Bags:</span> {{ bags_available|round|int }}</strong>
      {% if bags_available <= 3 %}
      <span class="badge bg-warning ms-2" data-i18n="warning_low_stock">Low Stock!</span>
      {% elif bags_available <= 1 %}
      <span class="badge bg-danger ms-2" data-i18n="warning_critical_stock">Critical Stock!</span>
      {% endif %}
    </div>
    {% if bags_available <= 3 %}
    <div>
      <a href="{{ url_for('feed_management') }}" class="btn btn-success btn-sm">
        <i class="fas fa-plus"></i> <span data-i18n="add_feed_btn">Add Feed</span>
      </a>
    </div>
    {% endif %}
  </div>
 
</div>

<div class="card p-3 p-md-4 shadow rounded-4 mb-4{% if bags_available == 0 %} opacity-50{% endif %}">
  <form method="POST" class="row g-3"{% if bags_available == 0 %} style="pointer-events: none;"{% endif %}>
    {% if bags_available == 0 %}
    <div class="col-12">
      <div class="alert alert-warning text-center">
        <h5 data-i18n="form_disabled_title">üìã Daily Entry Form Disabled</h5>
        <p class="mb-0" data-i18n="form_disabled_message">Please add feed before entering daily data.</p>
      </div>
    </div>
    {% endif %}
    <div class="col-12 col-md-6">
      <label for="entry-date" class="form-label" data-i18n="entry_date">Date</label>
      <input id="entry-date" type="date" name="entry_date" class="form-control"
             value="{{ error_data.entry_date if error_data else '' }}">
    </div>
    <div class="col-12 col-md-6">
      <label for="mortality" class="form-label" data-i18n="mortality">Mortality</label>
      <input id="mortality" type="number" name="mortality" class="form-control"
             value="{{ error_data.mortality if error_data else 0 }}" min="0">
    </div>
    <div class="col-12 col-md-6">
      <label for="feed-consumed" class="form-label" data-i18n="feed_consumed">Feed Bags Consumed</label>
      <input id="feed-consumed" type="number" step="0.1" name="feed_bags_consumed" class="form-control"
             value="{{ error_data.feed_bags_consumed if error_data else 0 }}" min="0" required
             onchange="validateFeedBags()">
      <small class="text-muted" data-i18n="available_bags_info">Available: {{ bags_available|round|int }} bags</small>
      {% if error_data and (error_data.feed_bags_consumed == 0 or error_data.feed_bags_consumed is none) %}
      <div class="text-danger mt-1" id="feed-bags-error">
        <span data-i18n="error_feed_bags_zero">Feed bags consumed cannot be zero. Please enter a valid value.</span>
      </div>
      {% endif %}
    </div>

    <!-- Feed Bags Added hidden field -->
    <input id="bags-added" type="hidden" name="feed_bags_added" value="{{ error_data.feed_bags_added if error_data else 0 }}">

    <div class="col-12 col-md-6">
      <label for="avg-weight" class="form-label" data-i18n="avg_weight">Avg Weight (grams)</label>
      <input id="avg-weight" type="number" step="1" name="avg_weight_grams" class="form-control"
             value="{{ error_data.avg_weight_grams if error_data else 0 }}" min="0" required>
      <small class="text-muted" data-i18n="auto_weight_convert">Will be converted to kg automatically</small>
      {% if error_data and (error_data.avg_weight_grams == 0 or error_data.avg_weight_grams is none) %}
      <div class="text-danger mt-1" id="avg-weight-error">
        <span data-i18n="error_avg_weight_zero">Average weight gain cannot be zero. Please enter a valid value.</span>
      </div>
      {% endif %}
    </div>

    <div class="col-12">
      <label for="daily-notes" class="form-label" data-i18n="notes">Notes</label>
      <textarea id="daily-notes" name="daily_notes" class="form-control" rows="2" placeholder="Enter notes for today..." data-i18n-placeholder="notes_placeholder">{{ error_data.daily_notes if error_data else '' }}</textarea>
    </div>

    <div class="col-12">
      <label for="medicines" class="form-label" data-i18n="medicines">Medicines Given</label>
      <select id="medicines" name="medicines" class="form-select">
        <option value="" data-i18n="none">None</option>
        {% for m in meds %}
        <option value="{{ m.name }}" {% if error_data and error_data.medicines == m.name %}selected{% endif %}>
          {{ m.name }} ({{ m.qty }} <span data-i18n="available">available</span>)
        </option>
        {% endfor %}
      </select>
    </div>

    <!-- Feed Validation Alert -->
    <div class="col-12">
      <div id="feed-validation-alert" class="alert alert-warning d-none">
        <strong data-i18n="warning_prefix">‚ö†Ô∏è Warning:</strong> <span id="validation-message"></span>
      </div>
    </div>

    <div class="col-12">
      <div class="alert alert-info">
        <small data-i18n="auto_calc_live">Auto calculated live birds and bags remaining shown on dashboard after save.</small>
      </div>
    </div>
    <div class="col-12">
      <button id="submit-btn" class="btn btn-primary btn-lg w-100" type="submit" data-i18n="save_daily">Save Daily Entry</button>
    </div>
  </form>
</div>

<script>

  document.querySelectorAll('input[type="number"]').forEach(function(input) {
    input.addEventListener('focus', function() {
      if (this.value === "0") {
        this.value = "";
      }
    });
    input.addEventListener('blur', function() {
      // If left empty or less than 1, set to zero
      if (this.value === "" || parseFloat(this.value) < 1) {
        this.value = "0";
      }
    });
  });

  // Load i18n messages for JavaScript - you can implement language switching later
  const i18nMessages = {
    en: {
      feed_validation_insufficient: "Insufficient feed bags! You need {shortage} more bags. Available: {available}, trying to consume: {consumed}. Please add more bags.",
      feed_validation_minimum: "Error: Must maintain at least 1 feed bag in inventory! Current available: {available}, trying to consume: {consumed}, bags added: {added}. This would leave only {remaining} bags.",
      feed_validation_low: "Feed bags are running low! Only {remaining} bags will remain after this entry.",
      button_cannot_save_bags: "Cannot Save - Add More Bags",
      button_cannot_save_minimum: "Cannot Save - Must Keep 1+ Bags",
      save_daily: "Save Daily Entry"
    },
    hi: {
      feed_validation_insufficient: "‡§Ö‡§™‡§∞‡•ç‡§Ø‡§æ‡§™‡•ç‡§§ ‡§´‡§º‡•Ä‡§° ‡§¨‡•à‡§ó! ‡§Ü‡§™‡§ï‡•ã {shortage} ‡§î‡§∞ ‡§¨‡•à‡§ó ‡§ö‡§æ‡§π‡§ø‡§è‡•§ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß: {available}, ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§®‡•á ‡§ï‡•Ä ‡§ï‡•ã‡§∂‡§ø‡§∂: {consumed}‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§î‡§∞ ‡§¨‡•à‡§ó ‡§ú‡•ã‡§°‡§º‡•á‡§Ç‡•§",
      feed_validation_minimum: "‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ‡§á‡§®‡•ç‡§µ‡•á‡§Ç‡§ü‡§∞‡•Ä ‡§Æ‡•á‡§Ç ‡§ï‡§Æ ‡§∏‡•á ‡§ï‡§Æ 1 ‡§´‡§º‡•Ä‡§° ‡§¨‡•à‡§ó ‡§¨‡§®‡§æ‡§è ‡§∞‡§ñ‡§®‡§æ ‡§ö‡§æ‡§π‡§ø‡§è! ‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§â‡§™‡§≤‡§¨‡•ç‡§ß: {available}, ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§®‡•á ‡§ï‡•Ä ‡§ï‡•ã‡§∂‡§ø‡§∂: {consumed}, ‡§ú‡•ã‡§°‡§º‡•á ‡§ó‡§è ‡§¨‡•à‡§ó: {added}‡•§ ‡§á‡§∏‡§∏‡•á ‡§ï‡•á‡§µ‡§≤ {remaining} ‡§¨‡•à‡§ó ‡§∞‡§π ‡§ú‡§æ‡§è‡§Ç‡§ó‡•á‡•§",
      feed_validation_low: "‡§´‡§º‡•Ä‡§° ‡§¨‡•à‡§ó ‡§ï‡§Æ ‡§π‡•ã ‡§∞‡§π‡•á ‡§π‡•à‡§Ç! ‡§á‡§∏ ‡§™‡•ç‡§∞‡§µ‡§ø‡§∑‡•ç‡§ü‡§ø ‡§ï‡•á ‡§¨‡§æ‡§¶ ‡§ï‡•á‡§µ‡§≤ {remaining} ‡§¨‡•à‡§ó ‡§∞‡§π ‡§ú‡§æ‡§è‡§Ç‡§ó‡•á‡•§",
      button_cannot_save_bags: "‡§∏‡§π‡•á‡§ú ‡§®‡§π‡•Ä‡§Ç ‡§∏‡§ï‡§§‡•á - ‡§î‡§∞ ‡§¨‡•à‡§ó ‡§ú‡•ã‡§°‡§º‡•á‡§Ç",
      button_cannot_save_minimum: "‡§∏‡§π‡•á‡§ú ‡§®‡§π‡•Ä‡§Ç ‡§∏‡§ï‡§§‡•á - 1+ ‡§¨‡•à‡§ó ‡§∞‡§ñ‡§®‡§æ ‡§ö‡§æ‡§π‡§ø‡§è",
      save_daily: "‡§¶‡•à‡§®‡§ø‡§ï ‡§∏‡§π‡•á‡§ú‡•á‡§Ç"
    },
    te: {
      feed_validation_insufficient: "‡∞§‡∞ó‡∞ø‡∞®‡∞Ç‡∞§ ‡∞´‡±Ä‡∞°‡±ç ‡∞¨‡±ç‡∞Ø‡∞æ‡∞ó‡±Å‡∞≤‡±Å ‡∞≤‡±á‡∞µ‡±Å! ‡∞Æ‡±Ä‡∞ï‡±Å {shortage} ‡∞Æ‡∞∞‡∞ø‡∞®‡±ç‡∞®‡∞ø ‡∞¨‡±ç‡∞Ø‡∞æ‡∞ó‡±Å‡∞≤‡±Å ‡∞ï‡∞æ‡∞µ‡∞æ‡∞≤‡∞ø‡•§ ‡∞Ö‡∞Ç‡∞¶‡±Å‡∞¨‡∞æ‡∞ü‡±Å‡∞≤‡±ã: {available}, ‡∞µ‡∞æ‡∞°‡∞ü‡∞æ‡∞®‡∞ø‡∞ï‡∞ø ‡∞™‡±ç‡∞∞‡∞Ø‡∞§‡±ç‡∞®‡∞ø‡∞∏‡±ç‡∞§‡±Å‡∞®‡±ç‡∞®‡∞æ‡∞∞‡±Å: {consumed}. ‡∞¶‡∞Ø‡∞ö‡±á‡∞∏‡∞ø ‡∞Æ‡∞∞‡∞ø‡∞®‡±ç‡∞®‡∞ø ‡∞¨‡±ç‡∞Ø‡∞æ‡∞ó‡±Å‡∞≤‡±Å ‡∞ú‡±ã‡∞°‡∞ø‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø‡•§",
      feed_validation_minimum: "‡∞≤‡±ã‡∞™‡∞Ç: ‡∞á‡∞®‡±ç‡∞µ‡±Ü‡∞Ç‡∞ü‡∞∞‡±Ä‡∞≤‡±ã ‡∞ï‡∞®‡±Ä‡∞∏‡∞Ç 1 ‡∞´‡±Ä‡∞°‡±ç ‡∞¨‡±ç‡∞Ø‡∞æ‡∞ó‡±ç ‡∞â‡∞Ç‡∞ö‡∞æ‡∞≤‡∞ø! ‡∞™‡±ç‡∞∞‡∞∏‡±ç‡∞§‡±Å‡∞§‡∞Ç ‡∞Ö‡∞Ç‡∞¶‡±Å‡∞¨‡∞æ‡∞ü‡±Å‡∞≤‡±ã: {available}, ‡∞µ‡∞æ‡∞°‡∞ü‡∞æ‡∞®‡∞ø‡∞ï‡∞ø ‡∞™‡±ç‡∞∞‡∞Ø‡∞§‡±ç‡∞®‡∞ø‡∞∏‡±ç‡∞§‡±Å‡∞®‡±ç‡∞®‡∞æ‡∞∞‡±Å: {consumed}, ‡∞ú‡±ã‡∞°‡∞ø‡∞Ç‡∞ö‡∞ø‡∞® ‡∞¨‡±ç‡∞Ø‡∞æ‡∞ó‡±Å‡∞≤‡±Å: {added}. ‡∞¶‡±Ä‡∞®‡∞ø ‡∞µ‡∞≤‡∞® ‡∞ï‡±á‡∞µ‡∞≤‡∞Ç {remaining} ‡∞¨‡±ç‡∞Ø‡∞æ‡∞ó‡±Å‡∞≤‡±Å ‡∞Æ‡∞ø‡∞ó‡∞ø‡∞≤‡∞ø‡∞™‡±ã‡∞§‡∞æ‡∞Ø‡∞ø‡•§",
      feed_validation_low: "‡∞´‡±Ä‡∞°‡±ç ‡∞¨‡±ç‡∞Ø‡∞æ‡∞ó‡±Å‡∞≤‡±Å ‡∞§‡∞ï‡±ç‡∞ï‡±Å‡∞µ‡∞ó‡∞æ ‡∞Ö‡∞µ‡±Å‡∞§‡±Å‡∞®‡±ç‡∞®‡∞æ‡∞Ø‡∞ø! ‡∞à ‡∞é‡∞Ç‡∞ü‡±ç‡∞∞‡±Ä ‡∞§‡∞∞‡±ç‡∞µ‡∞æ‡∞§ ‡∞ï‡±á‡∞µ‡∞≤‡∞Ç {remaining} ‡∞¨‡±ç‡∞Ø‡∞æ‡∞ó‡±Å‡∞≤‡±Å ‡∞Æ‡∞ø‡∞ó‡∞ø‡∞≤‡∞ø‡∞™‡±ã‡∞§‡∞æ‡∞Ø‡∞ø‡•§",
      button_cannot_save_bags: "‡∞∏‡±á‡∞µ‡±ç ‡∞ö‡±á‡∞Ø‡∞≤‡±á‡∞Æ‡±Å - ‡∞Æ‡∞∞‡∞ø‡∞®‡±ç‡∞®‡∞ø ‡∞¨‡±ç‡∞Ø‡∞æ‡∞ó‡±Å‡∞≤‡±Å ‡∞ú‡±ã‡∞°‡∞ø‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø",
      button_cannot_save_minimum: "‡∞∏‡±á‡∞µ‡±ç ‡∞ö‡±á‡∞Ø‡∞≤‡±á‡∞Æ‡±Å - 1+ ‡∞¨‡±ç‡∞Ø‡∞æ‡∞ó‡±Å‡∞≤‡±Å ‡∞â‡∞Ç‡∞ö‡∞æ‡∞≤‡∞ø",
      save_daily: "‡∞∞‡±ã‡∞ú‡±Å‡∞µ‡∞æ‡∞∞‡±Ä ‡∞≤‡±Ü‡∞ï‡±ç‡∞ï‡∞≤‡±Å ‡∞¶‡∞æ‡∞ö‡±Å"
    }
  };

  // Get current language (you can implement language detection/switching)
  const currentLang = localStorage.getItem('language') || 'en';

  function formatMessage(template, params) {
    return template.replace(/\{(\w+)\}/g, (match, key) => params[key] || match);
  }

  function safeFloat(val) {
    return val === "" || val === null || typeof val === "undefined" ? 0 : parseFloat(val);
  }


  function validateFeedBags() {
    const currentBags = {{ bags_available|default(0) | int }};
    const consumed = safeFloat(document.getElementById('feed-consumed').value);
    const added = safeFloat(document.getElementById('bags-added').value);
    const remaining = (currentBags + added) - consumed;

    const alertDiv = document.getElementById('feed-validation-alert');
    const messageSpan = document.getElementById('validation-message');
    const submitBtn = document.getElementById('submit-btn');
    const messages = i18nMessages[currentLang];

    if (remaining < 0) {
      const shortage = Math.abs(remaining);
      const params = {shortage: shortage.toFixed(1), available: currentBags, consumed: consumed};
      messageSpan.textContent = formatMessage(messages.feed_validation_insufficient, params);
      alertDiv.className = 'alert alert-danger';
      alertDiv.classList.remove('d-none');
      submitBtn.disabled = true;
      submitBtn.textContent = messages.button_cannot_save_bags;
    } else if (remaining < 0) {
      const params = {available: currentBags, consumed: consumed, added: added, remaining: remaining.toFixed(1)};
      messageSpan.textContent = formatMessage(messages.feed_validation_minimum, params);
      alertDiv.className = 'alert alert-danger';
      alertDiv.classList.remove('d-none');
      submitBtn.disabled = true;
      submitBtn.textContent = messages.button_cannot_save_minimum;
    } else if (remaining <= 3) {
      const params = {remaining: remaining.toFixed(0)};
      messageSpan.textContent = formatMessage(messages.feed_validation_low, params);
      alertDiv.className = 'alert alert-warning';
      alertDiv.classList.remove('d-none');
      submitBtn.disabled = false;
      submitBtn.textContent = messages.save_daily;
    } else {
      alertDiv.classList.add('d-none');
      submitBtn.disabled = false;
      submitBtn.textContent = messages.save_daily;
    }
  }

  // Set today's date as default
  document.getElementById('entry-date').value = new Date().toISOString().split('T')[0];

  // Validate on page load if there's error data
  var errorDataPresent = "{{ 1 if error_data is defined and error_data != None else 0 }}";
  if (errorDataPresent === "1") {
    setTimeout(validateFeedBags, 100);
  }
  if (errorDataPresent) {
    setTimeout(validateFeedBags, 100);
  }
</script>

{% endif %}
{% endblock %}
