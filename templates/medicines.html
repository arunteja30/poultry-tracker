{% extends 'base.html' %}
{% block content %}
<div class="mobile-container">
  <h2 class="mobile-header text-center mb-mobile-3" data-i18n="meds_title">
    <span data-i18n="meds_title">ðŸ’Š Medicines</span>
  </h2>

  <!-- Debug info - remove this later -->
  <div class="alert alert-info">
    <strong>Debug:</strong> 
    current_user: {{ current_user }}
    {% if current_user %} | Role: {{ current_user.role }}{% endif %}
    | Session: {{ session }}
    {% if session.role %} | Session Role: {{ session.role }}{% endif %}
  </div>

  <div class="mobile-section">
    <div class="mobile-card card">
      <div class="card-header bg-info text-white p-mobile-2">
        <h6 class="mb-0" data-i18n="add_new_medicine">âž• Add Medicine</h6>
      </div>
      <div class="card-body p-mobile-2">
        <form method="POST">
          <div class="row g-2">
            <div class="col-12">
              <label for="med-name" class="form-label mobile-content" data-i18n="medicine_name">Medicine Name</label>
              <input id="med-name" data-i18n-placeholder="med_name_ph" name="name" class="mobile-input form-control" placeholder="Medicine name" required>
            </div>
            <div class="col-6">
              <label for="med-price" class="form-label mobile-content" data-i18n="medicine_price">Price (â‚¹)</label>
              <input id="med-price" data-i18n-placeholder="med_price_ph" name="price" class="mobile-input form-control" placeholder="0.00" type="number" step="0.01">
            </div>
            <div class="col-6">
              <label for="med-qty" class="form-label mobile-content" data-i18n="medicine_qty">Quantity</label>
              <input id="med-qty" data-i18n-placeholder="med_qty_ph" name="qty" class="mobile-input form-control" placeholder="Qty" type="number">
            </div>
            <div class="col-12">
              <label for="med-notes" class="form-label mobile-content" data-i18n="medicine_notes">Notes</label>
              <textarea id="med-notes" name="medicine_ext1" class="mobile-input form-control" rows="2" placeholder="Additional details..."></textarea>
            </div>
          </div>
          <div class="mt-3">
            <button class="mobile-button btn btn-success w-100" type="submit" data-i18n="add_med">ðŸ’Š Add Medicine</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Desktop Table View -->
  <div class="d-none d-md-block">
    <div class="card shadow-sm">
      <div class="card-header bg-primary text-white">
        <h6 class="mb-0" style="color: #fff;" data-i18n="medicines_list">ðŸ“‹ Medicines List</h6>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-striped table-hover mb-0">
            <thead class="table-dark">
              <tr>
                <th scope="col" class="px-3" data-i18n="table_medicine_name">Medicine Name</th>
                <th scope="col" class="text-center" data-i18n="table_medicine_price">Price (â‚¹)</th>
                <th scope="col" class="text-center" data-i18n="table_medicine_qty">Quantity</th>
                <th scope="col" class="text-center" data-i18n="medicine_notes">Notes</th>
                <th scope="col" class="text-center" data-i18n="audit_info">Created By/Date</th>
                <th scope="col" class="text-center" data-i18n="table_actions">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for m in meds %}
                <tr>
                  <td class="px-3 fw-medium">
                    <i class="fas fa-pills text-info me-2"></i>{{ m.name }}
                  </td>
                  <td class="text-center">
                    <span class="badge bg-success">â‚¹{{ "%.2f"|format(m.price|float) }}</span>
                  </td>
                  <td class="text-center">
                    <span class="badge bg-info">{{ m.qty or 1 }}</span>
                  </td>
                  <td class="text-center">
                    {{ m.medicine_ext1 or '-' }}
                  </td>
                  <td class="text-center">
                    <small class="text-muted">
                      {% if m.created_date %}
                        {{ m.created_date|safe_strftime }}
                      {% endif %}
                      {% if m.created_by %}
                        {% set created_user = get_user_by_id(m.created_by) %}
                        <br>by {{ created_user.full_name or created_user.username if created_user else 'User ID ' + m.created_by|string }}
                      {% endif %}
                      {% if m.modified_date %}
                        <br><i class="bi bi-pencil me-1"></i>{{ m.modified_date|safe_strftime }}
                        {% if m.modified_by %}
                          {% set modified_user = get_user_by_id(m.modified_by) %}
                          by {{ modified_user.full_name or modified_user.username if modified_user else 'User ID ' + m.modified_by|string }}
                        {% endif %}
                      {% endif %}
                    </small>
                  </td>
                  {% if current_user and current_user.role in ['admin', 'super_admin'] %}
                  <td class="text-center">
                    <a href="{{ url_for('edit_medicine', medicine_id=m.id) }}" class="btn btn-outline-primary btn-sm me-1" title="Edit Medicine">
                      <i class="bi bi-pencil"></i>
                    </a>
                    <form method="POST" action="{{ url_for('delete_medicine', medicine_id=m.id) }}" style="display: inline;" 
                          onsubmit="return confirm('Are you sure you want to delete this medicine?');">
                      <button type="submit" class="btn btn-outline-danger btn-sm" title="Delete Medicine">
                        <i class="bi bi-trash"></i>
                      </button>
                    </form>
                  </td>
                  {% endif %}
                </tr>
              {% else %}
                <tr>
                  <td colspan="{% if current_user and current_user.role in ['admin', 'super_admin'] %}6{% else %}5{% endif %}" class="text-center py-4 text-muted">
                    <i class="fas fa-pills fa-2x mb-2 text-muted"></i><br>
                    <span data-i18n="no_meds">No medicines added yet</span>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      <div class="card-footer bg-light">
        <div class="row">
          <div class="col-md-6 d-flex align-items-end">
            <small class="text-muted"> <i class="fas fa-info-circle me-1"></i> <span data-i18n="total_medicines">Total Medicines: </span></small>
            <span class="badge bg-primary ms-2">{{ meds|length }}</span>
          </div>
          <div class="col-md-6 d-flex justify-content-end align-items-end">
            <div>
              <small class="text-muted" data-i18n="total_amount">Total Amount</small>
              <span class="badge bg-success fs-6 ms-2">â‚¹{{ "%.2f"|format(total_amount|float) }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<!-- Mobile Card View -->
<div class="d-block d-md-none">
  <h6 class="mb-3 text-primary text-center" data-i18n="medicines_list">ðŸ“‹ Medicines List</h6>
  {% for m in meds %}
    <div class="card mb-3 shadow-sm border-0">
      <div class="card-body p-3">
        <div class="d-flex justify-content-between align-items-start mb-2">
          <div class="flex-grow-1">
            <h6 class="card-title mb-1 text-primary">
              <i class="fas fa-pills me-2"></i>{{ m.name }}
            </h6>
          </div>
          <span class="badge bg-success ms-2">â‚¹{{ "%.2f"|format(m.price|float) }}</span>
        </div>
        <div class="row g-2 mb-3">
          <div class="col-6">
            <small class="text-muted d-block" data-i18n="table_medicine_qty">Quantity:</small>
            <span class="badge bg-info">{{ m.qty or 1 }}</span>
          </div>
          <div class="col-6">
            <small class="text-muted d-block" data-i18n="medicine_notes">Notes:</small>
            <span>{{ m.medicine_ext1 or '-' }}</span>
          </div>
        </div>
        {% if current_user and current_user.role in ['admin', 'super_admin'] %}
        <div class="d-grid gap-1">
          <a href="{{ url_for('edit_medicine', medicine_id=m.id) }}" class="btn btn-outline-primary btn-sm">
            <i class="bi bi-pencil me-1"></i> <span data-i18n="btn_edit">Edit</span>
          </a>
          <form method="POST" action="{{ url_for('delete_medicine', medicine_id=m.id) }}" 
                onsubmit="return confirm('Are you sure you want to delete this medicine?');">
            <button type="submit" class="btn btn-outline-danger btn-sm w-100">
              <i class="bi bi-trash me-1"></i> <span data-i18n="btn_delete">Delete</span>
            </button>
          </form>
        </div>
        {% endif %}
      </div>
    </div>
  {% else %}
    <div class="card mb-3 border-0">
      <div class="card-body text-center py-5 text-muted">
        <i class="fas fa-pills fa-3x mb-3 text-muted"></i>
        <p class="mb-0" data-i18n="no_meds">No medicines added yet</p>
        <small>Add your first medicine using the form above</small>
      </div>
    </div>
  {% endfor %}
  <div class="card border-0 bg-light">
    <div class="card-body p-3 text-center">
      <div class="d-flex justify-content-center align-items-center gap-4">
        <div>
          <small class="text-muted d-block">Total Medicines</small>
          <span class="badge bg-primary">{{ meds|length }}</span>
        </div>
        <div>
          <small class="text-muted d-block" data-i18n="total_amount">Total Amount</small>
          <span class="badge bg-success fs-6">â‚¹{{ "%.2f"|format(total_amount|float) }}</span>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}