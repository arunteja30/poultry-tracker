{% extends "base.html" %}
{% block content %}
<div class="mobile-container">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mobile-header text-center mb-mobile-3" data-i18n="dispatch_history_title">
      📊 <span data-i18n="dispatch_history_title"></span>Dispatch History</span>
    </h2>
    <a href="{{ url_for('bird_dispatch') }}" class="btn btn-outline-secondary btn-sm d-none d-md-inline-block" data-i18n="back_to_dispatch">
      ← <span data-i18n="back_to_dispatch">Back</span>
    </a>
  </div>
  <div class="mb-3 d-md-none">
    <a href="{{ url_for('bird_dispatch') }}" class="btn btn-outline-secondary btn-sm w-100" data-i18n="back_to_dispatch">← <span data-i18n="back_to_dispatch">Back</span></a>
  </div>

  {% if not cycle %}
  <!-- No Active Cycle -->
  <div class="mobile-section">
    <div class="mobile-card card text-center">
      <div class="card-body p-mobile-3">
        <div class="mb-3" style="font-size: 3rem;">🐔</div>
        <h5 class="mobile-header" data-i18n="no_cycle">No Active Cycle</h5>
        <p class="mobile-content text-muted mb-3" data-i18n="setup_instruction">
          Please set up a new cycle to start tracking your poultry farm data.
        </p>
        <a href="{{ url_for('setup') }}" class="mobile-button btn btn-primary w-100" data-i18n="setup_new_cycle">
          Setup New Cycle
        </a>
      </div>
    </div>
  </div>
  {% else %}

  <!-- Current Cycle Info -->
  {% if cycle %}
  <div class="mobile-section">
    <div class="mobile-card card border-info">
      <div class="card-body p-mobile-2">
        <h6 class="mobile-header text-info mb-2" data-i18n="current_cycle_info">🏠 <span data-i18n="current_cycle_info">Current Cycle</span></h6>
        <div class="mobile-content">
          <div class="row g-2">
            <div class="col-6">
              <strong data-i18n="started">Started:</strong> <span data-date="{{ cycle.start_date }}">{{ cycle.start_date }}</span>
            </div>
            <div class="col-6">
              <strong data-i18n="remaining_birds">Remaining Birds:</strong> <span class="badge bg-success">{{ cycle.current_birds }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Summary Statistics -->
  <div class="mobile-section">
    <div class="mobile-card card border-success">
      <div class="card-body p-mobile-2">
        <h6 class="mobile-header text-success mb-3">📈 Dispatch Summary</h6>
        <div class="row g-3 text-center">
          <div class="col-6 col-md-3">
            <div class="p-3 bg-primary bg-opacity-10 rounded">
              <div class="h4 mb-1 text-primary">{{ summary.total_birds_dispatched }}</div>
              <small class="text-muted" data-i18n="total_birds_dispatched">Total Birds</small>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="p-3 bg-success bg-opacity-10 rounded">
              <div class="h4 mb-1 text-success">{{ "%.1f"|format(summary.total_weight_dispatched) }} kg</div>
              <small class="text-muted" data-i18n="total_weight_dispatched">Total Weight</small>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="p-3 bg-warning bg-opacity-10 rounded">
              <div class="h4 mb-1 text-warning">{{ "%.3f"|format(summary.avg_weight_per_bird) }} kg</div>
              <small class="text-muted" data-i18n="avg_weight_per_bird">Avg Weight/Bird</small>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="p-3 bg-info bg-opacity-10 rounded">
              <div class="h4 mb-1 text-info">{{ summary.completed_dispatches }}</div>
              <small class="text-muted" data-i18n="completed_dispatches">Completed</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Dispatch History Table -->
  {% if dispatches %}
  <div class="card p-3 p-md-4 shadow rounded-4 mb-4">
    <h5 class="card-title text-center mb-4" data-i18n="dispatches">📋 All Dispatches</h5>

    <!-- Desktop Table -->
    <div class="table-responsive d-none d-md-block">
      <table class="table table-hover">
        <thead class="table-light">
          <tr>
            <th>#</th>
            <th data-i18n="vehicle">Vehicle</th>
            <th data-i18n="driver">Driver</th>
            <th data-i18n="date">Date</th>
            <th data-i18n="status">Status</th>
            <th data-i18n="birds">Birds</th>
            <th data-i18n="action">Action</th>
          </tr>
        </thead>
        <tbody>
          {% for dispatch in dispatches %}
          <tr>
            <td>{{ loop.index }}</td>
            <td><strong>{{ dispatch.vehicle_no }}</strong></td>
            <td>{{ dispatch.driver_name }}</td>
            <td class="date-cell" data-date="{{ dispatch.dispatch_date }}">{{ dispatch.dispatch_date }}</td>
            <td>
              {% if dispatch.status == 'completed' %}
                <span class="badge bg-success" data-i18n="completed">✅ Completed</span>
              {% else %}
                <span class="badge bg-warning" data-i18n="active">⏳ Active</span>
              {% endif %}
            </td>
            <td>
              {% if dispatch.status == 'completed' %}
                <span class="badge bg-primary">{{ dispatch.total_birds }}</span>
                <small class="d-block text-muted">{{ "%.1f"|format(dispatch.total_weight) }} kg</small>
              {% else %}
                <span class="text-muted">In Progress</span>
              {% endif %}
            </td>
            <td>
              <a href="{{ url_for('weighing_screen', dispatch_id=dispatch.id) }}" 
                 class="btn btn-sm {{ 'btn-outline-info' if dispatch.status == 'completed' else 'btn-primary' }}">
                {{ '👁️ View' if dispatch.status == 'completed' else '⚖️ Weigh' }}
              </a>
              {% if current_user and current_user.role in ['admin', 'super_admin'] %}
                <a href="{{ url_for('edit_dispatch', dispatch_id=dispatch.id) }}" class="btn btn-outline-primary btn-sm ms-1" title="Edit Dispatch">
                  <i class="bi bi-pencil"></i>
                </a>
                <form method="POST" action="{{ url_for('delete_dispatch', dispatch_id=dispatch.id) }}" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this dispatch?');">
                  <button type="submit" class="btn btn-outline-danger btn-sm ms-1" title="Delete Dispatch">
                    <i class="bi bi-trash"></i>
                  </button>
                </form>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
        {% if summary.total_birds_dispatched > 0 %}
        <tfoot class="table-info">
          <tr>
            <th colspan="5" data-i18n="total">TOTAL</th>
            <th><span data-i18n="birds_unit">{{ summary.total_birds_dispatched }} birds</span><br>{{ "%.1f"|format(summary.total_weight_dispatched) }} kg</th>
            <th><span data-i18n="completed_count">{{ summary.completed_dispatches }} Completed</span></th>
          </tr>
        </tfoot>
        {% endif %}
      </table>
    </div>

    <!-- Mobile List View -->
    <div class="d-md-none">
      {% for dispatch in dispatches %}
      <div class="card p-3 mb-3 {{ 'border-success' if dispatch.status == 'completed' else 'border-warning' }}">
        <div class="d-flex justify-content-between align-items-start mb-2">
          <div>
            <h6 class="mb-1">🚚 {{ dispatch.vehicle_no }}</h6>
            <small class="text-muted">{{ dispatch.driver_name }}</small>
          </div>
          <span class="badge {{ 'bg-success' if dispatch.status == 'completed' else 'bg-warning' }}">
            {{ '✅ Done' if dispatch.status == 'completed' else '⏳ Active' }}
          </span>
        </div>
        
        {% if dispatch.status == 'completed' %}
        <div class="row text-center mb-3">
          <div class="col-4">
            <div class="fw-bold text-success">{{ dispatch.total_birds }}</div>
            <small class="text-muted">Birds</small>
          </div>
          <div class="col-4">
            <div class="fw-bold text-primary">{{ "%.1f"|format(dispatch.total_weight) }}</div>
            <small class="text-muted">kg</small>
          </div>
          <div class="col-4">
            <div class="fw-bold date-cell" data-date="{{ dispatch.dispatch_date }}">{{ dispatch.dispatch_date }}</div>
            <small class="text-muted">Date</small>
          </div>
        </div>
        {% else %}
        <div class="mb-3">
          <small class="text-muted">📅 <span class="date-cell" data-date="{{ dispatch.dispatch_date }}">{{ dispatch.dispatch_date }}</span></small>
        </div>
        {% endif %}
        
        <div class="d-grid">
          <a href="{{ url_for('weighing_screen', dispatch_id=dispatch.id) }}" 
             class="btn btn-sm {{ 'btn-outline-info' if dispatch.status == 'completed' else 'btn-primary' }}">
            {{ '👁️ View Details' if dispatch.status == 'completed' else '⚖️ Continue Weighing' }}
          </a>
          {% if current_user and current_user.role in ['admin', 'super_admin'] %}
            <div class="d-flex gap-2 mt-2">
              <a href="{{ url_for('edit_dispatch', dispatch_id=dispatch.id) }}" class="btn btn-outline-primary btn-sm" title="Edit Dispatch">
                <i class="bi bi-pencil"></i> Edit
              </a>
              <form method="POST" action="{{ url_for('delete_dispatch', dispatch_id=dispatch.id) }}" onsubmit="return confirm('Are you sure you want to delete this dispatch?');">
                <button type="submit" class="btn btn-outline-danger btn-sm" title="Delete Dispatch">
                  <i class="bi bi-trash"></i> Delete
                </button>
              </form>
            </div>
          {% endif %}
        </div>
      </div>
      {% endfor %}

      <!-- Mobile Total Summary -->
      {% if summary.total_birds_dispatched > 0 %}
      <div class="card p-3 bg-light border-info">
        <h6 class="text-info mb-2">📊 Grand Total</h6>
        <div class="row text-center">
          <div class="col-4">
            <div class="fw-bold text-success">{{ summary.total_birds_dispatched }}</div>
            <small class="text-muted">Total Birds</small>
          </div>
          <div class="col-4">
            <div class="fw-bold text-primary">{{ "%.1f"|format(summary.total_weight_dispatched) }}</div>
            <small class="text-muted">Total Weight</small>
          </div>
          <div class="col-4">
            <div class="fw-bold text-info">{{ summary.completed_dispatches }}</div>
            <small class="text-muted">Completed</small>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
  {% else %}
  <!-- No Dispatches State -->
  <div class="card p-4 text-center">
    <div class="mb-3">
      <span style="font-size: 3rem;">🚚</span>
    </div>
    <h5 class="text-muted mb-3">No Dispatches Yet</h5>
    <p class="text-muted mb-4">No dispatches have been recorded for the current cycle yet.</p>
    <a href="{{ url_for('bird_dispatch') }}" class="btn btn-primary">
      🚚 Start First Dispatch
    </a>
  </div>
  {% endif %}

    <!-- Export Options -->
  {% if dispatches %}
  <div class="card p-3 shadow rounded-4 mt-4">
    <h6 class="text-center mb-3">📊 Export Options</h6>
    <div class="row g-2">
      <div class="col-6">
        <button onclick="exportAllDispatchesToCSV()" class="btn btn-outline-success btn-sm w-100">
          📄 Export CSV
        </button>
      </div>
      <div class="col-6">
        <button onclick="printDispatchSummary()" class="btn btn-outline-info btn-sm w-100">
          🖨️ Print Summary
        </button>
      </div>
    </div>
  </div>
  {% endif %}

    {% endif %}
  </div>
</div>

<!-- Enhanced Mobile UX JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Initialize mobile UX enhancements
  if (window.mobileUX) {
    window.mobileUX.init();
  }

  // Print function
  function printTable() {
    window.print();
  }
  
  // Touch feedback for interactive elements
  document.querySelectorAll('.mobile-data-card, .mobile-btn-primary, .mobile-btn-outline-info').forEach(element => {
    element.addEventListener('touchstart', function() {
      this.style.transform = 'scale(0.98)';
    });
    
    element.addEventListener('touchend', function() {
      this.style.transform = 'scale(1)';
    });
  });

  // Add swipe gestures for dispatch cards
  const dispatchCards = document.querySelectorAll('.mobile-swipeable');
  dispatchCards.forEach(card => {
    if (window.mobileUX && window.mobileUX.addSwipeGesture) {
      window.mobileUX.addSwipeGesture(card, {
        onSwipeLeft: () => {
          const actionBtn = card.querySelector('a[href*="weighing_screen"]');
          if (actionBtn) {
            window.location.href = actionBtn.href;
          }
        },
        onSwipeRight: () => {
          card.style.transform = 'translateX(0)';
          card.style.transition = 'transform 0.3s ease';
        }
      });
    }
  });
});

// Global print function
function printTable() {
  window.print();
}

// Export functions for individual dispatches
function exportDispatchToCSV(dispatchId, vehicleNo) {
  // Create CSV data for specific dispatch
  const dispatchRow = document.querySelector(`tr[data-dispatch-id="${dispatchId}"]`);
  if (!dispatchRow) {
    // Fallback: find the row by vehicle number
    const rows = document.querySelectorAll('tbody tr');
    for (let row of rows) {
      if (row.cells[1] && row.cells[1].textContent.includes(vehicleNo)) {
        exportRowToCSV(row, vehicleNo);
        return;
      }
    }
    alert('Dispatch data not found');
    return;
  }
  exportRowToCSV(dispatchRow, vehicleNo);
}

function exportRowToCSV(row, vehicleNo) {
  const headers = ['Serial', 'Vehicle No', 'Driver', 'Vendor', 'Date & Time', 'Birds', 'Weight (kg)', 'Avg/Bird (kg)', 'Status'];
  const csvData = [headers.join(',')];
  
  const cells = row.querySelectorAll('td');
  const rowData = [];
  for (let i = 0; i < cells.length - 1; i++) { // Exclude actions column
    let cellText = cells[i].innerText.replace(/"/g, '""').replace(/\n/g, ' ');
    rowData.push('"' + cellText + '"');
  }
  csvData.push(rowData.join(','));
  
  const csvContent = csvData.join('\n');
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  
  if (link.download !== undefined) {
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `dispatch_${vehicleNo}_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }
}

function exportDispatchToPrint(dispatchId, vehicleNo) {
  const dispatchRow = document.querySelector(`tr[data-dispatch-id="${dispatchId}"]`);
  let rowData = {};
  
  if (!dispatchRow) {
    // Fallback: find the row by vehicle number
    const rows = document.querySelectorAll('tbody tr');
    for (let row of rows) {
      if (row.cells[1] && row.cells[1].textContent.includes(vehicleNo)) {
        rowData = extractRowData(row);
        break;
      }
    }
  } else {
    rowData = extractRowData(dispatchRow);
  }
  
  if (!rowData.vehicle) {
    alert('Dispatch data not found');
    return;
  }
  
  const printContent = `
    <html>
    <head>
      <title>Dispatch Details - ${rowData.vehicle}</title>
      <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 20px; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .info-item { padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        .info-label { font-weight: bold; color: #333; }
        .info-value { color: #666; margin-top: 5px; }
        .footer { margin-top: 40px; font-size: 12px; color: #666; text-align: center; }
        .status { padding: 5px 10px; border-radius: 3px; color: white; }
        .status-completed { background-color: #28a745; }
        .status-active { background-color: #ffc107; color: #333; }
      </style>
    </head>
    <body>
      <div class="header">
        <h1>Dispatch Details</h1>
        <h2>${rowData.vehicle}</h2>
      </div>
      
      <div class="info-grid">
        <div class="info-item">
          <div class="info-label">Vehicle Number</div>
          <div class="info-value">${rowData.vehicle}</div>
        </div>
        <div class="info-item">
          <div class="info-label">Driver Name</div>
          <div class="info-value">${rowData.driver}</div>
        </div>
        <div class="info-item">
          <div class="info-label">Vendor</div>
          <div class="info-value">${rowData.vendor}</div>
        </div>
        <div class="info-item">
          <div class="info-label">Dispatch Date & Time</div>
          <div class="info-value">${rowData.datetime}</div>
        </div>
        <div class="info-item">
          <div class="info-label">Number of Birds</div>
          <div class="info-value">${rowData.birds}</div>
        </div>
        <div class="info-item">
          <div class="info-label">Total Weight</div>
          <div class="info-value">${rowData.weight}</div>
        </div>
        <div class="info-item">
          <div class="info-label">Average Weight per Bird</div>
          <div class="info-value">${rowData.avgWeight}</div>
        </div>
        <div class="info-item">
          <div class="info-label">Status</div>
          <div class="info-value">
            <span class="status ${rowData.status.toLowerCase() === 'completed' ? 'status-completed' : 'status-active'}">
              ${rowData.status}
            </span>
          </div>
        </div>
      </div>
      
      <div class="footer">
        <p>Generated on: ${new Date().toLocaleString()}</p>
        <p>Poultry Management System - Dispatch Report</p>
      </div>
    </body>
    </html>
  `;
  
  const printWindow = window.open('', '_blank');
  printWindow.document.write(printContent);
  printWindow.document.close();
  printWindow.print();
}

function extractRowData(row) {
  const cells = row.querySelectorAll('td');
  return {
    vehicle: cells[1] ? cells[1].textContent.trim() : '',
    driver: cells[2] ? cells[2].textContent.trim() : '',
    vendor: cells[3] ? cells[3].textContent.trim() : '',
    datetime: cells[4] ? cells[4].textContent.trim() : '',
    birds: cells[5] ? cells[5].textContent.trim() : '',
    weight: cells[6] ? cells[6].textContent.trim() : '',
    avgWeight: cells[7] ? cells[7].textContent.trim() : '',
    status: cells[8] ? cells[8].textContent.trim() : ''
  };
}
  
  // Touch Feedback
  function addTouchFeedback() {
    const touchElements = document.querySelectorAll('.mobile-btn, .mobile-card, .badge');
    
    touchElements.forEach(element => {
      element.addEventListener('touchstart', function() {
        this.style.transform = 'scale(0.98)';
        this.style.transition = 'transform 0.1s ease';
      });
      
      element.addEventListener('touchend', function() {
        this.style.transform = '';
      });
      
      element.addEventListener('touchcancel', function() {
        this.style.transform = '';
      });
    });
  }
  
  // Enhanced Collapse Management
  function setupCollapseHandlers() {
    const collapseElement = document.getElementById('dispatchHistoryCollapse');
    const toggleButton = document.querySelector('[data-bs-target="#dispatchHistoryCollapse"]');
    
    if (collapseElement && toggleButton) {
      collapseElement.addEventListener('shown.bs.collapse', function() {
        const expandText = toggleButton.querySelector('.expand-text');
        const collapseText = toggleButton.querySelector('.collapse-text');
        if (expandText && collapseText) {
          expandText.classList.remove('d-none');
          collapseText.classList.add('d-none');
        }
        
        // Smooth scroll on mobile
        if (isMobile) {
          toggleButton.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'nearest' 
          });
        }
      });
      
      collapseElement.addEventListener('hidden.bs.collapse', function() {
        const expandText = toggleButton.querySelector('.expand-text');
        const collapseText = toggleButton.querySelector('.collapse-text');
        if (expandText && collapseText) {
          expandText.classList.add('d-none');
          collapseText.classList.remove('d-none');
        }
      });
    }
  }
  
  // Swipe gesture support for dispatch cards
  function initSwipeGestures() {
    if (!isMobile) return;
    
    const cards = document.querySelectorAll('.mobile-card.border-success, .mobile-card.border-warning');
    
    cards.forEach(card => {
      let startX = 0;
      let startY = 0;
      
      card.addEventListener('touchstart', (e) => {
        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
      });
      
      card.addEventListener('touchend', (e) => {
        const endX = e.changedTouches[0].clientX;
        const diffX = startX - endX;
        
        if (Math.abs(diffX) > 50) {
          if (diffX > 0) {
            // Swipe left - animate
            card.style.transform = 'translateX(-10px)';
            setTimeout(() => {
              card.style.transform = '';
            }, 200);
          } else {
            // Swipe right - animate
            card.style.transform = 'translateX(10px)';
            setTimeout(() => {
              card.style.transform = '';
            }, 200);
          }
        }
      });
    });
  }
  
  // Initialize all features
  document.addEventListener('DOMContentLoaded', function() {
    setupCollapseHandlers();
    
    if (isMobile) {
      addTouchFeedback();
      initSwipeGestures();
    }
  });
</script>

<style>
  /* Mobile-First Responsive Design */
  @media print {
    .mobile-btn, .card-header, .mobile-alert-info {
      display: none !important;
    }
    .mobile-card {
      border: none !important;
      box-shadow: none !important;
    }
  }

  /* Mobile optimizations */
  @media (max-width: 576px) {
    .mobile-container {
      padding: 0.75rem;
    }
    
    .mobile-title {
      font-size: 1.3rem !important;
    }
    
    .mobile-metric h4 {
      font-size: 1.1rem !important;
    }
    
    .mobile-metric p {
      font-size: 0.8rem !important;
    }
    
    .fs-6 {
      font-size: 0.9rem !important;
    }
    
    .badge {
      font-size: 0.75rem !important;
      padding: 0.3rem 0.5rem !important;
    }
    
    .mobile-metric {
      padding: 0.5rem;
      border-radius: 0.375rem;
      background: rgba(0,0,0,0.02);
      margin: 0.25rem 0;
    }
  }

  /* Medium screens */
  @media (max-width: 768px) {
    .mobile-card {
      margin-bottom: 1rem !important;
    }
    
    .mobile-summary-card {
      background: linear-gradient(135deg, #17a2b8, #138496);
      color: white;
    }
    
    .mobile-summary-card .text-primary,
    .mobile-summary-card .text-success,
    .mobile-summary-card .text-info {
      color: white !important;
    }
  }

  /* Touch interactions */
  .mobile-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    cursor: pointer;
  }

  .mobile-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }

  .mobile-metric-card:hover {
    transform: scale(1.02);
  }

  .mobile-btn {
    transition: all 0.2s ease;
    min-height: 44px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }

  .mobile-btn:active {
    transform: scale(0.98);
  }

  /* Enhanced spacing */
  .mobile-section {
    margin-bottom: 1.5rem;
  }

  /* Accessibility improvements */
  .mobile-collapse-btn:focus {
    outline: 2px solid #007bff;
    outline-offset: 2px;
  }

  /* Loading states */
  .mobile-btn.loading {
    position: relative;
    color: transparent;
  }

  .mobile-btn.loading::after {
    content: '';
    position: absolute;
    width: 16px;
    height: 16px;
    border: 2px solid transparent;
    border-top: 2px solid currentColor;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Format dispatch dates and times with proper timezone handling
    function formatDispatchDateTime() {
        // Format dates
        const dateElements = document.querySelectorAll('.dispatch-date[data-date]');
        dateElements.forEach(element => {
            const dateStr = element.getAttribute('data-date');
            if (dateStr) {
                try {
                    const date = new Date(dateStr);
                    element.textContent = date.toLocaleDateString();
                } catch (e) {
                    console.log('Date parsing error:', e);
                }
            }
        });

        // Format times to show device timezone instead of +00:00
        const timeElements = document.querySelectorAll('.dispatch-time[data-time]');
        timeElements.forEach(element => {
            const timeStr = element.getAttribute('data-time');
            if (timeStr) {
                try {
                    // Create a date object for today with the time
                    const today = new Date();
                    const [hours, minutes, seconds] = timeStr.split(':');
                    today.setHours(parseInt(hours), parseInt(minutes), parseInt(seconds || 0));
                    
                    // Format time in local timezone
                    element.textContent = today.toLocaleTimeString([], {
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: false
                    });
                } catch (e) {
                    console.log('Time parsing error:', e);
                }
            }
        });
    }

    // Export functions for individual dispatches
    window.exportDispatchToCSV = function(dispatchId, vehicleNo) {
        // Get dispatch data from the table row
        const row = document.querySelector(`tr:has([onclick*="${dispatchId}"])`);
        if (!row) return;

        const cells = row.querySelectorAll('td');
        const csvData = [
            ['Field', 'Value'],
            ['Dispatch ID', dispatchId],
            ['Vehicle Number', vehicleNo],
            ['Driver', cells[2]?.textContent?.trim() || ''],
            ['Vendor', cells[3]?.textContent?.trim() || ''],
            ['Date', cells[4]?.querySelector('.dispatch-date')?.textContent?.trim() || ''],
            ['Time', cells[4]?.querySelector('.dispatch-time')?.textContent?.trim() || ''],
            ['Birds Count', cells[5]?.textContent?.trim() || ''],
            ['Total Weight (kg)', cells[6]?.textContent?.trim() || ''],
            ['Average Weight per Bird (kg)', cells[7]?.textContent?.trim() || ''],
            ['Status', cells[8]?.textContent?.trim() || '']
        ];

        const csvContent = csvData.map(row => 
            row.map(cell => `"${cell}"`).join(',')
        ).join('\n');

        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `dispatch_${vehicleNo}_${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        window.URL.revokeObjectURL(url);
    };

    window.exportDispatchToPrint = function(dispatchId, vehicleNo) {
        // Get dispatch data from the table row
        const row = document.querySelector(`tr:has([onclick*="${dispatchId}"])`);
        if (!row) return;

        const cells = row.querySelectorAll('td');
        const printContent = `
            <html>
            <head>
                <title>Dispatch Details - ${vehicleNo}</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; }
                    .header { text-align: center; margin-bottom: 30px; }
                    .details { margin: 20px 0; }
                    .row { margin: 10px 0; display: flex; }
                    .label { font-weight: bold; width: 200px; }
                    .value { margin-left: 20px; }
                </style>
            </head>
            <body>
                <div class="header">
                    <h1>Dispatch Details</h1>
                    <h2>Vehicle: ${vehicleNo}</h2>
                </div>
                <div class="details">
                    <div class="row">
                        <span class="label">Dispatch ID:</span>
                        <span class="value">${dispatchId}</span>
                    </div>
                    <div class="row">
                        <span class="label">Driver:</span>
                        <span class="value">${cells[2]?.textContent?.trim() || ''}</span>
                    </div>
                    <div class="row">
                        <span class="label">Vendor:</span>
                        <span class="value">${cells[3]?.textContent?.trim() || ''}</span>
                    </div>
                    <div class="row">
                        <span class="label">Date:</span>
                        <span class="value">${cells[4]?.querySelector('.dispatch-date')?.textContent?.trim() || ''}</span>
                    </div>
                    <div class="row">
                        <span class="label">Time:</span>
                        <span class="value">${cells[4]?.querySelector('.dispatch-time')?.textContent?.trim() || ''}</span>
                    </div>
                    <div class="row">
                        <span class="label">Birds Count:</span>
                        <span class="value">${cells[5]?.textContent?.trim() || ''}</span>
                    </div>
                    <div class="row">
                        <span class="label">Total Weight (kg):</span>
                        <span class="value">${cells[6]?.textContent?.trim() || ''}</span>
                    </div>
                    <div class="row">
                        <span class="label">Average Weight per Bird (kg):</span>
                        <span class="value">${cells[7]?.textContent?.trim() || ''}</span>
                    </div>
                    <div class="row">
                        <span class="label">Status:</span>
                        <span class="value">${cells[8]?.textContent?.trim() || ''}</span>
                    </div>
                </div>
                <div style="margin-top: 40px; text-align: center; color: #666;">
                    <p>Generated on ${new Date().toLocaleString()}</p>
                </div>
            </body>
            </html>
        `;

        const printWindow = window.open('', '_blank');
        printWindow.document.write(printContent);
        printWindow.document.close();
        printWindow.print();
    };

    // Initialize datetime formatting
    formatDispatchDateTime();
});
</script>
{% endblock %}
