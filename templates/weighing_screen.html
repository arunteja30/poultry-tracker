{% extends "base.html" %}
{% block content %}
<div class="mobile-container">
  <div class="mobile-section">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="mobile-header" data-i18n="weighing_screen_title">
        <i class="bi bi-speedometer2 me-2"></i>Weighing Screen
      </h2>
      <a href="{{ url_for('bird_dispatch') }}" class="mobile-btn-outline-secondary btn-sm" data-i18n="back_to_dispatch">
        <i class="bi bi-arrow-left me-1"></i>Back
      </a>
    </div>

    <!-- Vehicle Info Card -->
    <div class="mobile-card bg-primary bg-opacity-10 border-primary mb-4">
      <h6 class="mobile-card-title text-primary">
        <i class="bi bi-truck me-2"></i>Dispatch Information
      </h6>
      <div class="mobile-info-list">
        <div class="mobile-info-item">
          <span class="mobile-info-label" data-i18n="vehicle">Vehicle:</span>
          <span class="mobile-info-value">{{ dispatch.vehicle_no }}</span>
        </div>
        <div class="mobile-info-item">
          <span class="mobile-info-label" data-i18n="driver">Driver:</span>
          <span class="mobile-info-value">{{ dispatch.driver_name }}</span>
        </div>
        <div class="mobile-info-item">
          <span class="mobile-info-label" data-i18n="vendor">Vendor:</span>
          <span class="mobile-info-value">{{ dispatch.vendor_name or 'N/A' }}</span>
        </div>
        <div class="mobile-info-item">
          <span class="mobile-info-label" data-i18n="date">Date:</span>
          <span class="mobile-info-value">{{ dispatch.dispatch_date }}</span>
        </div>
      </div>
    </div>

    <!-- Summary Metrics -->
    <div class="mobile-card mb-4">
      <h6 class="mobile-card-title">
        <i class="bi bi-bar-chart me-2"></i>Weighing Summary
      </h6>
      <div class="row g-3">
        <div class="col-6 col-md-3">
          <div class="mobile-metric-card text-center bg-info bg-opacity-10">
            <div class="mobile-metric-value text-info">{{ total_birds }}</div>
            <div class="mobile-metric-label" data-i18n="total_birds">Total Birds</div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="mobile-metric-card text-center bg-success bg-opacity-10">
            <div class="mobile-metric-value text-success">{{ "%.1f"|format(total_weight) }} kg</div>
            <div class="mobile-metric-label" data-i18n="total_weight">Total Weight</div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="mobile-metric-card text-center bg-warning bg-opacity-10">
            <div class="mobile-metric-value text-warning">{{ "%.3f"|format(avg_weight_per_bird) }} kg</div>
            <div class="mobile-metric-label" data-i18n="avg_weight_per_bird">Avg Weight/Bird</div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="mobile-metric-card text-center bg-secondary bg-opacity-10">
            <div class="mobile-metric-value text-secondary">{{ weighing_records|length }}</div>
            <div class="mobile-metric-label" data-i18n="weighing_records">Weighing Records</div>
          </div>
        </div>
      </div>

    <!-- Add New Weighing Record -->
    {% if dispatch.status == 'active' %}
    <div class="mobile-card mb-4">
      <h5 class="mobile-card-title text-primary">
        <i class="bi bi-plus-circle me-2"></i>Add New Weighing Record
      </h5>
      <form method="POST" action="{{ url_for('add_weighing_record', dispatch_id=dispatch.id) }}" class="mobile-form-enhanced">
        <div class="row g-3">
          <div class="col-md-4">
            <div class="mobile-form-group">
              <label for="no_of_birds" class="mobile-form-label">
                <i class="bi bi-hash me-2"></i>Number of Birds *
              </label>
              <input type="number" class="mobile-form-control" id="no_of_birds" name="no_of_birds" 
                     min="1" placeholder="Enter number of birds" required autofocus>
            </div>
          </div>
          <div class="col-md-4">
            <div class="mobile-form-group">
              <label for="weight" class="mobile-form-label">
                <i class="bi bi-speedometer me-2"></i>Total Weight (kg) *
              </label>
              <input type="number" class="mobile-form-control" id="weight" name="weight" 
                     step="0.1" min="0.1" placeholder="Enter total weight in kg" required>
            </div>
          </div>
          <div class="col-md-4 d-flex align-items-end">
            <button type="submit" class="mobile-btn-success w-100">
              <i class="bi bi-plus-circle me-2"></i>Add Record
            </button>
          </div>
        </div>
        <div class="mt-3">
          <small class="text-muted" id="avg_preview">Average weight per bird will be calculated automatically</small>
        </div>
      </form>
    </div>
    {% endif %}

      <!-- Weighing Records Table -->
      {% if weighing_records %}
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="card-title mb-0" data-i18n="weighing_records_table">üìã Weighing Records</h5>
        </div>
        <div class="card-body">
          <!-- Desktop Table -->
          <div class="table-responsive d-none d-md-block">
            <table class="table table-sm table-striped">
              <thead class="table-dark">
                <tr>
                  <th>Serial #</th>
                  <th>Birds</th>
                  <th>Weight (kg)</th>
                  <th>Avg/Bird (kg)</th>
                  <th>Time</th>
                  {% if session.role == 'admin' %}
                  <th>Actions</th>
                  {% endif %}
                </tr>
              </thead>
              <tbody>
                {% for record in weighing_records %}
                <tr>
                  <td><span class="badge bg-primary">{{ record.serial_no }}</span></td>
                  <td>{{ record.no_of_birds }}</td>
                  <td>{{ "%.1f"|format(record.weight) }}</td>
                  <td>{{ "%.3f"|format(record.avg_weight_per_bird) }}</td>
                  <td><small>{{ record.timestamp.split('T')[1] if 'T' in record.timestamp else record.timestamp }}</small></td>
                  {% if session.role == 'admin' %}
                  <td>
                    {% if dispatch.status == 'active' %}
                    <form method="POST" action="{{ url_for('delete_weighing_record', record_id=record.id) }}" 
                          style="display: inline-block;" 
                          onsubmit="return confirm('Are you sure you want to delete this record?')">
                      <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete Record">üóëÔ∏è</button>
                    </form>
                    {% else %}
                    <button class="btn btn-sm btn-outline-secondary" disabled title="Cannot delete - Dispatch completed">üîí</button>
                    {% endif %}
                  </td>
                  {% endif %}
                </tr>
                {% endfor %}
              </tbody>
              <tfoot class="table-info">
                <tr>
                  <th>TOTAL</th>
                  <th style="color: white;">{{ total_birds }}</th>
                  <th style="color: white;">{{ "%.1f"|format(total_weight) }}</th>
                  <th style="color: white;">{{ "%.3f"|format(avg_weight_per_bird) }}</th>
                  <th colspan="{{ '2' if session.role == 'admin' else '1' }}">-</th>
                </tr>
              </tfoot>
            </table>
          </div>

                    <!-- Mobile Cards -->
          <div class="mobile-list-container d-md-none">
            {% for record in weighing_records %}
            <div class="mobile-data-card mb-3">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <h6 class="mobile-card-title mb-0">
                  <span class="badge bg-primary me-2">Serial #{{ record.serial_no }}</span>
                </h6>
                {% if session.role == 'admin' and dispatch.status == 'active' %}
                <form method="POST" action="{{ url_for('delete_weighing_record', record_id=record.id) }}" 
                      style="display: inline-block;" 
                      onsubmit="return confirm('Are you sure you want to delete this record?')">
                  <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete Record">
                    <i class="bi bi-trash"></i>
                  </button>
                </form>
                {% endif %}
              </div>
              
              <div class="row g-2">
                <div class="col-6">
                  <div class="mobile-info-item">
                    <small class="text-muted">
                      <i class="bi bi-pie-chart me-1"></i>Birds
                    </small>
                    <div class="fw-medium">{{ record.no_of_birds }}</div>
                  </div>
                </div>
                <div class="col-6">
                  <div class="mobile-info-item">
                    <small class="text-muted">
                      <i class="bi bi-speedometer me-1"></i>Weight
                    </small>
                    <div class="fw-medium">{{ "%.1f"|format(record.weight) }} kg</div>
                  </div>
                </div>
              </div>
              
              <div class="row g-2 mt-2">
                <div class="col-6">
                  <div class="mobile-info-item">
                    <small class="text-muted">
                      <i class="bi bi-calculator me-1"></i>Avg/Bird
                    </small>
                    <div class="fw-medium">{{ "%.3f"|format(record.avg_weight_per_bird) }} kg</div>
                  </div>
                </div>
                <div class="col-6">
                  <div class="mobile-info-item">
                    <small class="text-muted">
                      <i class="bi bi-clock me-1"></i>Time
                    </small>
                    <div class="fw-medium">{{ record.timestamp.split('T')[1] if 'T' in record.timestamp else record.timestamp }}</div>
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
            
            <!-- Mobile Summary -->
            <div class="mobile-card bg-info bg-opacity-10 border-info">
              <h6 class="mobile-card-title text-info">
                <i class="bi bi-bar-chart me-2"></i>Total Summary
              </h6>
              <div class="row g-3 text-center">
                <div class="col-4">
                  <div class="mobile-metric-card">
                    <div class="mobile-metric-value text-info">{{ total_birds }}</div>
                    <div class="mobile-metric-label">Total Birds</div>
                  </div>
                </div>
                <div class="col-4">
                  <div class="mobile-metric-card">
                    <div class="mobile-metric-value text-success">{{ "%.1f"|format(total_weight) }} kg</div>
                    <div class="mobile-metric-label">Total Weight</div>
                  </div>
                </div>
                <div class="col-4">
                  <div class="mobile-metric-card">
                    <div class="mobile-metric-value text-warning">{{ "%.3f"|format(avg_weight_per_bird) }} kg</div>
                    <div class="mobile-metric-label">Avg/Bird</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    {% else %}
    <!-- No Weighing Records -->
    <div class="mobile-card text-center py-5">
      <div class="mb-4">
        <i class="bi bi-scale" style="font-size: 4rem; color: #dee2e6;"></i>
      </div>
      <h5 class="text-muted mb-3">No Weighing Records Yet</h5>
      <p class="text-muted mb-4">Start adding weighing records using the form above.</p>
    </div>
    {% endif %}

    <!-- Complete Dispatch Button -->
    {% if dispatch.status == 'active' and weighing_records %}
    <div class="mobile-card border-success bg-success bg-opacity-10">
      <div class="text-center">
        <h5 class="text-success mb-3">
          <i class="bi bi-check-circle me-2"></i>Ready to Complete Dispatch
        </h5>
        <p class="text-muted mb-4">
          Once you complete the dispatch, the bird count will be deducted from the current cycle 
          and this dispatch will be marked as completed.
        </p>
        <form method="POST" action="{{ url_for('complete_dispatch', dispatch_id=dispatch.id) }}" 
              onsubmit="return confirm('Are you sure you want to complete this dispatch? This action cannot be undone.')">
          <button type="submit" class="mobile-btn-success mobile-btn-lg">
            <i class="bi bi-check-circle me-2"></i>Complete Dispatch ({{ total_birds }} birds, {{ "%.1f"|format(total_weight) }} kg)
          </button>
        </form>
      </div>
    </div>
    {% elif dispatch.status == 'completed' %}
    <div class="mobile-alert alert alert-success">
      <h5>
        <i class="bi bi-check-circle me-2"></i>Dispatch Completed
      </h5>
      <p class="mb-0">
        This dispatch has been completed. <strong>{{ dispatch.total_birds }} birds</strong> 
        weighing <strong>{{ "%.1f"|format(dispatch.total_weight) }} kg</strong> were sent 
        in vehicle <strong>{{ dispatch.vehicle_no }}</strong>.
      </p>
    </div>
    {% endif %}
    </div>
  </div>
</div>

<script>
  // Auto-calculate average weight per bird preview
  document.getElementById('no_of_birds').addEventListener('input', updatePreview);
  document.getElementById('weight').addEventListener('input', updatePreview);
  
  function updatePreview() {
    const birds = parseFloat(document.getElementById('no_of_birds').value) || 0;
    const weight = parseFloat(document.getElementById('weight').value) || 0;
    const preview = document.getElementById('avg_preview');
    
    if (birds > 0 && weight > 0) {
      const avgWeight = (weight / birds).toFixed(3);
      preview.textContent = `Average weight per bird: ${avgWeight} kg`;
      preview.className = 'text-success';
    } else {
      preview.textContent = 'Average weight per bird will be calculated automatically';
      preview.className = 'text-muted';
    }
  }
  
  // Auto-focus and enter key handling
  document.getElementById('no_of_birds').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      document.getElementById('weight').focus();
    }
  });
  
  document.getElementById('weight').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      document.querySelector('button[type="submit"]').click();
    }
  });
</script>
{% endblock %}
