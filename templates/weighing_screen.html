{% extends "base.html" %}
{% block content %}
<div class="mobile-container">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mobile-header text-center mb-mobile-3" data-i18n="weighing_screen_title">
      ‚öñÔ∏è Weighing Screen
    </h2>
    <a href="{{ url_for('bird_dispatch') }}" class="btn btn-outline-secondary btn-sm d-none d-md-inline-block" data-i18n="back_to_dispatch">
      ‚Üê Back
    </a>
  </div>
  <div class="mb-3 d-md-none">
    <a href="{{ url_for('bird_dispatch') }}" class="btn btn-outline-secondary btn-sm w-100" data-i18n="back_to_dispatch">‚Üê Back</a>
  </div>

  <!-- Vehicle Info Card -->
  <div class="mobile-section">
    <div class="mobile-card card border-primary">
      <div class="card-body p-mobile-2">
        <h6 class="mobile-header text-primary mb-2" data-i18n="dispatch_information">üöõ <span data-i18n="dispatch_information">Dispatch Information</span></h6>
        <div class="mobile-content">
          <div class="row g-2">
            <div class="col-6">
              <strong data-i18n="vehicle">Vehicle:</strong> {{ dispatch.vehicle_no }}
            </div>
            <div class="col-6">
              <strong data-i18n="driver">Driver:</strong> {{ dispatch.driver_name }}
            </div>
            <div class="col-6">
              <strong data-i18n="vendor">Vendor:</strong> {{ dispatch.vendor_name or 'N/A' }}
            </div>
            <div class="col-6">
              <strong data-i18n="date">Date:</strong> <span data-date="{{ dispatch.dispatch_date }}">{{ dispatch.dispatch_date }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Summary Metrics -->
  <div class="mobile-section">
    <div class="mobile-card card border-info">
      <div class="card-body p-mobile-2">
        <h6 class="mobile-header text-info mb-3" data-i18n="weighing_summary">üìä <span data-i18n="weighing_summary">Weighing Summary</span></h6>
        <div class="row g-3 text-center">
          <div class="col-6 col-md-3">
            <div class="p-3 bg-info bg-opacity-10 rounded">
              <div class="h4 mb-1 text-info">{{ total_birds }}</div>
              <small class="text-muted" data-i18n="total_birds"><span data-i18n="total_birds">Total Birds</span></small>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="p-3 bg-success bg-opacity-10 rounded">
              <div class="h4 mb-1 text-success">{{ "%.1f"|format(total_weight) }} kg</div>
              <small class="text-muted" data-i18n="total_weight">Total Weight</small>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="p-3 bg-warning bg-opacity-10 rounded">
              <div class="h4 mb-1 text-warning">{{ "%.3f"|format(avg_weight_per_bird) }} kg</div>
              <small class="text-muted" data-i18n="avg_weight_per_bird">Avg Weight/Bird</small>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="p-3 bg-secondary bg-opacity-10 rounded">
              <div class="h4 mb-1 text-secondary">{{ weighing_records|length }}</div>
              <small class="text-muted" data-i18n="weighing_records">Records</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Add New Weighing Record -->
  {% if dispatch.status == 'active' %}
  <div class="card p-3 p-md-4 shadow rounded-4 mb-4">
    <h5 class="card-title text-center mb-4">‚ûï Add New Weighing Record</h5>
    
    <form method="POST" action="{{ url_for('add_weighing_record', dispatch_id=dispatch.id) }}" class="row g-3" id="weighingForm">
      <div class="col-md-6">
        <label for="no_of_birds" class="form-label">
          Number of Birds *
        </label>
        <input type="number" class="form-control" id="no_of_birds" name="no_of_birds" 
               min="1" placeholder="Enter number of birds" 
               value="{{ weighing_records[-1].no_of_birds if weighing_records else '' }}" required autofocus>
      </div>
      
      <div class="col-md-6">
        <label for="weight" class="form-label">
          Total Weight (kg) *
        </label>
        <input type="number" class="form-control" id="weight" name="weight" 
               step="0.001" min="0.001" max="9999.999" 
               placeholder="Enter total weight in kg" required>
      </div>
      
      <div class="col-12">
        <small class="text-muted" id="avg_preview">Average weight per bird will be calculated automatically</small>
      </div>
      
      <div class="col-12">
        <button type="submit" class="btn btn-success btn-lg w-100">
          ‚ûï Add Record
        </button>
      </div>
      
      <!-- Hidden timestamp field for device time -->
      <input type="hidden" id="device_timestamp" name="device_timestamp" value="">
    </form>
  </div>
  {% endif %}

  <!-- Weighing Records Table -->
  {% if weighing_records %}
  <div class="card p-3 p-md-4 shadow rounded-4 mb-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="card-title mb-0">üìã Weighing Records</h5>
      <div class="btn-group btn-group-sm">
        <button type="button" class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">
          üìä Export
        </button>
        <ul class="dropdown-menu">
          <li><a class="dropdown-item" href="#" onclick="exportToCSV()">üìÑ Export CSV</a></li>
          <li><a class="dropdown-item" href="#" onclick="exportToPrint()">üñ®Ô∏è Print Records</a></li>
          <li><a class="dropdown-item" href="#" onclick="exportToJSON()">üíæ Export JSON</a></li>
        </ul>
      </div>
    </div>
    
    <!-- Desktop Table -->
    <div class="table-responsive d-none d-md-block">
      <table class="table table-hover">
        <thead class="table-light">
          <tr>
            <th>#</th>
            <th>Birds</th>
            <th>Weight (kg)</th>
            <th>Avg/Bird (kg)</th>
            <th>Time</th>
            {% if current_user and current_user.role in ['admin', 'super_admin'] and dispatch.status == 'active' %}
            <th>Actions</th>
            {% endif %}
          </tr>
        </thead>
        <tbody>
          {% for record in weighing_records %}
          <tr>
            <td>{{ record.serial_no }}</td>
            <td><span class="badge bg-primary">{{ record.no_of_birds }}</span></td>
            <td><strong>{{ "%.3f"|format(record.weight) }}</strong></td>
            <td>{{ "%.3f"|format(record.avg_weight_per_bird) }}</td>
            <td><small class="text-muted timestamp-display" data-timestamp="{{ record.timestamp }}">{{ record.timestamp.split('T')[1][:5] if 'T' in record.timestamp else record.timestamp[:5] if ':' in record.timestamp else record.timestamp }}</small></td>
            {% if current_user and current_user.role in ['admin', 'super_admin'] and dispatch.status == 'active' %}
            <td>
              <a href="{{ url_for('edit_weighing_record', record_id=record.id) }}" class="btn btn-sm btn-outline-primary me-1" title="Edit Record">
                <i class="bi bi-pencil"></i>
              </a>
              <form method="POST" action="{{ url_for('delete_weighing_record', record_id=record.id) }}" 
                    style="display: inline-block;" 
                    onsubmit="return confirm('Are you sure you want to delete this record?')">
                <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete Record">
                  <i class="bi bi-trash"></i>
                </button>
              </form>
            </td>
            {% endif %}
          </tr>
          {% endfor %}
        </tbody>
        <tfoot class="table-info">
          <tr>
            <th>Total</th>
            <th><span class="badge bg-success">{{ total_birds }}</span></th>
            <th><strong>{{ "%.1f"|format(total_weight) }}</strong></th>
            <th><strong>{{ "%.3f"|format(avg_weight_per_bird) }}</strong></th>
            <th colspan="{{ '2' if current_user and current_user.role in ['admin', 'super_admin'] and dispatch.status == 'active' else '1' }}">{{ weighing_records|length }} records</th>
          </tr>
        </tfoot>
      </table>
    </div>

    <!-- Mobile List View -->
    <div class="d-md-none">
      {% for record in weighing_records %}
      <div class="card p-3 mb-3 border-left-primary">
        <div class="d-flex justify-content-between align-items-start mb-2">
          <div>
            <h6 class="mb-1">üìä Record #{{ record.serial_no }}</h6>
            <small class="text-muted timestamp-display" data-timestamp="{{ record.timestamp }}">{{ record.timestamp.split('T')[1][:5] if 'T' in record.timestamp else record.timestamp[:5] if ':' in record.timestamp else record.timestamp }}</small>
          </div>
          {% if current_user and current_user.role in ['admin', 'super_admin'] and dispatch.status == 'active' %}
          <div class="d-flex gap-1">
            <a href="{{ url_for('edit_weighing_record', record_id=record.id) }}" class="btn btn-sm btn-outline-primary" title="Edit Record">
              <i class="bi bi-pencil"></i>
            </a>
            <form method="POST" action="{{ url_for('delete_weighing_record', record_id=record.id) }}" 
                  style="display: inline-block;" 
                  onsubmit="return confirm('Are you sure you want to delete this record?')">
              <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete Record">
                <i class="bi bi-trash"></i>
              </button>
            </form>
          </div>
          {% endif %}
        </div>
        
        <div class="row text-center">
          <div class="col-4">
            <div class="fw-bold text-primary">{{ record.no_of_birds }}</div>
            <small class="text-muted">Birds</small>
          </div>
          <div class="col-4">
            <div class="fw-bold text-success">{{ "%.3f"|format(record.weight) }}</div>
            <small class="text-muted">Weight (kg)</small>
          </div>
          <div class="col-4">
            <div class="fw-bold text-warning">{{ "%.3f"|format(record.avg_weight_per_bird) }}</div>
            <small class="text-muted">Avg/Bird (kg)</small>
          </div>
        </div>
      </div>
      {% endfor %}
      
      <!-- Mobile Total Summary -->
      <div class="card p-3 bg-light border-success">
        <h6 class="text-success mb-2">üìã Total Summary</h6>
        <div class="row text-center">
          <div class="col-4">
            <div class="fw-bold text-success">{{ total_birds }}</div>
            <small class="text-muted">Total Birds</small>
          </div>
          <div class="col-4">
            <div class="fw-bold text-primary">{{ "%.1f"|format(total_weight) }}</div>
            <small class="text-muted">Total Weight</small>
          </div>
          <div class="col-4">
            <div class="fw-bold text-info">{{ "%.3f"|format(avg_weight_per_bird) }}</div>
            <small class="text-muted">Avg/Bird</small>
          </div>
        </div>
        <div class="text-center mt-2">
          <small class="text-muted">{{ weighing_records|length }} records total</small>
        </div>
      </div>
    </div>
  </div>
  {% else %}
  <!-- No Weighing Records -->
  <div class="mobile-section">
    <div class="mobile-card card text-center">
      <div class="card-body p-mobile-3">
        <div class="mb-3" style="font-size: 3rem;">‚öñÔ∏è</div>
        <h5 class="mobile-header">No Weighing Records Yet</h5>
        <p class="mobile-content text-muted mb-0">Start adding weighing records using the form above.</p>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Complete Dispatch Button -->
  {% if dispatch.status == 'active' and weighing_records %}
  <div class="card p-3 p-md-4 shadow rounded-4 mb-4 border-success">
    <div class="text-center">
      <h5 class="text-success mb-3">‚úÖ Ready to Complete Dispatch</h5>
      <p class="text-muted mb-4">
        Once you complete the dispatch, the bird count will be deducted from the current cycle 
        and this dispatch will be marked as completed.
      </p>
      <form method="POST" action="{{ url_for('complete_dispatch', dispatch_id=dispatch.id) }}" 
            onsubmit="return confirm('Are you sure you want to complete this dispatch? This action cannot be undone.')">
        <button type="submit" class="btn btn-success btn-lg">
          ‚úÖ Complete Dispatch ({{ total_birds }} birds, {{ "%.1f"|format(total_weight) }} kg)
        </button>
      </form>
    </div>
  </div>
  {% elif dispatch.status == 'completed' %}
  <div class="alert alert-success">
    <h5>‚úÖ Dispatch Completed</h5>
    <p class="mb-0">
      This dispatch has been completed. <strong>{{ dispatch.total_birds }} birds</strong> 
      weighing <strong>{{ "%.1f"|format(dispatch.total_weight) }} kg</strong> were sent 
      in vehicle <strong>{{ dispatch.vehicle_no }}</strong>.
    </p>
  </div>
  {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Set device timestamp when page loads
  updateDeviceTimestamp();
  
  // Format timestamps to show local time
  formatTimestamps();
  
  // Check if form exists (only when dispatch is active)
  const weighingForm = document.getElementById('weighingForm');
  if (weighingForm) {
    // Auto-calculate average weight per bird preview
    document.getElementById('no_of_birds').addEventListener('input', updatePreview);
    document.getElementById('weight').addEventListener('input', updatePreview);
    
    // Focus on weight field if number of birds has a default value
    const birdsInput = document.getElementById('no_of_birds');
    const weightInput = document.getElementById('weight');
    
    if (birdsInput && birdsInput.value && birdsInput.value.trim() !== '') {
      // If birds field has a default value, focus on weight field
      setTimeout(() => {
        weightInput.focus();
      }, 100);
    }
    
    // Form submission handler
    weighingForm.addEventListener('submit', function(e) {
      updateDeviceTimestamp(); // Update timestamp just before submission
      
      // Clear fields after successful submission (will be reset by page reload, but for UX)
      setTimeout(function() {
        clearFormFields();
      }, 100);
    });
    
    // Auto-focus and enter key handling
    birdsInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        weightInput.focus();
      }
    });
    
    weightInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        document.querySelector('button[type="submit"]').click();
      }
    });
    
    // Restrict weight field to 3 decimal places
    weightInput.addEventListener('input', function(e) {
      let value = e.target.value;
      if (value.includes('.')) {
        let parts = value.split('.');
        if (parts[1] && parts[1].length > 3) {
          e.target.value = parts[0] + '.' + parts[1].substring(0, 3);
        }
      }
    });
  }
});

function updateDeviceTimestamp() {
  const now = new Date();
  const timestamp = now.toISOString();
  document.getElementById('device_timestamp').value = timestamp;
}

function formatTimestamps() {
  // Format all timestamp displays to show local time
  const timestampElements = document.querySelectorAll('.timestamp-display[data-timestamp]');
  timestampElements.forEach(element => {
    const timestamp = element.getAttribute('data-timestamp');
    if (timestamp) {
      try {
        // Parse the timestamp - handle both ISO format and time-only format
        let date;
        if (timestamp.includes('T') || timestamp.includes('Z')) {
          // ISO format timestamp
          date = new Date(timestamp);
        } else if (timestamp.includes(':')) {
          // Time-only format, assume today's date
          const today = new Date();
          date = new Date(today.toDateString() + ' ' + timestamp);
        } else {
          // Fallback to original timestamp
          element.textContent = timestamp;
          return;
        }
        
        // Format to local time (HH:MM)
        if (!isNaN(date.getTime())) {
          const localTime = date.toLocaleTimeString([], { 
            hour: '2-digit', 
            minute: '2-digit',
            hour12: false 
          });
          element.textContent = localTime;
        } else {
          // If parsing fails, show original timestamp
          element.textContent = timestamp.split('T')[1]?.substring(0, 5) || timestamp;
        }
      } catch (e) {
        // If any error occurs, show original timestamp
        console.log('Error formatting timestamp:', e);
        element.textContent = timestamp.split('T')[1]?.substring(0, 5) || timestamp;
      }
    }
  });
}

function updatePreview() {
  const birds = parseFloat(document.getElementById('no_of_birds').value) || 0;
  const weight = parseFloat(document.getElementById('weight').value) || 0;
  const preview = document.getElementById('avg_preview');
  
  if (birds > 0 && weight > 0) {
    const avgWeight = (weight / birds).toFixed(3);
    preview.innerHTML = '<span data-i18n="avg_weight_preview">Average weight per bird:</span> ' + avgWeight + ' kg';
    preview.className = 'text-success';
  } else {
    preview.innerHTML = '<span data-i18n="avg_weight_calculated">Average weight per bird will be calculated automatically</span>';
    preview.className = 'text-muted';
  }
}

function clearFormFields() {
  // Clear weight field but keep number of birds from previous entry
  document.getElementById('weight').value = '';
  // Focus on weight field since birds value is already populated
  document.getElementById('weight').focus();
  updatePreview();
}

// Export functions
function exportToCSV() {
  const table = document.querySelector('.table-responsive table');
  if (!table) return;
  
  let csv = [];
  const rows = table.querySelectorAll('tr');
  
  for (let i = 0; i < rows.length; i++) {
    const row = [];
    const cols = rows[i].querySelectorAll('td, th');
    
    for (let j = 0; j < cols.length - 1; j++) { // Exclude actions column
      let cellText = cols[j].innerText.replace(/"/g, '""');
      row.push('"' + cellText + '"');
    }
    csv.push(row.join(','));
  }
  
  const csvContent = csv.join('\n');
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  
  if (link.download !== undefined) {
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', 'weighing_records_{{ dispatch.vehicle_no }}_{{ dispatch.dispatch_date }}.csv');
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }
}

function exportToPrint() {
  const printContent = `
    <html>
    <head>
      <title>Weighing Records - {{ dispatch.vehicle_no }}</title>
      <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .header { text-align: center; margin-bottom: 30px; }
        .info { margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .footer { margin-top: 30px; font-size: 12px; color: #666; }
      </style>
    </head>
    <body>
      <div class="header">
        <h2>Weighing Records</h2>
        <h3>Vehicle: {{ dispatch.vehicle_no }} - {{ dispatch.dispatch_date }}</h3>
      </div>
      <div class="info">
        <p><strong>Driver:</strong> {{ dispatch.driver_name }}</p>
        <p><strong>Vendor:</strong> {{ dispatch.vendor_name or 'N/A' }}</p>
        <p><strong>Status:</strong> {{ dispatch.status.title() }}</p>
      </div>
      ${document.querySelector('.table-responsive').innerHTML}
      <div class="footer">
        <p>Generated on: ${new Date().toLocaleString()}</p>
        <p>Poultry Management System</p>
      </div>
    </body>
    </html>
  `;
  
  const printWindow = window.open('', '_blank');
  printWindow.document.write(printContent);
  printWindow.document.close();
  printWindow.print();
}

function exportToJSON() {
  const data = {
    dispatch: {
      vehicle_no: '{{ dispatch.vehicle_no }}',
      driver_name: '{{ dispatch.driver_name }}',
      vendor_name: '{{ dispatch.vendor_name or "" }}',
      dispatch_date: '{{ dispatch.dispatch_date }}',
      dispatch_time: '{{ dispatch.dispatch_time }}',
      status: '{{ dispatch.status }}'
    },
    summary: {
      total_birds: {{ total_birds or 0 }},
      total_weight: {{ total_weight or 0 }},
      avg_weight_per_bird: {{ avg_weight_per_bird or 0 }},
      records_count: {{ weighing_records|length or 0 }}
    },
    records: [
      {% if weighing_records %}
      {% for record in weighing_records %}
      {
        serial_no: {{ record.serial_no }},
        no_of_birds: {{ record.no_of_birds }},
        weight: {{ record.weight }},
        avg_weight_per_bird: {{ record.avg_weight_per_bird }},
        timestamp: '{{ record.timestamp }}'
      }{% if not loop.last %},{% endif %}
      {% endfor %}
      {% endif %}
    ],
    exported_at: new Date().toISOString()
  };
  
  const jsonContent = JSON.stringify(data, null, 2);
  const blob = new Blob([jsonContent], { type: 'application/json;charset=utf-8;' });
  const link = document.createElement('a');
  
  if (link.download !== undefined) {
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', 'weighing_data_{{ dispatch.vehicle_no }}_{{ dispatch.dispatch_date }}.json');
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }
}
</script>

<!-- Mobile-friendly CSS -->
<style>
/* Mobile touch enhancements */
@media (max-width: 768px) {
  .card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  
  .card:active {
    transform: scale(0.98);
  }
  
  .btn {
    min-height: 44px;
    touch-action: manipulation;
  }
  
  .border-left-primary {
    border-left: 4px solid #007bff !important;
  }
  
  /* Card hover effects for touch */
  .card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }
  
  /* Better spacing for mobile */
  .card p-3 {
    padding: 1rem !important;
  }
  
  /* Touch feedback */
  .btn:active {
    transform: scale(0.96);
  }
}

/* Accessibility improvements */
.btn:focus {
  outline: 2px solid #007bff;
  outline-offset: 2px;
}

/* Loading state */
.btn.loading {
  position: relative;
  color: transparent;
}

.btn.loading::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 20px;
  height: 20px;
  border: 2px solid transparent;
  border-top: 2px solid currentColor;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: translate(-50%, -50%) rotate(0deg); }
  100% { transform: translate(-50%, -50%) rotate(360deg); }
}
</style>

{% endblock %}
