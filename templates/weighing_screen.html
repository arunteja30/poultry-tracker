{% extends "base.html" %}
{% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 data-i18n="weighing_screen_title">‚öñÔ∏è Weighing Screen</h2>
        <div>
          <a href="{{ url_for('bird_dispatch') }}" class="btn btn-secondary btn-sm" data-i18n="back_to_dispatch">‚Üê Back to Dispatch</a>
        </div>
      </div>

      <!-- Vehicle Info -->
      <div class="alert alert-primary">
        <div class="row">
          <div class="col-md-3"><strong data-i18n="vehicle">Vehicle:</strong> {{ dispatch.vehicle_no }}</div>
          <div class="col-md-3"><strong data-i18n="driver">Driver:</strong> {{ dispatch.driver_name }}</div>
          <div class="col-md-3"><strong data-i18n="vendor">Vendor:</strong> {{ dispatch.vendor_name or ('na'|translate) }}</div>
          <div class="col-md-3"><strong data-i18n="date">Date:</strong> {{ dispatch.dispatch_date }}</div>
        </div>
      </div>

      <!-- Summary Cards -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="card bg-info text-white">
            <div class="card-body text-center">
              <h4 style="color: rgb(12, 0, 250);">{{ total_birds }}</h4>
              <p class="mb-0" style="color: rgb(54, 7, 239);" data-i18n="total_birds">Total Birds</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-success text-white">
            <div class="card-body text-center">
              <h4 style="color: rgb(185, 11, 11);">{{ "%.1f"|format(total_weight) }} kg</h4>
              <p class="mb-0" style="color: rgb(189, 32, 32);" data-i18n="total_weight">Total Weight</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-danger text-dark">
            <div class="card-body text-center">
              <h4 style="color: rgb(2, 23, 2);">{{ "%.3f"|format(avg_weight_per_bird) }} kg</h4>
              <p class="mb-0" style="color: rgb(35, 2, 2);" data-i18n="avg_weight_per_bird">Avg Weight/Bird</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-secondary text-white">
            <div class="card-body text-center">
              <h4 style="color: rgb(219, 8, 22);">{{ weighing_records|length }}</h4>
              <p class="mb-0" style="color: rgb(215, 9, 33);" data-i18n="weighing_records">Weighing Records</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Add New Weighing Record -->
      {% if dispatch.status == 'active' %}
      <div class="card mb-4">
        <div class="card-header bg-primary">
          <h5 class="card-title mb-0" style="color: white;" data-i18n="add_weighing_record">‚ûï Add New Weighing Record</h5>
        </div>
        <div class="card-body">
          <form method="POST" action="{{ url_for('add_weighing_record', dispatch_id=dispatch.id) }}">
            <div class="row">
              <div class="col-md-4">
                <label for="no_of_birds" class="form-label" data-i18n="number_of_birds">Number of Birds *</label>
                <input type="number" class="form-control" id="no_of_birds" name="no_of_birds" 
                       min="1" placeholder="{{ 'number_of_birds_placeholder'|translate }}" required autofocus>
              </div>
              <div class="col-md-4">
                <label for="weight" class="form-label" data-i18n="total_weight_kg">Total Weight (kg) *</label>
                <input type="number" class="form-control" id="weight" name="weight" 
                       step="0.1" min="0.1" placeholder="{{ 'total_weight_placeholder'|translate }}" required>
              </div>
              <div class="col-md-4 d-flex align-items-end">
                <button type="submit" class="btn btn-success w-100">
                  <span data-i18n="add_weighing_record_btn">‚öñÔ∏è Add Weighing Record</span>
                </button>
              </div>
            </div>
            <div class="mt-2">
              <small class="text-muted" id="avg_preview" data-i18n="avg_weight_auto">Average weight per bird will be calculated automatically</small>
            </div>
          </form>
        </div>
      </div>
      {% endif %}

      <!-- Weighing Records Table -->
      {% if weighing_records %}
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="card-title mb-0" data-i18n="weighing_records_table">üìã Weighing Records</h5>
        </div>
        <div class="card-body">
          <!-- Desktop Table -->
          <div class="table-responsive d-none d-md-block">
            <table class="table table-sm table-striped">
              <thead class="table-dark">
                <tr>
                  <th>Serial #</th>
                  <th>Birds</th>
                  <th>Weight (kg)</th>
                  <th>Avg/Bird (kg)</th>
                  <th>Time</th>
                  {% if session.role == 'admin' %}
                  <th>Actions</th>
                  {% endif %}
                </tr>
              </thead>
              <tbody>
                {% for record in weighing_records %}
                <tr>
                  <td><span class="badge bg-primary">{{ record.serial_no }}</span></td>
                  <td>{{ record.no_of_birds }}</td>
                  <td>{{ "%.1f"|format(record.weight) }}</td>
                  <td>{{ "%.3f"|format(record.avg_weight_per_bird) }}</td>
                  <td><small>{{ record.timestamp.split('T')[1] if 'T' in record.timestamp else record.timestamp }}</small></td>
                  {% if session.role == 'admin' %}
                  <td>
                    {% if dispatch.status == 'active' %}
                    <form method="POST" action="{{ url_for('delete_weighing_record', record_id=record.id) }}" 
                          style="display: inline-block;" 
                          onsubmit="return confirm('Are you sure you want to delete this record?')">
                      <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete Record">üóëÔ∏è</button>
                    </form>
                    {% else %}
                    <button class="btn btn-sm btn-outline-secondary" disabled title="Cannot delete - Dispatch completed">üîí</button>
                    {% endif %}
                  </td>
                  {% endif %}
                </tr>
                {% endfor %}
              </tbody>
              <tfoot class="table-info">
                <tr>
                  <th>TOTAL</th>
                  <th style="color: white;">{{ total_birds }}</th>
                  <th style="color: white;">{{ "%.1f"|format(total_weight) }}</th>
                  <th style="color: white;">{{ "%.3f"|format(avg_weight_per_bird) }}</th>
                  <th colspan="{{ '2' if session.role == 'admin' else '1' }}">-</th>
                </tr>
              </tfoot>
            </table>
          </div>

          <!-- Mobile Cards -->
          <div class="d-md-none">
            {% for record in weighing_records %}
            <div class="card mb-3 border-primary">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <h6 class="card-title mb-0">
                    <span class="badge bg-primary">Serial #{{ record.serial_no }}</span>
                  </h6>
                  {% if session.role == 'admin' %}
                  {% if dispatch.status == 'active' %}
                  <form method="POST" action="{{ url_for('delete_weighing_record', record_id=record.id) }}" 
                        style="display: inline-block;" 
                        onsubmit="return confirm('Are you sure you want to delete this record?')">
                    <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete Record">üóëÔ∏è</button>
                  </form>
                  {% else %}
                  <button class="btn btn-sm btn-outline-secondary" disabled title="Cannot delete - Dispatch completed">üîí</button>
                  {% endif %}
                  {% endif %}
                </div>
                <div class="row">
                  <div class="col-6">
                    <small class="text-muted" data-i18n="birds">Birds:</small><br>
                    <strong>{{ record.no_of_birds }}</strong>
                  </div>
                  <div class="col-6">
                    <small class="text-muted" data-i18n="weight">Weight:</small><br>
                    <strong>{{ "%.1f"|format(record.weight) }} kg</strong>
                  </div>
                </div>
                <div class="row mt-2">
                  <div class="col-6">
                    <small class="text-muted" data-i18n="avg_bird">Avg/Bird:</small><br>
                    <strong>{{ "%.3f"|format(record.avg_weight_per_bird) }} kg</strong>
                  </div>
                  <div class="col-6">
                    <small class="text-muted" data-i18n="time">Time:</small><br>
                    <strong>{{ record.timestamp.split('T')[1] if 'T' in record.timestamp else record.timestamp }}</strong>
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
            
            <!-- Mobile Summary Card -->
            <div class="card bg-info text-white">
              <div class="card-body">
                <h6 class="card-title" data-i18n="total_summary">üìä Total Summary</h6>
                <div class="row text-center">
                  <div class="col-4">
                    <strong>{{ total_birds }}</strong><br>
                    <small data-i18n="total_birds">Total Birds</small>
                  </div>
                  <div class="col-4">
                    <strong>{{ "%.1f"|format(total_weight) }} kg</strong><br>
                    <small data-i18n="total_weight">Total Weight</small>
                  </div>
                  <div class="col-4">
                    <strong>{{ "%.3f"|format(avg_weight_per_bird) }} kg</strong><br>
                    <small data-i18n="avg_weight_per_bird">Avg/Bird</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% else %}
      <div class="alert alert-warning">
        <h5>‚öñÔ∏è No weighing records yet</h5>
        <p class="mb-0" data-i18n="no_weighing_records">Start adding weighing records using the form above.</p>
      </div>
      {% endif %}

      <!-- Complete Dispatch Button -->
      {% if dispatch.status == 'active' and weighing_records %}
      <div class="card border-success">
        <div class="card-body text-center">
          <h5 class="text-success" data-i18n="ready_to_complete_dispatch">Ready to Complete Dispatch</h5>
          <p class="text-muted" data-i18n="complete_dispatch_info">
            Once you complete the dispatch, the bird count will be deducted from the current cycle 
            and this dispatch will be marked as completed.
          </p>
          <form method="POST" action="{{ url_for('complete_dispatch', dispatch_id=dispatch.id) }}" 
                onsubmit="return confirm('Are you sure you want to complete this dispatch? This action cannot be undone.')">
            <button type="submit" class="btn btn-success btn-lg">
              <span data-i18n="complete_dispatch_btn">‚úÖ Complete Dispatch ({{ total_birds }} birds, {{ "%.1f"|format(total_weight) }} kg)</span>
            </button>
          </form>
        </div>
      </div>
      {% elif dispatch.status == 'completed' %}
      <div class="alert alert-success">
        <h5 data-i18n="dispatch_completed">‚úÖ Dispatch Completed</h5>
        <p class="mb-0" data-i18n="dispatch_completed_info">
          This dispatch has been completed. <strong>{{ dispatch.total_birds }} birds</strong> 
          weighing <strong>{{ "%.1f"|format(dispatch.total_weight) }} kg</strong> were sent 
          in vehicle <strong>{{ dispatch.vehicle_no }}</strong>.
        </p>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
  // Auto-calculate average weight per bird preview
  document.getElementById('no_of_birds').addEventListener('input', updatePreview);
  document.getElementById('weight').addEventListener('input', updatePreview);
  
  function updatePreview() {
    const birds = parseFloat(document.getElementById('no_of_birds').value) || 0;
    const weight = parseFloat(document.getElementById('weight').value) || 0;
    const preview = document.getElementById('avg_preview');
    
    if (birds > 0 && weight > 0) {
      const avgWeight = (weight / birds).toFixed(3);
      preview.textContent = `Average weight per bird: ${avgWeight} kg`;
      preview.className = 'text-success';
    } else {
      preview.textContent = 'Average weight per bird will be calculated automatically';
      preview.className = 'text-muted';
    }
  }
  
  // Auto-focus and enter key handling
  document.getElementById('no_of_birds').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      document.getElementById('weight').focus();
    }
  });
  
  document.getElementById('weight').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      document.querySelector('button[type="submit"]').click();
    }
  });
</script>
{% endblock %}
