{% extends "base.html" %}
{% block content %}
<div class="mobile-container">
  <h2 class="mobile-header text-center mb-mobile-3" data-i18n="bird_dispatch_title">
    🚛 Bird Dispatch
  </h2>

  {% if not cycle %}
  <!-- No Active Cycle -->
  <div class="mobile-section">
    <div class="mobile-card card text-center">
      <div class="card-body p-mobile-3">
        <div class="mb-3" style="font-size: 3rem;">🐔</div>
        <h5 class="mobile-header" data-i18n="no_cycle">No Active Cycle</h5>
        <p class="mobile-content text-muted mb-3" data-i18n="setup_instruction">
          Please set up a new cycle to start tracking your poultry farm data.
        </p>
        <a href="{{ url_for('setup') }}" class="mobile-button btn btn-primary w-100" data-i18n="setup_new_cycle">
          Setup New Cycle
        </a>
      </div>
    </div>
  </div>
  {% else %}

  <!-- Current Cycle Status Card -->
  <div class="mobile-section">
    <div class="mobile-card card border-info">
      <div class="card-body p-mobile-2">
        <div class="d-flex justify-content-between align-items-start">
          <div class="flex-grow-1">
            <h6 class="mobile-header text-info mb-2">🏠 Current Cycle Status</h6>
            <div class="mobile-content">
              <strong>Available Birds: {{ cycle.current_birds }}</strong>
              <small class="text-muted d-block">Started: {{ cycle.start_date }}</small>
            </div>
          </div>
          <div class="ms-2">
            <a href="{{ url_for('dispatch_history') }}" class="btn btn-outline-info btn-sm mobile-button">
              📊 History
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- New Dispatch Form -->
  <div class="card p-3 p-md-4 shadow rounded-4 mb-4">
    <h5 class="card-title text-center mb-4">📝 Register New Vehicle</h5>
    
    <form method="POST" class="row g-3">
      <!-- Vehicle Number -->
      <div class="col-12 col-md-6">
        <label for="vehicle_no" class="form-label" data-i18n="vehicle_number_label">
          Vehicle Number *
        </label>
        <input type="text" class="form-control" id="vehicle_no" name="vehicle_no" 
               placeholder="e.g., AP01AB1234" required style="text-transform: uppercase;">
      </div>

      <!-- Driver Name -->
      <div class="col-12 col-md-6">
        <label for="driver_name" class="form-label" data-i18n="driver_name_label">
          Driver Name *
        </label>
        <input type="text" class="form-control" id="driver_name" name="driver_name" 
               placeholder="Enter driver's full name" required>
      </div>

      <!-- Vendor/Buyer Name -->
      <div class="col-12">
        <label for="vendor_name" class="form-label" data-i18n="vendor_name_label">
          Vendor/Buyer Name
        </label>
        <input type="text" class="form-control" id="vendor_name" name="vendor_name" 
               placeholder="Enter vendor or buyer name">
      </div>

      <!-- Date and Time Row -->
      <div class="col-6">
        <label for="dispatch_date" class="form-label" data-i18n="dispatch_date_label">
          Dispatch Date
        </label>
        <input type="date" class="form-control" id="dispatch_date" name="dispatch_date">
      </div>
      <div class="col-6">
        <label for="dispatch_time" class="form-label" data-i18n="dispatch_time_label">
          Dispatch Time
        </label>
        <input type="time" class="form-control" id="dispatch_time" name="dispatch_time">
      </div>

      <!-- Notes -->
      <div class="col-12">
        <label for="notes" class="form-label" data-i18n="notes_label">
          Notes
        </label>
        <textarea class="form-control" id="notes" name="notes" rows="2"
                  placeholder="Any additional notes about this dispatch"></textarea>
      </div>

      <!-- Submit Button -->
      <div class="col-12">
        <button type="submit" class="btn btn-primary btn-lg w-100" data-i18n="register_vehicle_button">
          🚛 Register Vehicle & Start Weighing
        </button>
      </div>
    </form>
  </div>

    <!-- Recent Dispatches -->
    {% if recent_dispatches %}
    <div class="card p-3 p-md-4 shadow rounded-4 mb-4">
      <h5 class="card-title text-center mb-4">📋 Recent Dispatches</h5>
      
      <!-- Desktop Table -->
      <div class="table-responsive d-none d-md-block">
        <table class="table table-hover">
          <thead class="table-light">
            <tr>
              <th data-i18n="vehicle">Vehicle</th>
              <th data-i18n="driver">Driver</th>
              <th data-i18n="status">Status</th>
              <th data-i18n="date">Date</th>
              <th data-i18n="action">Action</th>
            </tr>
          </thead>
          <tbody>
            {% for dispatch in recent_dispatches %}
            <tr>
              <td><strong>{{ dispatch.vehicle_no }}</strong></td>
              <td>{{ dispatch.driver_name }}</td>
              <td>
                {% if dispatch.status == 'completed' %}
                  <span class="badge bg-success">✅ Completed</span>
                {% else %}
                  <span class="badge bg-warning">⏳ Active</span>
                {% endif %}
              </td>
              <td class="date-cell" data-date="{{ dispatch.dispatch_date }}">{{ dispatch.dispatch_date }}</td>
              <td>
                {% if dispatch.status == 'active' %}
                  <a href="{{ url_for('weighing_screen', dispatch_id=dispatch.id) }}" 
                     class="btn btn-primary btn-sm">
                    ⚖️ Weigh
                  </a>
                {% else %}
                  <a href="{{ url_for('weighing_screen', dispatch_id=dispatch.id) }}" 
                     class="btn btn-outline-info btn-sm">
                    👁️ View
                  </a>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Mobile List View -->
      <div class="d-md-none">
        {% for dispatch in recent_dispatches %}
        <div class="card p-3 mb-3 {{ 'border-success' if dispatch.status == 'completed' else 'border-warning' }}">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div>
              <h6 class="mb-1">🚚 {{ dispatch.vehicle_no }}</h6>
              <small class="text-muted">{{ dispatch.driver_name }}</small>
            </div>
            <span class="badge {{ 'bg-success' if dispatch.status == 'completed' else 'bg-warning' }}">
              {{ '✅ Done' if dispatch.status == 'completed' else '⏳ Active' }}
            </span>
          </div>
          
          <div class="mb-3">
            <small class="text-muted">📅 <span class="date-cell">{{ dispatch.dispatch_date }}</span></small>
          </div>
          
          <div class="d-grid">
            {% if dispatch.status == 'active' %}
              <a href="{{ url_for('weighing_screen', dispatch_id=dispatch.id) }}" 
                 class="btn btn-primary btn-sm">
                ⚖️ Continue Weighing
              </a>
            {% else %}
              <a href="{{ url_for('weighing_screen', dispatch_id=dispatch.id) }}" 
                 class="btn btn-outline-info btn-sm">
                👁️ View Details
              </a>
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% else %}
    <!-- No Dispatches State -->
    <div class="mobile-section">
      <div class="mobile-card card text-center">
        <div class="card-body p-mobile-3">
          <div class="mb-3" style="font-size: 3rem;">🚛</div>
          <h5 class="mobile-header">No Dispatches Yet</h5>
          <p class="mobile-content text-muted mb-0">Register your first vehicle above to start dispatching birds to vendors.</p>
        </div>
      </div>
    </div>
    {% endif %}

  {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Auto-uppercase vehicle number
  const vehicleInput = document.getElementById('vehicle_no');
  if (vehicleInput) {
    vehicleInput.addEventListener('input', function(e) {
      e.target.value = e.target.value.toUpperCase();
    });
  }
  
  // Set current date and time as defaults
  const timeInput = document.getElementById('dispatch_time');
  const dateInput = document.getElementById('dispatch_date');
  
  // Set current date
  if (dateInput && !dateInput.value) {
    const today = new Date();
    const dateString = today.toISOString().split('T')[0];
    dateInput.value = dateString;
  }
  
  // Set current time
  if (timeInput && !timeInput.value) {
    const now = new Date();
    const timeString = now.toTimeString().slice(0, 5);
    timeInput.value = timeString;
  }
});
</script>

<!-- Mobile-friendly CSS -->
<style>
/* Mobile touch enhancements */
@media (max-width: 768px) {
  .card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  
  .card:active {
    transform: scale(0.98);
  }
  
  .btn {
    min-height: 44px;
    touch-action: manipulation;
  }
  
  /* Card hover effects for touch */
  .card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }
  
  /* Better spacing for mobile */
  .card p-3 {
    padding: 1rem !important;
  }
  
  /* Touch feedback */
  .btn:active {
    transform: scale(0.96);
  }
  
  /* Status badges more prominent on mobile */
  .badge {
    font-size: 0.8rem;
    padding: 0.4rem 0.6rem;
  }
}

/* Accessibility improvements */
.btn:focus {
  outline: 2px solid #007bff;
  outline-offset: 2px;
}

/* Form improvements for mobile */
@media (max-width: 576px) {
  .form-control {
    font-size: 16px; /* Prevents zoom on iOS */
  }
  
  .col-6 {
    margin-bottom: 1rem;
  }
}
</style>

{% endblock %}
