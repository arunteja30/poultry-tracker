{% extends 'base.html' %}
{% block content %}
<div class="mobile-container">
  <div class="d-flex justify-content-between align-items-center mb-mobile-3">
    <h2 class="mobile-header text-center mb-mobile-3" data-i18n="expenses_title">
      <span data-i18n="expenses_title">üí∏ Expenses Management</span>
    </h2>
    <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary mobile-button d-none d-md-inline-block" data-i18n="back_to_dashboard">‚Üê Back</a>
  </div>
  <div class="mb-3 d-md-none">
    <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary mobile-button w-100" data-i18n="back_to_dashboard">‚Üê Back</a>
  </div>

  <!-- Add New Expense Form -->
  <div class="mobile-section">
    <div class="mobile-card card">
      <div class="card-header bg-primary text-white p-mobile-2">
        <h6 class="mb-0" style="color: white;" data-i18n="add_expense_header">Add New Expense</h6>
      </div>
      <div class="card-body p-mobile-2">
        <form method="POST">
          <div class="row g-2">
            <div class="col-12 col-md-6">
              <label for="expense_name" class="form-label" data-i18n="expense_name_label">Expense Name</label>
              <input type="text" class="mobile-input form-control" id="name" name="name" required placeholder="Transport, Labor, etc.">
            </div>
            <div class="col-6 col-md-3">
              <label for="expense_date" class="form-label" data-i18n="expense_date_label">Date</label>
              <input type="date" class="mobile-input form-control" id="date" name="date" value="{{ date.today() }}" required>
            </div>
            <div class="col-6 col-md-3">
              <label for="expense_amount" class="form-label" data-i18n="expense_amount_label">Amount (‚Çπ)</label>
              <input type="number" class="mobile-input form-control" id="amount" name="amount" step="0.01" min="0" required placeholder="0.00">
            </div>
            <div class="col-12">
              <label for="expense_notes" class="form-label" data-i18n="expense_notes_label">Notes</label>
              <textarea class="mobile-input form-control" id="notes" name="notes" rows="2" placeholder="Additional details..."></textarea>
            </div>
          </div>
          <div class="mt-3">
            <button type="submit" class="btn btn-success w-100" data-i18n="add_expense_btn">Add Expense</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Expenses List -->
<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0" data-i18n="expenses_list_header">Expenses List</h5>
    <button class="btn btn-outline-primary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#expensesCollapse" aria-expanded="true">
      <span class="expand-text" data-i18n="collapse">üîº Collapse</span>
      <span class="collapse-text d-none" data-i18n="expand">üîΩ Expand</span>
    </button>
  </div>
  <div class="collapse show" id="expensesCollapse">
    <div class="card-body">
      {% if expenses %}
      
      <!-- Desktop Table -->
      <div class="table-responsive d-none d-md-block">
        <table class="table table-sm table-striped">
          <thead class="table-dark">
            <tr>
              <th data-i18n="expense_name">Name</th>
              <th data-i18n="expense_date">Date</th>
              <th data-i18n="expense_amount">Amount (‚Çπ)</th>
              <th data-i18n="expense_notes">Notes</th>
              <th data-i18n="audit_info">Created By/Date</th>
              <th data-i18n="actions">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for expense in expenses %}
            <tr>
              <td><strong>{{ expense.name }}</strong></td>
              <td><span data-date="{{ expense.date }}">{{ expense.date }}</span></td>
              <td><span class="text-danger">‚Çπ{{ "%.2f"|format(expense.amount) }}</span></td>
              <td>{{ expense.notes or '-' }}</td>
              <td>
                <small class="text-muted">
                  {% if expense.created_date %}
                    {{ expense.created_date.strftime('%Y-%m-%d %H:%M') }}
                  {% endif %}
                  {% if expense.created_by %}
                    {% set created_user = get_user_by_id(expense.created_by) %}
                    <br>by {{ created_user.full_name or created_user.username if created_user else 'User ID ' + expense.created_by|string }}
                  {% endif %}
                  {% if expense.modified_date %}
                    <br><i class="bi bi-pencil me-1"></i>{{ expense.modified_date.strftime('%Y-%m-%d %H:%M') }}
                    {% if expense.modified_by %}
                      {% set modified_user = get_user_by_id(expense.modified_by) %}
                      by {{ modified_user.full_name or modified_user.username if modified_user else 'User ID ' + expense.modified_by|string }}
                    {% endif %}
                  {% endif %}
                </small>
              </td>
              {% if session.role == 'admin' %}
              <td>
                <form method="POST" action="{{ url_for('delete_expense', expense_id=expense.id) }}" style="display: inline;" 
                      onsubmit="return confirm('Are you sure you want to delete this expense?')">
                  <button type="submit" class="btn btn-outline-danger btn-sm" data-i18n="delete">üóëÔ∏è Delete</button>
                </form>
              </td>
              {% endif %}
            </tr>
            {% endfor %}
          </tbody>
          <tfoot class="table-info">
            <tr>
              <td colspan="{% if session.role == 'admin' %}4{% else %}3{% endif %}"><strong data-i18n="total_expenses">Total Expenses:</strong></td>
              <td><strong class="text-danger">‚Çπ{{ "%.2f"|format(total_amount) }}</strong></td>
              {% if session.role == 'admin' %}
              <td></td>
              {% endif %}
            </tr>
          </tfoot>
        </table>
      </div>

      <!-- Mobile Cards -->
      <div class="d-md-none">
        {% for expense in expenses %}
        <div class="card mb-3 border-warning">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <h6 class="card-title mb-0">
                <strong>{{ expense.name }}</strong>
              </h6>
              <span class="badge bg-danger">‚Çπ{{ "%.2f"|format(expense.amount) }}</span>
            </div>
            <div class="row">
              <div class="col-6">
                <small class="text-muted" data-i18n="expense_date">Date:</small><br>
                <strong><span data-date="{{ expense.date }}">{{ expense.date }}</span></strong>
              </div>
              <div class="col-6">
                <small class="text-muted" data-i18n="expense_notes">Notes:</small><br>
                <strong>{{ expense.notes or '-' }}</strong>
              </div>
            </div>
            
            <!-- Audit Trail Information -->
            <div class="row mt-2">
              <div class="col-12">
                <small class="text-muted">
                  <i class="bi bi-clock me-1"></i>
                  {% if expense.created_date %}
                    Created: {{ expense.created_date.strftime('%Y-%m-%d %H:%M') }}
                  {% endif %}
                  {% if expense.created_by %}
                    {% set created_user = get_user_by_id(expense.created_by) %}
                    by {{ created_user.full_name or created_user.username if created_user else 'User ID ' + expense.created_by|string }}
                  {% endif %}
                  {% if expense.modified_date %}
                    <br><i class="bi bi-pencil me-1"></i>
                    Modified: {{ expense.modified_date.strftime('%Y-%m-%d %H:%M') }}
                    {% if expense.modified_by %}
                      {% set modified_user = get_user_by_id(expense.modified_by) %}
                      by {{ modified_user.full_name or modified_user.username if modified_user else 'User ID ' + expense.modified_by|string }}
                    {% endif %}
                  {% endif %}
                </small>
              </div>
            </div>
            
            {% if session.role == 'admin' %}
            <div class="row mt-2">
              <div class="col-12 text-end">
                <form method="POST" action="{{ url_for('delete_expense', expense_id=expense.id) }}" style="display: inline;" 
                      onsubmit="return confirm('Are you sure you want to delete this expense?')">
                  <button type="submit" class="btn btn-outline-danger btn-sm" data-i18n="delete">üóëÔ∏è Delete</button>
                </form>
              </div>
            </div>
            {% endif %}
          </div>
        </div>
        {% endfor %}

        <!-- Total Summary Card -->
        <div class="card border-info">
          <div class="card-body text-center">
            <h6 class="card-title text-info" data-i18n="total_expenses">Total Expenses</h6>
            <h4 class="text-danger">‚Çπ{{ "%.2f"|format(total_amount) }}</h4>
          </div>
        </div>
      </div>

      {% else %}
      <div class="alert alert-info">
        <p class="mb-0" data-i18n="no_expenses_message">No expenses recorded yet. Add your first expense above!</p>
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Toggle collapse text
const expensesToggle = document.querySelector('[data-bs-target="#expensesCollapse"]');
const expensesCollapse = document.getElementById('expensesCollapse');

if (expensesToggle && expensesCollapse) {
  expensesCollapse.addEventListener('shown.bs.collapse', function() {
    const expandText = expensesToggle.querySelector('.expand-text');
    const collapseText = expensesToggle.querySelector('.collapse-text');
    expandText.classList.remove('d-none');
    collapseText.classList.add('d-none');
  });
  
  expensesCollapse.addEventListener('hidden.bs.collapse', function() {
    const expandText = expensesToggle.querySelector('.expand-text');
    const collapseText = expensesToggle.querySelector('.collapse-text');
    expandText.classList.add('d-none');
    collapseText.classList.remove('d-none');
  });
}

// Form validation
document.querySelector('form').addEventListener('submit', function(e) {
  const name = document.getElementById('name').value.trim();
  const amount = parseFloat(document.getElementById('amount').value);
  
  if (!name) {
    e.preventDefault();
    alert('Please enter expense name');
    return;
  }
  
  if (!amount || amount <= 0) {
    e.preventDefault();
    alert('Please enter a valid amount greater than 0');
    return;
  }
});
</script>
{% endblock %}

<style>
@media (max-width: 576px) {
  .btn, .btn-sm, .btn-lg {
    font-size: 0.85rem !important;
    padding: 0.3rem 0.7rem !important;
    border-radius: 0.3rem !important;
  }
  .card-header h5, h2, h3, h5, .card-title {
    font-size: 1.1rem !important;
    margin-bottom: 0.5rem !important;
  }
  .card-header {
    padding: 0.5rem 1rem !important;
  }
  .card-body {
    padding: 0.7rem 0.7rem !important;
  }
  .expand-text, .collapse-text {
    font-size: 0.95rem !important;
  }
}
</style>
