{% extends 'base.html' %}
{% block content %}
<div class="mobile-container">
  <div class="d-flex justify-content-between align-items-center mb-mobile-3">
    <h2 class="mobile-header" data-i18n="stats_title">üìä Statistics</h2>
    <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary mobile-button d-none d-md-inline-block" data-i18n="back_to_dashboard">‚Üê Back</a>
  </div>
  <div class="mb-3 d-md-none">
    <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary mobile-button w-100" data-i18n="back_to_dashboard">‚Üê Back</a>
  </div>

  <div class="d-flex justify-content-between align-items-center mb-mobile-3">
    {% if cycle %}
    <div class="mobile-content text-muted">
      <small data-i18n="cycle_info">Day {{ stats.cycle_duration }}/{{ stats.target_days }}</small>
    </div>
    {% endif %}
  </div>

  {% if not cycle %}
  <!-- No Active Cycle -->
  <div class="mobile-section">
    <div class="mobile-card card text-center">
      <div class="card-body p-mobile-3">
        <div class="mb-3" style="font-size: 3rem;">üêî</div>
        <h5 class="mobile-header" data-i18n="no_cycle">No Active Cycle</h5>
        <p class="mobile-content text-muted mb-3" data-i18n="setup_instruction">Please set up a cycle to view statistics.</p>
        <a href="{{ url_for('setup') }}" class="mobile-button btn btn-primary w-100" data-i18n="setup_new_cycle">Setup New Cycle</a>
      </div>
    </div>
  </div>
  {% else %}

  <!-- Performance Overview Cards -->
  <div class="mobile-section">
    <h5 class="mobile-header">üìà Performance Overview</h5>
    <div class="row g-2">
  <div class="col-md-3 col-sm-6 mb-3">
    <div class="card h-100 border-success">
      <div class="card-body text-center">
        <div class="display-6 text-success">{{ stats.survival_rate }}%</div>
        <h6 class="card-title text-success" data-i18n="survival_rate">Survival Rate</h6>
        <small class="text-muted">{{ cycle.current_birds }} / {{ cycle.start_birds }} birds</small>
      </div>
    </div>
  </div>
  
  <div class="col-md-3 col-sm-6 mb-3">
    <div class="card h-100 border-primary">
      <div class="card-body text-center">
        <div class="display-6 text-primary">{{ stats.avg_weight }}</div>
        <h6 class="card-title text-primary" data-i18n="avg_weight">Avg Weight (kg)</h6>
        <small class="text-muted">+{{ stats.weight_gain_per_bird }} kg gained</small>
      </div>
    </div>
  </div>
  
  <div class="col-md-3 col-sm-6 mb-3">
    <div class="card h-100 border-warning">
      <div class="card-body text-center">
        <div class="display-6 text-warning">{{ stats.avg_fcr }}</div>
        <h6 class="card-title text-warning" data-i18n="avg_fcr">Average FCR</h6>
        <small class="text-muted">Cumulative: {{ stats.cumulative_fcr }}</small>
      </div>
    </div>
  </div>
  
  <div class="col-md-3 col-sm-6 mb-3">
    <div class="card h-100 border-info">
      <div class="card-body text-center">
        <div class="display-6 text-info">{{ stats.days_remaining }}</div>
        <h6 class="card-title text-info" data-i18n="days_remaining">Days Remaining</h6>
        <small class="text-muted">Target: {{ stats.target_days }} days</small>
      </div>
    </div>
  </div>
</div>

<!-- Detailed Statistics Cards -->
<div class="row mb-4">
  <!-- Feed Statistics -->
  <div class="col-lg-6 mb-4">
    <div class="card h-100">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0" data-i18n="feed_stats">üåæ Feed Statistics</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-6">
            <div class="text-center p-3 bg-light rounded">
              <h4 class="text-primary">{{ stats.total_feed_bags }}</h4>
              <small data-i18n="consumed_bags">Bags Consumed</small>
            </div>
          </div>
          <div class="col-6">
            <div class="text-center p-3 bg-light rounded">
              <h4 class="text-success">{{ stats.current_feed_bags }}</h4>
              <small data-i18n="remaining_bags">Bags Remaining</small>
            </div>
          </div>
        </div>
        <hr>
        <div class="row mt-3">
          <div class="col-12">
            <p><strong data-i18n="feed_efficiency">Feed Efficiency:</strong> {{ stats.feed_efficiency }} bags/bird</p>
            <p><strong data-i18n="total_feed_cost">Total Feed Cost:</strong> ‚Çπ{{ "{:,.0f}".format(stats.total_feed_cost) }}</p>
            <p><strong data-i18n="feed_cost_per_bird">Cost per Bird:</strong> ‚Çπ{{ stats.feed_cost_per_bird }}</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Mortality Statistics -->
  <div class="col-lg-6 mb-4">
    <div class="card h-100">
      <div class="card-header bg-danger text-white">
        <h5 class="mb-0" data-i18n="mortality_stats">üíÄ Mortality Statistics</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-6">
            <div class="text-center p-3 bg-light rounded">
              <h4 class="text-danger">{{ stats.total_mortality }}</h4>
              <small data-i18n="total_deaths">Total Deaths</small>
            </div>
          </div>
          <div class="col-6">
            <div class="text-center p-3 bg-light rounded">
              <h4 class="text-warning">{{ stats.avg_daily_mortality }}</h4>
              <small data-i18n="daily_avg">Daily Average</small>
            </div>
          </div>
        </div>
        <hr>
        <div class="row mt-3">
          <div class="col-12">
            <p><strong data-i18n="mortality_rate">Mortality Rate:</strong> {{ stats.mortality_rate }}%</p>
            <p><strong data-i18n="current_population">Current Population:</strong> {{ cycle.current_birds }} birds</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Charts Section -->
<div class="row mb-4">
  <!-- Birds Distribution Chart -->
  <div class="col-lg-4 mb-4">
    <div class="card h-100">
      <div class="card-header">
        <h6 class="mb-0" data-i18n="birds_distribution">üêî Birds Distribution</h6>
      </div>
      <div class="card-body">
        <div style="height: 250px; display: flex; align-items: center; justify-content: center;">
          <canvas id="birdsChart"></canvas>
        </div>
        <div class="text-center mt-2">
          <small class="text-muted" data-i18n="live_vs_mortality">Live vs Mortality</small>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Feed Distribution Chart -->
  <div class="col-lg-4 mb-4">
    <div class="card h-100">
      <div class="card-header">
        <h6 class="mb-0" data-i18n="feed_distribution">üåæ Feed Distribution</h6>
      </div>
      <div class="card-body">
        <div style="height: 250px; display: flex; align-items: center; justify-content: center;">
          <canvas id="feedChart"></canvas>
        </div>
        <div class="text-center mt-2">
          <small class="text-muted" data-i18n="consumed_vs_remaining">Consumed vs Remaining</small>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Cost Breakdown Chart -->
  <div class="col-lg-4 mb-4">
    <div class="card h-100">
      <div class="card-header">
        <h6 class="mb-0" data-i18n="cost_breakdown">üí∞ Cost Breakdown</h6>
      </div>
      <div class="card-body">
        <div style="height: 250px; display: flex; align-items: center; justify-content: center;">
          <canvas id="costChart"></canvas>
        </div>
        <div class="text-center mt-2">
          <small class="text-muted" data-i18n="feed_vs_medicine">Feed vs Medicine Costs</small>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Performance Indicators -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0" data-i18n="performance_indicators">üìà Performance Indicators</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-4 mb-3">
            <label data-i18n="survival_performance">Survival Performance</label>
            <div class="progress" style="height: 25px;">
              <div class="progress-bar bg-success" role="progressbar" 
                   style="width: {{ chart_data.performance_scores.survival_rate }}%">
                {{ chart_data.performance_scores.survival_rate }}%
              </div>
            </div>
          </div>
          <div class="col-md-4 mb-3">
            <label data-i18n="feed_efficiency_score">Feed Efficiency Score</label>
            <div class="progress" style="height: 25px;">
              <div class="progress-bar bg-primary" role="progressbar" 
                   style="width: {{ chart_data.performance_scores.feed_efficiency_score }}%">
                {{ "{:.0f}".format(chart_data.performance_scores.feed_efficiency_score) }}%
              </div>
            </div>
          </div>
          <div class="col-md-4 mb-3">
            <label data-i18n="weight_gain_score">Weight Gain Score</label>
            <div class="progress" style="height: 25px;">
              <div class="progress-bar bg-warning" role="progressbar" 
                   style="width: {{ chart_data.performance_scores.weight_gain_score }}%">
                {{ "{:.0f}".format(chart_data.performance_scores.weight_gain_score) }}%
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Additional Insights -->
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0" data-i18n="insights">üí° Key Insights</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <h6 data-i18n="production_metrics">Production Metrics</h6>
            <ul class="list-unstyled">
              <li><strong data-i18n="total_weight_gain">Total Weight Gain:</strong> {{ stats.total_weight_gain }} kg</li>
              <li><strong data-i18n="weight_per_bird">Weight per Bird:</strong> {{ stats.weight_gain_per_bird }} kg</li>
              <li><strong data-i18n="feed_conversion">Feed Conversion:</strong> {{ stats.cumulative_fcr }} FCR</li>
            </ul>
          </div>
          <div class="col-md-6">
            <h6 data-i18n="financial_summary">Financial Summary</h6>
            <ul class="list-unstyled">
              <li><strong data-i18n="total_investment">Total Investment:</strong> ‚Çπ{{ "{:,.0f}".format(stats.total_feed_cost + stats.total_medicine_cost) }}</li>
              <li><strong data-i18n="cost_per_bird">Cost per Bird:</strong> ‚Çπ{{ "{:.0f}".format((stats.total_feed_cost + stats.total_medicine_cost) / cycle.current_birds) if cycle.current_birds > 0 else 0 }}</li>
              <li><strong data-i18n="medicine_cost">Medicine Cost:</strong> ‚Çπ{{ "{:,.0f}".format(stats.total_medicine_cost) }}</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Chart.js configurations
Chart.defaults.responsive = true;
Chart.defaults.maintainAspectRatio = true;

// Common chart options for doughnut charts
const commonDoughnutOptions = {
    responsive: true,
    maintainAspectRatio: true,
    aspectRatio: 1,
    plugins: {
        legend: {
            position: 'bottom',
            labels: {
                padding: 15,
                usePointStyle: true,
                font: {
                    size: 12
                }
            }
        }
    }
};

// Birds Distribution Chart
const birdsCtx = document.getElementById('birdsChart').getContext('2d');
new Chart(birdsCtx, {
    type: 'doughnut',
    data: {
        labels: {{ chart_data.survival_vs_mortality.labels|tojson }},
        datasets: [{
            data: {{ chart_data.survival_vs_mortality.data|tojson }},
            backgroundColor: ['#28a745', '#dc3545'],
            borderWidth: 2,
            borderColor: '#fff'
        }]
    },
    options: commonDoughnutOptions
});

// Feed Distribution Chart
const feedCtx = document.getElementById('feedChart').getContext('2d');
new Chart(feedCtx, {
    type: 'doughnut',
    data: {
        labels: {{ chart_data.feed_distribution.labels|tojson }},
        datasets: [{
            data: {{ chart_data.feed_distribution.data|tojson }},
            backgroundColor: ['#ffc107', '#28a745'],
            borderWidth: 2,
            borderColor: '#fff'
        }]
    },
    options: commonDoughnutOptions
});

// Cost Breakdown Chart
const costCtx = document.getElementById('costChart').getContext('2d');
new Chart(costCtx, {
    type: 'doughnut',
    data: {
        labels: {{ chart_data.cost_breakdown.labels|tojson }},
        datasets: [{
            data: {{ chart_data.cost_breakdown.data|tojson }},
            backgroundColor: ['#007bff', '#17a2b8'],
            borderWidth: 2,
            borderColor: '#fff'
        }]
    },
    options: commonDoughnutOptions
});
</script>

{% endif %}
{% endblock %}
