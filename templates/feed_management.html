{% extends 'base.html' %}
{% block content %}
<div class="mobile-container">
  <h2 class="mobile-header text-center mb-mobile-3" data-i18n="feed_management_title">
    <span data-i18n="feed_management_title">üåæ Feed Management</span>
  </h2>
  
  <div class="mobile-section">
    <div class="mobile-card card">
      <div class="card-header bg-success text-white p-mobile-2">
        <h6 class="mb-0" data-i18n="add_new_feed">‚ûï Add New Feed</h6>
      </div>
      <div class="card-body p-mobile-2">
        <form method="POST">
          <div class="row g-2">
            <div class="col-12 col-md-6">
              <label for="bill_number" class="form-label mobile-content" data-i18n="feed_bill_no">Bill Number</label>
              <input id="bill_number" name="bill_number" type="text" class="mobile-input form-control" required>
            </div>
            <div class="col-12 col-md-6">
              <label for="date" class="form-label mobile-content" data-i18n="feed_date">Date</label>
              <input id="date" name="date" type="date" class="mobile-input form-control" value="{{ current_date }}" required>
            </div>
            <div class="col-12">
              <label for="feed_name" class="form-label mobile-content" data-i18n="feed_name">Feed Name</label>
              <input id="feed_name" name="feed_name" type="text" class="mobile-input form-control" required>
            </div>
            <div class="col-6 col-md-4">
              <label for="feed_bags" class="form-label mobile-content" data-i18n="feed_bags">Bags</label>
              <input id="feed_bags" name="feed_bags" type="number" min="1" class="mobile-input form-control" required>
            </div>
            <div class="col-6 col-md-4">
              <label for="bag_weight" class="form-label mobile-content" data-i18n="feed_bag_weight">Weight (kg)</label>
              <input id="bag_weight" name="bag_weight" type="number" step="0.01" class="mobile-input form-control" value="50" required>
            </div>
            <div class="col-12 col-md-4">
              <label for="price_per_kg" class="form-label mobile-content" data-i18n="feed_price_per_kg">Price/kg (‚Çπ)</label>
              <input id="price_per_kg" name="price_per_kg" type="number" step="0.01" class="mobile-input form-control" value="45" required>
            </div>
          </div>
          <div class="mt-3">
            <button type="submit" class="mobile-button btn btn-success w-100" data-i18n="feed_add_btn">üåæ Add Feed</button>
          </div>
        </form>
      </div>
    </div>
  </div>


<div class="card">
  <div class="card-body">
    <h5 data-i18n="feed_list_header">Feed List</h5>
    <!-- Desktop Table View -->
    <div class="d-none d-md-block">
      <table class="table table-bordered table-striped">
        <thead>
          <tr>
            <th data-i18n="feed_bill_no">Bill No</th>
            <th data-i18n="feed_date">Date</th>
            <th data-i18n="feed_name">Feed Name</th>
            <th data-i18n="feed_bags">Bags</th>
            <th data-i18n="feed_bag_weight">Bag Weight (kg)</th>
            <th data-i18n="feed_total_feed">Total Feed (kg)</th>
            <th data-i18n="feed_price_per_kg">Price/kg (‚Çπ)</th>
            <th data-i18n="feed_total_cost">Total Cost (‚Çπ)</th>
            <th data-i18n="audit_info">Created By/Date</th>
            <th data-i18n="actions">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for feed in feeds %}
          <tr>
            <td>{{ feed.bill_number }}</td>
            <td>{{ feed.date }}</td>
            <td>{{ feed.feed_name }}</td>
            <td>{{ feed.feed_bags }}</td>
            <td>{{ feed.bag_weight }}</td>
            <td>{{ feed.total_feed_kg }}</td>
            <td>{{ feed.price_per_kg }}</td>
            <td>{{ feed.total_cost }}</td>
            <td>
              <small class="text-muted">
                {% if feed.created_date %}
                  {{ feed.created_date.strftime('%Y-%m-%d %H:%M') }}
                {% endif %}
                {% if feed.created_by %}
                  {% set created_user = get_user_by_id(feed.created_by) %}
                  <br>by {{ created_user.full_name or created_user.username if created_user else 'User ID ' + feed.created_by|string }}
                {% endif %}
                {% if feed.modified_date %}
                  <br><i class="bi bi-pencil me-1"></i>{{ feed.modified_date.strftime('%Y-%m-%d %H:%M') }}
                  {% if feed.modified_by %}
                    {% set modified_user = get_user_by_id(feed.modified_by) %}
                    by {{ modified_user.full_name or modified_user.username if modified_user else 'User ID ' + feed.modified_by|string }}
                  {% endif %}
                {% endif %}
              </small>
            </td>
            <td>
              <button type="button" class="btn btn-sm btn-danger" onclick="deleteFeed({{ feed.id }}, '{{ feed.feed_name }}', '{{ feed.bill_number }}')" data-i18n="delete" title="Delete Feed Entry">
                üóëÔ∏è Delete
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <!-- Mobile Card View -->
    <div class="d-block d-md-none">
      {% if feeds %}
        {% for feed in feeds %}
          <div class="border rounded p-3 mb-3">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <h6 class="mb-0"><strong>{{ feed.feed_name }}</strong></h6>
              <button type="button" class="btn btn-sm btn-danger" onclick="deleteFeed({{ feed.id }}, '{{ feed.feed_name }}', '{{ feed.bill_number }}')" title="Delete Feed Entry">
                üóëÔ∏è
              </button>
            </div>
            <div><strong data-i18n="feed_bill_no">Bill No:</strong> {{ feed.bill_number }}</div>
            <div><strong data-i18n="feed_date">Date:</strong> {{ feed.date }}</div>
            <div><strong data-i18n="feed_bags">Bags:</strong> {{ feed.feed_bags }}</div>
            <div><strong data-i18n="feed_bag_weight">Bag Weight (kg):</strong> {{ feed.bag_weight }}</div>
            <div><strong data-i18n="feed_total_feed">Total Feed (kg):</strong> {{ feed.total_feed_kg }}</div>
            <div><strong data-i18n="feed_price_per_kg">Price/kg (‚Çπ):</strong> {{ feed.price_per_kg }}</div>
            <div><strong data-i18n="feed_total_cost">Total Cost (‚Çπ):</strong> {{ feed.total_cost }}</div>
            
            <!-- Audit Trail Information -->
            <div class="pt-2 mt-2 border-top">
              <small class="text-muted">
                <i class="bi bi-clock me-1"></i>
                {% if feed.created_date %}
                  Created: {{ feed.created_date.strftime('%Y-%m-%d %H:%M') }}
                {% endif %}
                {% if feed.created_by %}
                  {% set created_user = get_user_by_id(feed.created_by) %}
                  by {{ created_user.full_name or created_user.username if created_user else 'User ID ' + feed.created_by|string }}
                {% endif %}
                {% if feed.modified_date %}
                  <br><i class="bi bi-pencil me-1"></i>
                  Modified: {{ feed.modified_date.strftime('%Y-%m-%d %H:%M') }}
                  {% if feed.modified_by %}
                    {% set modified_user = get_user_by_id(feed.modified_by) %}
                    by {{ modified_user.full_name or modified_user.username if modified_user else 'User ID ' + feed.modified_by|string }}
                  {% endif %}
                {% endif %}
              </small>
            </div>
          </div>
        {% endfor %}
        <div class="mt-2 text-end">
          <strong data-i18n="feed_total_feed_cost">Total Feed Cost:</strong> <span class="text-success">‚Çπ{{ total_cost }}</span>
        </div>
      {% else %}
        <div class="text-muted text-center" data-i18n="feed_no_entries">No feed entries found.</div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" data-i18n="confirm_delete">Confirm Delete</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p data-i18n="delete_feed_confirm">Are you sure you want to delete this feed entry?</p>
        <div class="alert alert-warning">
          <strong data-i18n="feed_name">Feed Name:</strong> <span id="deleteFeedName"></span><br>
          <strong data-i18n="feed_bill_no">Bill No:</strong> <span id="deleteBillNumber"></span>
        </div>
        <p class="text-danger small" data-i18n="delete_warning">This action cannot be undone.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="cancel">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn" data-i18n="delete">Delete</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let feedToDelete = null;

function deleteFeed(feedId, feedName, billNumber) {
  feedToDelete = feedId;
  document.getElementById('deleteFeedName').textContent = feedName;
  document.getElementById('deleteBillNumber').textContent = billNumber;
  
  const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
  modal.show();
}

document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
  if (feedToDelete) {
    // Create a form to submit the delete request
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/delete_feed/' + feedToDelete;
    
    // Add CSRF token if needed
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = '_method';
    csrfInput.value = 'DELETE';
    form.appendChild(csrfInput);
    
    document.body.appendChild(form);
    form.submit();
  }
});
</script>

<style>
/* Mobile-friendly button improvements */
@media (max-width: 576px) {
  .btn-sm {
    min-height: 36px;
    min-width: 36px;
    padding: 0.25rem 0.5rem;
  }
  
  .border.rounded {
    border: 1px solid #dee2e6 !important;
    border-radius: 0.375rem !important;
    background-color: #f8f9fa;
  }
  
  .border.rounded:hover {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
}

.btn-danger:hover {
  transform: scale(1.05);
  transition: transform 0.2s ease-in-out;
}
</style>
{% endblock %}
