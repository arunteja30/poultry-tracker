{% extends 'base.html' %}
{% block content %}
<div class="mobile-container">
  <div class="mobile-section">
    <!-- Header with Back Button -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="mobile-header m-0" data-i18n="edit_daily_title">
        <i class="bi bi-pencil-square me-2"></i><span data-i18n="edit_daily_title">Edit Daily Entry</span>
      </h2>
      <a href="{{ url_for('daywise') }}" class="mobile-btn-outline-secondary btn-sm" data-i18n="back_to_daily_reports">
        <i class="bi bi-arrow-left me-1"></i><span data-i18n="back_to_daily_reports">Back</span>
      </a>
    </div>

    <!-- Entry Info Card -->
    <div class="mobile-card mb-4">
      <h5 class="mobile-card-title" data-i18n="entry_information">
        <i class="bi bi-info-circle me-2"></i><span data-i18n="entry_information">Entry Information</span>
      </h5>
      <div class="row g-3">
        <div class="col-6 col-md-4">
          <div class="mobile-metric-card text-center bg-primary bg-opacity-10">
            <div class="mobile-metric-value text-primary">{{ entry.entry_date }}</div>
            <div class="mobile-metric-label" data-i18n="date"><span data-i18n="date">Date</span></div>
          </div>
        </div>
        <div class="col-6 col-md-4">
          <div class="mobile-metric-card text-center bg-info bg-opacity-10">
            <div class="mobile-metric-value text-info">{{ loop.index if loop else 'N/A' }}</div>
            <div class="mobile-metric-label" data-i18n="day"><span data-i18n="day">Day</span></div>
          </div>
        </div>
        <div class="col-12 col-md-4">
          <div class="mobile-metric-card text-center bg-success bg-opacity-10">
            <div class="mobile-metric-value text-success">{{ cycle.id }}</div>
            <div class="mobile-metric-label" data-i18n="cycle_id"><span data-i18n="cycle_id">Cycle ID</span></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Form -->
    <div class="mobile-card">
      <h5 class="mobile-card-title" data-i18n="edit_entry_data">
        <i class="bi bi-clipboard-data me-2"></i><span data-i18n="edit_entry_data">Edit Entry Data</span>
      </h5>
      
      <form method="POST" class="mobile-form-enhanced">
        <!-- Mortality Section -->
        <div class="mobile-form-group">
          <label for="mortality" class="mobile-form-label" data-i18n="mortality">
            <i class="bi bi-exclamation-triangle me-2"></i><span data-i18n="mortality">Mortality</span>
          </label>
          <input id="mortality" type="number" name="mortality" class="mobile-form-control"
                 value="{{ entry.mortality }}" min="0" required
                 placeholder="Enter mortality count" data-i18n-placeholder="mortality_ph">
          <small class="text-muted">
            <i class="bi bi-clock-history me-1"></i><span data-i18n="current">Current:</span> {{ entry.mortality }}
          </small>
          <div class="invalid-feedback" data-i18n="mortality_validation"><span data-i18n="mortality_validation">Please enter a valid mortality count.</span></div>
        </div>

        <!-- Feed Consumption Section -->
        <div class="mobile-form-group">
          <label for="feed-consumed" class="mobile-form-label" data-i18n="feed_bags_consumed">
            <i class="bi bi-basket me-2"></i><span data-i18n="feed_bags_consumed">Feed Bags Consumed</span>
          </label>
          <input id="feed-consumed" type="number" step="0.1" name="feed_bags_consumed" 
                 class="mobile-form-control" value="{{ entry.feed_bags_consumed }}" min="0" required
                 placeholder="Enter feed consumed" data-i18n-placeholder="feed_consumed_ph">
          <small class="text-muted">
            <i class="bi bi-clock-history me-1"></i><span data-i18n="current">Current:</span> {{ entry.feed_bags_consumed }}
          </small>
          <div class="invalid-feedback" data-i18n="feed_validation"><span data-i18n="feed_validation">Please enter a valid feed consumption amount.</span></div>
        </div>

        <!-- Feed Added Section -->
        <div class="mobile-form-group">
          <label for="feed-added" class="mobile-form-label" data-i18n="feed_bags_added">
            <i class="bi bi-plus-circle me-2"></i><span data-i18n="feed_bags_added">Feed Bags Added</span>
          </label>
          <input id="feed-added" type="number" step="0.1" name="feed_bags_added" 
                 class="mobile-form-control" value="{{ entry.feed_bags_added }}" min="0"
                 placeholder="Enter feed added">
          <small class="text-muted">
            <i class="bi bi-clock-history me-1"></i>Current: {{ entry.feed_bags_added }}
          </small>
          <div class="invalid-feedback">Please enter a valid feed addition amount.</div>
        </div>

        <!-- Average Weight Section -->
        <div class="mobile-form-group">
          <label for="avg-weight" class="mobile-form-label" data-i18n="avg_weight">
            <i class="bi bi-speedometer2 me-2"></i>Average Weight (kg)
          </label>
          <input id="avg-weight" type="number" step="0.001" name="avg_weight" 
                 class="mobile-form-control" value="{{ entry.avg_weight }}" min="0" required
                 placeholder="Enter average weight">
          <small class="text-muted">
            <i class="bi bi-clock-history me-1"></i>Current: {{ entry.avg_weight }} kg ({{ (entry.avg_weight * 1000)|int }} g)
          </small>
          <div class="invalid-feedback">Please enter a valid weight.</div>
        </div>

        <!-- Medicines Section -->
        <div class="mobile-form-group">
          <label for="medicines" class="mobile-form-label" data-i18n="medicines_given">
            <i class="bi bi-capsule me-2"></i>Medicines Given
          </label>
          <textarea id="medicines" name="medicines" class="mobile-form-control" rows="4"
                    placeholder="Enter medicines given (if any)">{{ entry.medicines or '' }}</textarea>
          <small class="text-muted">
            <i class="bi bi-clock-history me-1"></i>Current: {{ entry.medicines or 'None' }}
          </small>
          <div class="invalid-feedback">Please enter valid medicine information.</div>
        </div>

        <!-- Notes Section -->
        <div class="mobile-form-group">
          <label for="daily-notes" class="mobile-form-label" data-i18n="notes">
            <i class="bi bi-journal-text me-2"></i>Daily Notes
          </label>
          <textarea id="daily-notes" name="daily_notes" class="mobile-form-control" rows="4"
                    placeholder="Enter any additional notes (optional)">{{ entry.daily_notes or '' }}</textarea>
          <small class="text-muted">
            <i class="bi bi-clock-history me-1"></i>Current: {{ entry.daily_notes or 'No notes' }}
          </small>
          <div class="invalid-feedback">Please enter valid notes.</div>
        </div>

        <!-- Current Calculated Values -->
        <div class="mobile-card bg-light mt-4">
          <h6 class="mobile-card-title text-muted" data-i18n="current_calculated_values">
            <i class="bi bi-calculator me-2"></i>Current Calculated Values
          </h6>
          <div class="row g-3">
            <div class="col-6 col-md-4">
              <div class="mobile-metric-card text-center bg-success bg-opacity-10">
                <div class="mobile-metric-value text-success">{{ entry.fcr }}</div>
                <div class="mobile-metric-label">FCR</div>
              </div>
            </div>
            <div class="col-6 col-md-4">
              <div class="mobile-metric-card text-center bg-info bg-opacity-10">
                <div class="mobile-metric-value text-info">{{ "{:,.1f}".format(entry.avg_feed_per_bird_g) }}g</div>
                <div class="mobile-metric-label">Avg Feed/Bird</div>
              </div>
            </div>
            <div class="col-12 col-md-4">
              <div class="mobile-metric-card text-center bg-warning bg-opacity-10">
                <div class="mobile-metric-value text-warning">{{ entry.birds_survived if entry.birds_survived else 'N/A' }}</div>
                <div class="mobile-metric-label">Birds Survived</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="d-grid gap-3 mt-4">
          <button type="submit" class="mobile-btn-primary">
            <i class="bi bi-check-circle me-2"></i>Update Entry
          </button>
          <a href="{{ url_for('daywise') }}" class="mobile-btn-outline-secondary">
            <i class="bi bi-x-circle me-2"></i>Cancel Changes
          </a>
        </div>
      </form>
    </div>

    <!-- Important Notes -->
    <div class="mobile-alert alert alert-warning mt-4">
      <h6 class="d-flex align-items-center mb-3">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <span data-i18n="important_notes">Important Notes</span>
      </h6>
      <ul class="mb-0 small">
        <li class="mb-2" data-i18n="note_cycle_totals">
          <i class="bi bi-arrow-right me-2"></i>Changing values will affect cycle totals and calculations
        </li>
        <li class="mb-2" data-i18n="note_fcr_recalc">
          <i class="bi bi-arrow-right me-2"></i>FCR and Avg Feed/Bird will be recalculated automatically
        </li>
        <li class="mb-2" data-i18n="note_bird_count">
          <i class="bi bi-arrow-right me-2"></i>Bird count changes will affect current cycle bird count
        </li>
        <li data-i18n="note_feed_inventory">
          <i class="bi bi-arrow-right me-2"></i>Feed bag changes will affect available feed inventory
        </li>
      </ul>
    </div>
  </div>
</div>

<!-- Enhanced Mobile UX JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Initialize mobile UX enhancements
  if (window.mobileUX) {
    window.mobileUX.init();
  }

  // Form enhancement
  const form = document.querySelector('.mobile-form-enhanced');
  const submitBtn = form.querySelector('button[type="submit"]');
  
  // Auto-save functionality
  let autoSaveTimeout;
  const formInputs = form.querySelectorAll('input, textarea');
  
  formInputs.forEach(input => {
    input.addEventListener('input', function() {
      clearTimeout(autoSaveTimeout);
      
      // Show saving indicator
      const indicator = document.createElement('small');
      indicator.className = 'text-muted auto-save-indicator';
      indicator.innerHTML = '<i class="bi bi-cloud-arrow-up me-1"></i>Auto-saving...';
      
      // Remove existing indicators
      document.querySelectorAll('.auto-save-indicator').forEach(el => el.remove());
      
      // Add indicator after the input
      this.parentElement.appendChild(indicator);
      
      // Auto-save after 2 seconds of inactivity
      autoSaveTimeout = setTimeout(() => {
        // Save to localStorage as backup
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        localStorage.setItem('edit_daily_backup', JSON.stringify(data));
        
        // Update indicator
        indicator.innerHTML = '<i class="bi bi-check-circle me-1"></i>Auto-saved';
        indicator.className = 'text-success auto-save-indicator';
        
        // Remove indicator after 2 seconds
        setTimeout(() => indicator.remove(), 2000);
      }, 2000);
    });
  });

  // Real-time calculation updates
  const mortalityInput = document.getElementById('mortality');
  const feedConsumedInput = document.getElementById('feed-consumed');
  const feedAddedInput = document.getElementById('feed-added');
  const avgWeightInput = document.getElementById('avg-weight');

  function updateCalculations() {
    // This would typically make an AJAX call to get updated calculations
    // For now, we'll just show a visual feedback
    const calculatedSection = document.querySelector('.mobile-card.bg-light');
    calculatedSection.style.opacity = '0.7';
    calculatedSection.style.transition = 'opacity 0.3s ease';
    
    setTimeout(() => {
      calculatedSection.style.opacity = '1';
    }, 500);
  }

  [mortalityInput, feedConsumedInput, feedAddedInput, avgWeightInput].forEach(input => {
    if (input) {
      input.addEventListener('input', updateCalculations);
    }
  });

  // Enhanced form validation
  form.addEventListener('submit', function(e) {
    let isValid = true;
    
    // Validate mortality
    if (mortalityInput.value < 0) {
      mortalityInput.classList.add('is-invalid');
      isValid = false;
    } else {
      mortalityInput.classList.remove('is-invalid');
    }

    // Validate feed consumed
    if (feedConsumedInput.value < 0) {
      feedConsumedInput.classList.add('is-invalid');
      isValid = false;
    } else {
      feedConsumedInput.classList.remove('is-invalid');
    }

    // Validate average weight
    if (avgWeightInput.value <= 0) {
      avgWeightInput.classList.add('is-invalid');
      isValid = false;
    } else {
      avgWeightInput.classList.remove('is-invalid');
    }

    if (!isValid) {
      e.preventDefault();
      
      // Show error message
      const errorAlert = document.createElement('div');
      errorAlert.className = 'alert alert-danger mt-3';
      errorAlert.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>Please correct the errors above before submitting.';
      
      // Remove existing error alerts
      document.querySelectorAll('.alert-danger').forEach(el => {
        if (el.textContent.includes('Please correct')) el.remove();
      });
      
      form.appendChild(errorAlert);
      
      // Scroll to first error
      const firstError = form.querySelector('.is-invalid');
      if (firstError) {
        firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
        firstError.focus();
      }
    } else {
      // Show loading state
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="bi bi-arrow-repeat me-2 spinner-border spinner-border-sm"></i>Updating...';
      
      // Clear localStorage backup
      localStorage.removeItem('edit_daily_backup');
    }
  });

  // Touch feedback for interactive elements
  document.querySelectorAll('.mobile-metric-card, .mobile-btn-primary, .mobile-btn-outline-secondary').forEach(element => {
    element.addEventListener('touchstart', function() {
      this.style.transform = 'scale(0.98)';
    });
    
    element.addEventListener('touchend', function() {
      this.style.transform = 'scale(1)';
    });
  });

  // Load auto-saved data if available
  const savedData = localStorage.getItem('edit_daily_backup');
  if (savedData) {
    try {
      const data = JSON.parse(savedData);
      formInputs.forEach(input => {
        if (data[input.name] !== undefined) {
          input.value = data[input.name];
        }
      });
    } catch (e) {
      console.log('Error loading auto-saved data:', e);
    }
  }
});
</script>
{% endblock %}
