{% extends 'base.html' %}
{% block content %}
<div class="mobile-container">
  <h2 class="mobile-header text-center mb-mobile-3" data-i18n="dashboard_title">üêî Dashboard</h2>
  
  <!-- Super Admin Company Indicator -->
  {{ company_indicator() }}

  {% if cycle %}
  <!-- Mobile-First Dashboard Layout -->
  <div class="mobile-section">
    <h5 class="mobile-header" data-i18n="quick_stats">üìä Quick Stats</h5>
    <div class="row g-2">
      <div class="col-6">
        <div class="mobile-card card text-center">
          <div class="card-body p-mobile-2">
            <small class="text-muted" data-i18n="cycle_start">Cycle Started</small>
            <div class="fw-bold mobile-content" data-date="{{ summary.start_date }}">{{ summary.start_date }}</div>
          </div>
        </div>
      </div>
      <div class="col-6">
        <div class="mobile-card card text-center">
          <div class="card-body p-mobile-2">
            <small class="text-muted" data-i18n="initial_stock">Initial Stock</small>
            <div class="fw-bold mobile-content">{{ summary.start_birds }} <span data-i18n="birds">birds</span></div>
          </div>
        </div>
      </div>
      <div class="col-6">
        <div class="mobile-card card text-center">
          <div class="card-body p-mobile-2">
            <small class="text-muted" data-i18n="survival_rate">Survival Rate</small>
            <div class="fw-bold text-success mobile-content">{{ metrics.survival_rate }}%</div>
          </div>
        </div>
      </div>
      <div class="col-6">
        <div class="mobile-card card text-center">
          <div class="card-body p-mobile-2">
            <small class="text-muted" data-i18n="last_week_mortality">Week Mortality</small>
            <div class="fw-bold text-{{ 'danger' if metrics.last_week_mortality > 50 else 'warning' if metrics.last_week_mortality > 20 else 'success' }} mobile-content">{{ metrics.last_week_mortality }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="mobile-section">
    <h5 class="mobile-header" data-i18n="key_performance">üìà Performance</h5>
    <div class="row g-2">
      <div class="col-6 col-md-3">
        <div class="card text-center">
          <div class="card-body py-2">
            <small class="text-muted" data-i18n="live_birds">Live Birds</small>
            <div class="fw-bold text-primary">{{ summary.current_birds }}</div>
            <div class="text-muted small">{{ metrics.survival_rate }}% <span data-i18n="survival_rate">survival rate</span></div>
          </div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="card text-center">
          <div class="card-body py-2">
            <small class="text-muted" data-i18n="day_of_farm">Days Running</small>
            <div class="fw-bold text-success">{{ summary.days }}</div>
            <div class="text-muted small">{{ metrics.days_to_target }} <span data-i18n="days_to_target">days to target</span></div>
          </div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="card text-center">
          <div class="card-body py-2">
            <small class="text-muted" data-i18n="fcr_today">FCR Today</small>
            <div class="fw-bold text-info">{{ summary.avg_fcr }}</div>
          </div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="card text-center">
          <div class="card-body py-2">
            <small class="text-muted" data-i18n="mortality_total">Total Mortality</small>
            <div class="fw-bold text-danger">{{ summary.mortality_total }}</div>
            <div class="text-muted small">{{ metrics.avg_mortality_per_day }}/<span data-i18n="day">day</span> <span data-i18n="avg">avg</span></div>
          </div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="card text-center">
          <div class="card-body py-2">
            <small class="text-muted" data-i18n="avg_weight">Avg Weight</small>
            <div class="fw-bold text-info">{{ summary.avg_weight }} <span data-i18n="kg">kg</span></div>
            <div class="text-muted small" data-i18n="today">Today:</div> {{ metrics.today_avg_weight }}<span data-i18n="kg">kg</span>
          </div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="card text-center">
          <div class="card-body py-2">
            <small class="text-muted" data-i18n="mortality_rate">Mortality Rate</small>
            <div class="fw-bold text-danger">{{ (summary.mortality_total / summary.start_birds * 100) | round(2) }}%</div>
            <div class="text-muted small">{{ metrics.survival_rate }}% <span data-i18n="survival_rate">survival rate</span></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-12">
    <h4 class="fw-bold text-success mt-2 mb-2" data-i18n="feed_management">Feed Management</h4>
    <div class="row g-3">
      <div class="col-6 col-md-4">
        <div class="card text-center">
          <div class="card-body py-2">
            <small class="text-muted" data-i18n="bags_available">Bags Available</small>
            <div class="fw-bold text-warning">{{ (summary.bags_available)-( summary.feed_bags_consumed_total ) }}</div>
          </div>
        </div>
      </div>
      <div class="col-6 col-md-4">
        <div class="card text-center">
          <div class="card-body py-2">
            <small class="text-muted" data-i18n="bags_consumed_total">Bags Consumed</small>
            <div class="fw-bold text-primary">{{ summary.feed_bags_consumed_total }}</div>
          </div>
        </div>
      </div>
      <div class="col-6 col-md-4">
        <div class="card text-center">
          <div class="card-body py-2">
            <small class="text-muted" data-i18n="total_feed_cost">Feed Cost</small>
            <div class="fw-bold text-success">‚Çπ{{ "{:,.0f}".format(metrics.total_feed_cost) }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-12">
    <h4 class="fw-bold text-warning mt-2 mb-2" data-i18n="todays_summary">Today's Summary</h4>
    <div class="row g-3">
      <div class="col-6 col-md-4">
        <div class="card text-center">
          <div class="card-body py-2">
            <small class="text-muted" data-i18n="today_mortality">Today's Mortality</small>
            <div class="fw-bold text-danger">{{ metrics.today_mortality }}</div>
          </div>
        </div>
      </div>
      <div class="col-6 col-md-4">
        <div class="card text-center">
          <div class="card-body py-2">
            <small class="text-muted" data-i18n="today_feed_consumed">Feed Today</small>
            <div class="fw-bold text-primary">{{ metrics.today_feed_consumed }}</div>
          </div>
        </div>
      </div>
      <div class="col-6 col-md-4">
        <div class="card text-center">
          <div class="card-body py-2">
            <small class="text-muted" data-i18n="week_avg_fcr">Week FCR</small>
            <div class="fw-bold text-success">{{ metrics.last_week_avg_fcr }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Right Side - Bar Graphs -->
  <div class="col-12">
     <h4 class="fw-bold text-danger mt-2 mb-2" data-i18n="graphs">Graphs</h4>
     <div class="d-flex align-items-center mb-3">
       <label class="form-check-label me-2" for="graphTypeSwitch">Bar</label>
       <div class="form-check form-switch">
         <input class="form-check-input" type="checkbox" id="graphTypeSwitch" checked>
         <label class="form-check-label" for="graphTypeSwitch">Line</label>
       </div>
     </div>
     <div class="row g-3">
       <div class="col-12 col-md-6">
         <div class="card h-100">
           <div class="card-header text-center" data-i18n="fcr_graph">FCR Graph</div>
           <div class="card-body"><canvas id="fcrBarChart"></canvas></div>
         </div>
       </div>
       <div class="col-12 col-md-6">
         <div class="card h-100">
           <div class="card-header text-center" data-i18n="mortality_graph">Mortality Graph</div>
           <div class="card-body"><canvas id="mortalityBarChart"></canvas></div>
         </div>
       </div>
       <div class="col-12 col-md-6">
         <div class="card h-100">
           <div class="card-header text-center" data-i18n="feed_bags_consumed_graph">Feed Bags Consumed</div>
           <div class="card-body"><canvas id="feedBarChart"></canvas></div>
         </div>
       </div>
       <div class="col-12 col-md-6">
         <div class="card h-100">
           <div class="card-header text-center" data-i18n="avg_weight_graph">Avg Weight (g)</div>
           <div class="card-body"><canvas id="weightBarChart"></canvas></div>
         </div>
       </div>
     </div>
   </div>
</div>



{% else %}
<!-- No Active Cycle -->
<div class="row">
  <div class="col-12">
    <div class="card text-center p-5">
      <div class="card-body">
        <div class="mb-4" style="font-size: 4rem;">üêî</div>
        <h3 data-i18n="no_cycle">No Active Cycle</h3>
        <p class="text-muted mb-4" data-i18n="setup_instruction">Please set up a new cycle to start tracking your poultry farm data.</p>
        <a href="{{ url_for('setup') }}" class="btn btn-primary btn-lg" data-i18n="setup_new_cycle">Setup New Cycle</a>
      </div>
    </div>
  </div>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
{% if cycle %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script>
  const fcrSeries = {{ fcr_series|tojson }};
  const dates = {{ dates|tojson }};
  const mortalitySeries = {{ mortality_series|tojson }};
  const feedBagsSeries = {{ feedbags_series|tojson }};
  const weightSeries = {{ weight_series|tojson }};

  // Format dates to dd-mm-yyyy
  const formattedDates = dates.map(date => formatDateToDDMMYYYY(date));

  let chartType = 'bar';
  let fcrChart, mortalityChart, feedChart, weightChart;

  function renderCharts(type) {
    if (fcrChart) fcrChart.destroy();
    if (mortalityChart) mortalityChart.destroy();
    if (feedChart) feedChart.destroy();
    if (weightChart) weightChart.destroy();

    fcrChart = new Chart(document.getElementById('fcrBarChart'), {
      type: type,
      data: {
        labels: formattedDates,
        datasets: [{
          label: 'FCR',
          data: fcrSeries,
          backgroundColor: '#0d6efd',
          borderColor: '#0d6efd',
          borderWidth: 1,
          fill: false
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          datalabels: {
            anchor: 'end',
            align: 'top',
            color: '#333',
            font: { weight: 'bold' },
            formatter: function(value) { return value; }
          }
        },
        scales: { x: { title: { display: true, text: 'Date' } }, y: { title: { display: true, text: 'FCR' } } }
      },
      plugins: [ChartDataLabels]
    });

    mortalityChart = new Chart(document.getElementById('mortalityBarChart'), {
      type: type,
      data: {
        labels: formattedDates,
        datasets: [{
          label: 'Mortality',
          data: mortalitySeries,
          backgroundColor: '#dc3545',
          borderColor: '#dc3545',
          borderWidth: 1,
          fill: false
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          datalabels: {
            anchor: 'end',
            align: 'top',
            color: '#333',
            font: { weight: 'bold' },
            formatter: function(value) { return value; }
          }
        },
        scales: { x: { title: { display: true, text: 'Date' } }, y: { title: { display: true, text: 'Count' } } }
      },
      plugins: [ChartDataLabels]
    });

    feedChart = new Chart(document.getElementById('feedBarChart'), {
      type: type,
      data: {
        labels: formattedDates,
        datasets: [{
          label: 'Feed Bags',
          data: feedBagsSeries,
          backgroundColor: '#ffc107',
          borderColor: '#ffc107',
          borderWidth: 1,
          fill: false
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          datalabels: {
            anchor: 'end',
            align: 'top',
            color: '#333',
            font: { weight: 'bold' },
            formatter: function(value) { return value; }
          }
        },
        scales: { x: { title: { display: true, text: 'Date' } }, y: { title: { display: true, text: 'Bags' } } }
      },
      plugins: [ChartDataLabels]
    });

    weightChart = new Chart(document.getElementById('weightBarChart'), {
      type: type,
      data: {
        labels: formattedDates,
        datasets: [{
          label: 'Avg Weight (g)',
          data: weightSeries,
          backgroundColor: '#198754',
          borderColor: '#198754',
          borderWidth: 1,
          fill: false
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          datalabels: {
            anchor: 'end',
            align: 'top',
            color: '#333',
            font: { weight: 'bold' },
            formatter: function(value) { return value; }
          }
        },
        scales: { x: { title: { display: true, text: 'Date' } }, y: { title: { display: true, text: 'Weight (g)' } } }
      },
      plugins: [ChartDataLabels]
    });
  }

  document.getElementById('graphTypeSwitch').addEventListener('change', function() {
    chartType = this.checked ? 'line' : 'bar';
    renderCharts(chartType);
  });

  renderCharts(chartType);
</script>
{% endif %}
{% endblock %}

<style>
@media (max-width: 576px) {
  .btn, .btn-sm, .btn-lg {
    font-size: 0.85rem !important;
    padding: 0.3rem 0.7rem !important;
    border-radius: 0.3rem !important;
  }
  .card-header h5, h2, h3, h5, .card-title {
    font-size: 1.1rem !important;
    margin-bottom: 0.5rem !important;
  }
  .card-header {
    padding: 0.5rem 1rem !important;
  }
  .card-body {
    padding: 0.7rem 0.7rem !important;
  }
  .expand-text, .collapse-text {
    font-size: 0.95rem !important;
  }
}
</style>
