{% extends 'base.html' %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h2 data-i18n="cycle_details_title">üìä Cycle Details</h2>
    <p class="text-muted">
      <span data-i18n="cycle_id_label">Cycle ID:</span> #{{ cycle.id }} |
      <span data-i18n="status_label">Status:</span>
      {% if cycle.status == 'active' %}
      <span class="badge bg-success" data-i18n="status_active">Active</span>
      {% else %}
      <span class="badge bg-secondary" data-i18n="status_archived">Archived</span>
      {% endif %}
    </p>
  </div>
  <div>
    <a href="{{ url_for('cycle_history') }}" class="btn btn-outline-secondary" data-i18n="back_to_history">‚Üê Back to History</a>
    {% if cycle.status == 'archived' and session.role == 'admin' %}
    <a href="{{ url_for('export_cycle', cycle_id=cycle.id) }}" class="btn btn-success" data-i18n="export_cycle">üì• Export</a>
    {% endif %}
  </div>
</div>

<!-- Cycle Overview -->
<div class="row mb-4">
  <div class="col-md-8">
    <div class="card">
      <div class="card-header">
        <h5 data-i18n="cycle_overview">üêî Cycle Overview</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <dl class="row">
              <dt class="col-sm-5" data-i18n="start_date">Start Date:</dt>
              <dd class="col-sm-7">{{ cycle.start_date }}</dd>
              <dt class="col-sm-5" data-i18n="start_time">Start Time:</dt>
              <dd class="col-sm-7">{{ cycle.start_time or 'N/A' }}</dd>
              <dt class="col-sm-5" data-i18n="driver">Driver:</dt>
              <dd class="col-sm-7">{{ cycle.driver or 'N/A' }}</dd>
            </dl>
          </div>
          <div class="col-md-6">
            <dl class="row">
              <dt class="col-sm-5" data-i18n="end_date">End Date:</dt>
              <dd class="col-sm-7">{{ cycle.end_date or 'Ongoing' }}</dd>
              <dt class="col-sm-5" data-i18n="duration">Duration:</dt>
              <dd class="col-sm-7">
                {% if cycle.end_date %}
                {{ duration }} days
                {% else %}
                {{ current_duration }} days (ongoing)
                {% endif %}
              </dd>
              <dt class="col-sm-5" data-i18n="notes">Notes:</dt>
              <dd class="col-sm-7">{{ cycle.notes or 'None' }}</dd>
            </dl>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card">
      <div class="card-header">
        <h5 data-i18n="key_metrics">üìä Key Metrics</h5>
      </div>
      <div class="card-body">
        <div class="text-center">
          <h4 class="text-primary">{{ cycle.start_birds }} ‚Üí {{ cycle.current_birds }}</h4>
          <small class="text-muted" data-i18n="birds_start_to_final">Birds (Start ‚Üí Final)</small>
        </div>
        <hr>
        <div class="row text-center">
          <div class="col-6">
            <h5 class="text-success">{{ "%.1f"|format((cycle.current_birds / cycle.start_birds * 100) if cycle.start_birds > 0 else 0) }}%</h5>
            <small class="text-muted" data-i18n="survival_rate">Survival Rate</small>
          </div>
          <div class="col-6">
            <h5 class="text-info">{{ "%.2f"|format(stats.avg_fcr) if stats.avg_fcr > 0 else 'N/A' }}</h5>
            <small class="text-muted" data-i18n="avg_fcr">Avg FCR</small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Performance Charts -->
<div class="row mb-4">
  <div class="col-md-6">
    <div class="card">
      <div class="card-header">
        <h6 data-i18n="fcr_trend_chart">üìà FCR Trend</h6>
      </div>
      <div class="card-body">
        <canvas id="fcrChart" height="200"></canvas>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card">
      <div class="card-header">
        <h6 data-i18n="weight_trend_chart">‚öñÔ∏è Weight Trend</h6>
      </div>
      <div class="card-body">
        <canvas id="weightChart" height="200"></canvas>
      </div>
    </div>
  </div>
</div>



<!-- Daily Entries Table (Desktop) -->
<div class="card d-none d-md-block">
  <div class="card-header">
    <h5 data-i18n="daily_entries_history">üìÖ Daily Entries ({{ daily_entries|length }} entries)</h5>
  </div>
  <div class="card-body">
    {% if daily_entries %}
    <div class="table-responsive">
      <table class="table table-sm table-striped">
        <thead>
        <tr>
          <th data-i18n="table_date">Date</th>
          <th data-i18n="table_mortality">Mortality</th>
          <th data-i18n="table_feed_consumed">Feed Consumed</th>
          <th data-i18n="table_feed_added">Feed Added</th>
          <th data-i18n="table_avg_weight">Avg Weight (kg)</th>
          <th data-i18n="table_fcr">FCR</th>
          <th data-i18n="table_medicines">Medicines</th>
        </tr>
        </thead>
        <tbody>
        {% for entry in daily_entries %}
        <tr>
          <td>{{ entry.entry_date }}</td>
          <td>
            {% if entry.mortality > 0 %}
            <span class="text-danger">{{ entry.mortality }}</span>
            {% else %}
            {{ entry.mortality }}
            {% endif %}
          </td>
          <td>{{ entry.feed_bags_consumed }}</td>
          <td>
            {% if entry.feed_bags_added > 0 %}
            <span class="text-success">+{{ entry.feed_bags_added }}</span>
            {% else %}
            {{ entry.feed_bags_added }}
            {% endif %}
          </td>
          <td>{{ "%.3f"|format(entry.avg_weight) if entry.avg_weight > 0 else 'N/A' }}</td>
          <td>
            {% if entry.fcr > 0 %}
            <span class="{% if entry.fcr <= 1.8 %}text-success{% elif entry.fcr <= 2.2 %}text-warning{% else %}text-danger{% endif %}">
                  {{ "%.3f"|format(entry.fcr) }}
                </span>
            {% else %}
            N/A
            {% endif %}
          </td>
          <td>{{ entry.medicines or '-' }}</td>
        </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="text-muted text-center" data-i18n="no_daily_entries">No daily entries found for this cycle.</p>
    {% endif %}
  </div>
</div>

<!-- Daily Entries Card View (Mobile) -->
<div class="d-block d-md-none">
  {% if daily_entries %}
  {% for entry in daily_entries %}
  <div class="card mb-3 shadow-sm">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <strong class="text-primary">{{ entry.entry_date }}</strong>

      </div>
      <div>
        <span class="text-secondary" data-i18n="table_mortality">Mortality:</span>
        <span class="fw-bold text-danger">{{ entry.mortality }}</span><br>
        <span class="text-secondary" data-i18n="table_feed_consumed">Feed Consumed:</span>
        <span class="fw-bold text-info">{{ entry.feed_bags_consumed }}</span><br>
        <span class="text-secondary" data-i18n="table_feed_added">Feed Added:</span>
        {% if entry.feed_bags_added > 0 %}
        <span class="fw-bold text-success">+{{ entry.feed_bags_added }}</span>
        {% else %}
        <span class="fw-bold text-dark">{{ entry.feed_bags_added }}</span>
        {% endif %}<br>
        <span class="text-secondary" data-i18n="table_avg_weight">Avg Weight:</span>
        <span class="fw-bold text-warning">{{ "%.3f"|format(entry.avg_weight) if entry.avg_weight > 0 else 'N/A' }} kg</span><br>
        <span class="text-secondary" data-i18n="table_fcr">FCR:</span>
        {% if entry.fcr > 0 %}
        <span class="fw-bold {% if entry.fcr <= 1.8 %}text-success{% elif entry.fcr <= 2.2 %}text-warning{% else %}text-danger{% endif %}">
                {{ "%.3f"|format(entry.fcr) }}
              </span>
        {% else %}
        <span class="fw-bold text-dark">N/A</span>
        {% endif %}<br>
        <span class="text-secondary" data-i18n="table_medicines">Medicines:</span>
        <span class="fw-bold text-primary">{{ entry.medicines or '-' }}</span>
      </div>
    </div>
  </div>
  {% endfor %}
  {% else %}
  <div class="card mb-3">
    <div class="card-body text-center text-muted" data-i18n="no_daily_entries">
      No daily entries found for this cycle.
    </div>
  </div>
  {% endif %}
</div>
{% endblock %}


{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // FCR Chart
  const fcrSeries = {{ fcr_series|tojson | safe }};
  const dates = {{ dates|tojson | safe }};
  const fcrCtx = document.getElementById('fcrChart').getContext('2d');
  new Chart(fcrCtx, {
    type: 'line',
    data: {
      labels: dates,
      datasets: [{
        label: 'FCR',
        data: fcrSeries,
        tension: 0.2,
        borderWidth: 2,
        borderColor: '#1877f2',
        backgroundColor: 'rgba(24, 119, 242, 0.1)',
        fill: true
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'FCR Value'
          }
        }
      }
    }
  });

  // Weight Chart
  const weightSeries = {{ weight_series|tojson }};
  const weightCtx = document.getElementById('weightChart').getContext('2d');
  new Chart(weightCtx, {
    type: 'line',
    data: {
      labels: dates,
      datasets: [{
        label: 'Weight (kg)',
        data: weightSeries,
        tension: 0.2,
        borderWidth: 2,
        borderColor: '#28a745',
        backgroundColor: 'rgba(40, 167, 69, 0.1)',
        fill: true
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Weight (kg)'
          }
        }
      }
    }
  });
</script>
{% endblock %}
