{% extends "base.html" %}
{% block title %}{% endblock %}

{% block content %}
<div class="container">
    <h1 class="page-title" data-i18n="users_title">User Management</h1>

    <!-- Create New User Form -->
    <div class="card">
        <div class="card-header">
            <h3 data-i18n="create_new_user">Create New User</h3>
        </div>
        <div class="card-body">
            <form method="POST">
                <input name="action" type="hidden" value="create">
                <div class="form-row">
                    <div class="form-group col-md-4">
                        <label data-i18n="username" for="username">Username:</label>
                        <input class="form-control" name="username" required type="text">
                    </div>
                    <div class="form-group col-md-4">
                        <label data-i18n="password" for="password">Password:</label>
                        <input class="form-control" name="password" required type="password">
                    </div>
                    <div class="form-group col-md-4">
                        <label data-i18n="role" for="role">Role:</label>
                        <select class="form-control" name="role">
                            <option data-i18n="user_role" value="user">User</option>
                            <option data-i18n="admin_role" value="admin">Admin</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-primary" data-i18n="create_user" type="submit">Create User</button>
            </form>
        </div>
    </div>

    <!-- Existing Users List -->
    <div class="card mt-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h3 data-i18n="existing_users">Existing Users</h3>
            <button class="btn btn-sm btn-outline-primary expand-btn" type="button" data-bs-toggle="collapse" data-bs-target="#usersTableCollapse" aria-expanded="true">
            </button>
        </div>
        <div class="collapse show" id="usersTableCollapse">
          <div class="card-body">
            {% if users %}
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                    <tr>
                        <th data-i18n="username">Username</th>
                        <th data-i18n="role">Role</th>
                        <th data-i18n="actions">Actions</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for user in users %}
                    <tr>
                        <td>
                            <strong>{{ user.username }}</strong>
                            {% if user.id == session.user_id %}
                            <span class="badge badge-primary" data-i18n="you">You</span>
                            {% endif %}
                        </td>
                        <td>
                                <span class="badge {% if user.role == 'admin' %}badge-success{% else %}badge-secondary{% endif %}">
                                    {% if user.role == 'admin' %}
                                        <span data-i18n="admin_role">Admin</span>
                                    {% else %}
                                        <span data-i18n="user_role">User</span>
                                    {% endif %}
                                </span>
                        </td>
                        <td>
                            <!-- Edit Button -->
                            <button class="btn btn-sm btn-warning" data-bs-target="#editModal{{ user.id }}" data-bs-toggle="modal"
                                    data-i18n="edit" type="button">
                                Edit
                            </button>

                            <!-- Delete Button -->
                            {% if user.id != session.user_id %}
                            <form action="{{ url_for('delete_user', user_id=user.id) }}" method="POST"
                                  onsubmit="return confirm(getTranslation('confirm_delete_user') || 'Are you sure you want to delete this user?')"
                                  style="display: inline;">
                                <button class="btn btn-sm btn-danger" data-i18n="delete" type="submit">Delete</button>
                            </form>
                            {% endif %}
                        </td>
                    </tr>

                    <!-- Edit User Modal -->
                    <div class="modal fade" id="editModal{{ user.id }}" role="dialog" tabindex="-1">
                        <div class="modal-dialog" role="document">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">
                                        <span data-i18n="edit_user">Edit User</span>: {{ user.username }}
                                    </h5>
                                    <button aria-label="Close" class="btn-close" data-bs-dismiss="modal"
                                            type="button"></button>
                                </div>
                                <form method="POST">
                                    <div class="modal-body">
                                        <input name="action" type="hidden" value="update">
                                        <input name="user_id" type="hidden" value="{{ user.id }}">

                                        <div class="form-group">
                                            <label data-i18n="new_username" for="new_username">New Username:</label>
                                            <input class="form-control" name="new_username" type="text"
                                                   value="{{ user.username }}">
                                            <small class="form-text text-muted" data-i18n="keep_current_username">Leave
                                                blank to keep current username</small>
                                        </div>

                                        <div class="form-group">
                                            <label data-i18n="new_password" for="new_password">New Password:</label>
                                            <input class="form-control" name="new_password" type="password">
                                            <small class="form-text text-muted" data-i18n="keep_current_password">Leave
                                                blank to keep current password</small>
                                        </div>

                                        <div class="form-group">
                                            <label data-i18n="role" for="new_role">Role:</label>
                                            <select class="form-control" name="new_role">
                                                <option value="user" {% if user.role == 'user' %}selected{% endif %} data-i18n="user_role">User</option>
                                                <option value="admin" {% if user.role == 'admin' %}selected{% endif %} data-i18n="admin_role">Admin</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="cancel"
                                                type="button">Cancel
                                        </button>
                                        <button class="btn btn-primary" data-i18n="update_user" type="submit">Update
                                            User
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted">No users found</p>
            {% endif %}
          </div>
        </div>
    </div>

    <!-- Instructions -->
    <div class="alert alert-info mt-4">
        <h5 data-i18n="instructions">Instructions:</h5>
        <ul>
            <li data-i18n="only_admins_manage">Only admins can manage users</li>
            <li data-i18n="cannot_delete_own">You cannot delete your own account</li>
            <li data-i18n="one_admin_required">At least one admin must exist in the system</li>
            <li data-i18n="use_strong_passwords">Use strong passwords for security</li>
        </ul>
    </div>
</div>

<script>
    // Global translation dictionary for dynamic access
    let currentTranslations = {};

    // Function to get translation for dynamic content
    function getTranslation(key) {
        return currentTranslations[key] || key;
    }

    // Override the loadLang function to store translations
    async function loadUserLang(lang){
        try{
            const res = await fetch('/static/i18n/' + lang + '.json');
            if(!res.ok) return;
            const dict = await res.json();
            currentTranslations = dict; // Store for dynamic access

            document.querySelectorAll('[data-i18n]').forEach(el=>{
                const key = el.getAttribute('data-i18n');
                if(dict[key]) el.innerText = dict[key];
            });
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el=>{
                const key = el.getAttribute('data-i18n-placeholder');
                if(dict[key]) el.setAttribute('placeholder', dict[key]);
            });

            // Update select options
            document.querySelectorAll('option[data-i18n]').forEach(el=>{
                const key = el.getAttribute('data-i18n');
                if(dict[key]) el.textContent = dict[key];
            });

        }catch(e){ console.error('Translation loading failed:', e); }
    }

    // Load saved language or default to English
    document.addEventListener('DOMContentLoaded', function() {
        const savedLang = localStorage.getItem('selectedLang') || 'en';
        loadUserLang(savedLang);

        // Listen for language changes from the global language selector
        const langSelect = document.getElementById('langSelect');
        if (langSelect) {
            langSelect.addEventListener('change', (e) => {
                loadUserLang(e.target.value);
            });
        }

        // Handle form validation
        const forms = document.querySelectorAll('form');
        forms.forEach(form => {
            form.addEventListener('submit', function(e) {
                const action = form.querySelector('input[name="action"]');
                if (action && action.value === 'create') {
                    const username = form.querySelector('input[name="username"]');
                    const password = form.querySelector('input[name="password"]');

                    if (!username.value.trim() || !password.value.trim()) {
                        e.preventDefault();
                        alert(getTranslation('username_password_required') || 'Username and password are required');
                        return false;
                    }
                }
            });
        });
    });
</script>

<style>
    .card {
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        padding: 1rem;
    }

    .card-header h3 {
        margin: 0;
        color: #495057;
    }

    .badge {
        font-size: 0.75em;
        font-weight: 500;
    }

    .badge-primary {
        background-color: #007bff !important;
        color: white !important;
    }

    .badge-success {
        background-color: #28a745 !important;
        color: white !important;
    }

    .badge-secondary {
        background-color: #6c757d !important;
        color: white !important;
    }

    .table th {
        background-color: #f8f9fa;
        color: #495057;
        font-weight: 600;
    }

    .table td {
        color: #212529;
        vertical-align: middle;
    }

    .table td strong {
        color: #007bff;
        font-weight: 600;
    }

    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
        margin-right: 0.25rem;
    }

    .modal-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
    }

    .modal-header .btn-close {
        padding: 0.5rem;
        margin: -0.5rem -0.5rem -0.5rem auto;
    }

    .modal-title {
        margin-bottom: 0;
        line-height: 1.5;
    }

    .alert-info {
        background-color: #d1ecf1;
        border-color: #bee5eb;
        color: #0c5460;
    }

    .form-row {
        display: flex;
        flex-wrap: wrap;
        margin-right: -5px;
        margin-left: -5px;
    }

    .form-row > .col-md-4 {
        padding-right: 5px;
        padding-left: 5px;
        flex: 0 0 33.333333%;
        max-width: 33.333333%;
    }

    @media (max-width: 768px) {
        .form-row > .col-md-4 {
            flex: 0 0 100%;
            max-width: 100%;
            margin-bottom: 1rem;
        }
    }

    @media (max-width: 576px) {
      .btn, .btn-sm, .btn-lg {
        font-size: 0.85rem !important;
        padding: 0.3rem 0.7rem !important;
        border-radius: 0.3rem !important;
      }
      .card-header h5, h2, h3, h5, .card-title {
        font-size: 1.1rem !important;
        margin-bottom: 0.5rem !important;
      }
      .card-header {
        padding: 0.5rem 1rem !important;
      }
      .card-body {
        padding: 0.7rem 0.7rem !important;
      }
    }
</style>

<script>
// Simple arrow rotation for expand/collapse
document.addEventListener('DOMContentLoaded', function() {
  const expandButtons = document.querySelectorAll('.expand-btn');
  expandButtons.forEach(button => {
    const targetId = button.getAttribute('data-bs-target');
    const targetElement = document.querySelector(targetId);
    
    if (targetElement) {
      targetElement.addEventListener('shown.bs.collapse', function() {
        button.setAttribute('aria-expanded', 'true');
      });
      
      targetElement.addEventListener('hidden.bs.collapse', function() {
        button.setAttribute('aria-expanded', 'false');
      });
    }
  });
});
</script>
{% endblock %}
